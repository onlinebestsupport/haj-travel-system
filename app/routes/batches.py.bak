from flask import Blueprint, request, jsonify, session
from app.database import get_db
from datetime import datetime

bp = Blueprint('batches', __name__, url_prefix='/api/batches')

@bp.route('', methods=['GET'])
def get_batches():
    """Get all batches"""
    db = get_db()
    cursor = db.cursor()
    cursor.execute('''
        SELECT *, 
               (SELECT COUNT(*) FROM travelers WHERE batch_id = batches.id) as booked_seats
        FROM batches
        ORDER BY created_at DESC
    ''')
    batches = cursor.fetchall()
    db.close()
    return jsonify({'success': True, 'batches': [dict(b) for b in batches]})

@bp.route('/<int:batch_id>', methods=['GET'])
def get_batch(batch_id):
    """Get single batch"""
    db = get_db()
    cursor = db.cursor()
    cursor.execute('''
        SELECT *, 
               (SELECT COUNT(*) FROM travelers WHERE batch_id = batches.id) as booked_seats
        FROM batches WHERE id = ?
    ''', (batch_id,))
    batch = cursor.fetchone()
    db.close()
    
    if batch:
        return jsonify({'success': True, 'batch': dict(batch)})
    return jsonify({'success': False, 'error': 'Batch not found'}), 404

@bp.route('', methods=['POST'])
def create_batch():
    """Create new batch"""
    if 'user_id' not in session:
        return jsonify({'success': False, 'error': 'Unauthorized'}), 401
    
    data = request.json
    
    if not data.get('batch_name'):
        return jsonify({'success': False, 'error': 'Batch name is required'}), 400
    
    db = get_db()
    cursor = db.cursor()
    cursor.execute('''
        INSERT INTO batches (batch_name, total_seats, price, departure_date, return_date, status, description, created_at, updated_at)
        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
    ''', (
        data['batch_name'],
        data.get('total_seats', 150),
        data.get('price'),
        data.get('departure_date'),
        data.get('return_date'),
        data.get('status', 'Open'),
        data.get('description', ''),
        datetime.now().isoformat(),
        datetime.now().isoformat()
    ))
    batch_id = cursor.lastrowid
    db.commit()
    db.close()
    
    return jsonify({'success': True, 'batch_id': batch_id})

@bp.route('/<int:batch_id>', methods=['PUT'])
def update_batch(batch_id):
    """Update batch"""
    if 'user_id' not in session:
        return jsonify({'success': False, 'error': 'Unauthorized'}), 401
    
    data = request.json
    
    db = get_db()
    cursor = db.cursor()
    cursor.execute('''
        UPDATE batches SET
            batch_name = ?, total_seats = ?, price = ?,
            departure_date = ?, return_date = ?, status = ?,
            description = ?, updated_at = ?
        WHERE id = ?
    ''', (
        data['batch_name'],
        data.get('total_seats', 150),
        data.get('price'),
        data.get('departure_date'),
        data.get('return_date'),
        data.get('status', 'Open'),
        data.get('description', ''),
        datetime.now().isoformat(),
        batch_id
    ))
    db.commit()
    db.close()
    
    return jsonify({'success': True, 'message': 'Batch updated successfully'})

@bp.route('/<int:batch_id>', methods=['DELETE'])
def delete_batch(batch_id):
    """Delete batch"""
    if 'user_id' not in session:
        return jsonify({'success': False, 'error': 'Unauthorized'}), 401
    
    db = get_db()
    cursor = db.cursor()
    cursor.execute('DELETE FROM batches WHERE id = ?', (batch_id,))
    db.commit()
    db.close()
    
    return jsonify({'success': True, 'message': 'Batch deleted successfully'})
