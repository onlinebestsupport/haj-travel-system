<div class="action-buttons">
    <button class="action-btn btn-primary" onclick="showReportModal('daily')">
        <i class="fas fa-calendar-day"></i> Daily Report
    </button>
    <button class="action-btn btn-success" onclick="showReportModal('monthly')">
        <i class="fas fa-calendar-alt"></i> Monthly Report
    </button>
    <button class="action-btn btn-warning" onclick="showReportModal('batch')">
        <i class="fas fa-layer-group"></i> Batch Report
    </button>
    <button class="action-btn btn-info" onclick="showReportModal('traveler')">
        <i class="fas fa-users"></i> Traveler Report
    </button>
    <button class="action-btn btn-danger" onclick="showReportModal('payment')">
        <i class="fas fa-credit-card"></i> Payment Report
    </button>
    <button class="action-btn btn-secondary" onclick="showReportModal('custom')">
        <i class="fas fa-sliders-h"></i> Custom Report
    </button>
</div>

<!-- Report Filters Card -->
<div class="dashboard-card">
    <h3><i class="fas fa-filter"></i> Report Filters</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
        <div class="form-group">
            <label>Date Range</label>
            <select id="dateRange" onchange="toggleDateInputs()">
                <option value="today">Today</option>
                <option value="yesterday">Yesterday</option>
                <option value="thisweek">This Week</option>
                <option value="lastweek">Last Week</option>
                <option value="thismonth">This Month</option>
                <option value="lastmonth">Last Month</option>
                <option value="thisyear">This Year</option>
                <option value="custom">Custom Range</option>
            </select>
        </div>
        <div class="form-group" id="startDateGroup" style="display: none;">
            <label>Start Date</label>
            <input type="date" id="startDate">
        </div>
        <div class="form-group" id="endDateGroup" style="display: none;">
            <label>End Date</label>
            <input type="date" id="endDate">
        </div>
        <div class="form-group">
            <label>Batch</label>
            <select id="reportBatch">
                <option value="all">All Batches</option>
            </select>
        </div>
        <div class="form-group">
            <label>Status</label>
            <select id="reportStatus">
                <option value="all">All Status</option>
                <option value="Open">Open</option>
                <option value="Closing Soon">Closing Soon</option>
                <option value="Full">Full</option>
                <option value="Closed">Closed</option>
            </select>
        </div>
    </div>
    <div style="margin-top: 20px;">
        <button class="action-btn btn-primary" onclick="generateReport()">
            <i class="fas fa-chart-bar"></i> Generate Report
        </button>
        <button class="action-btn btn-secondary" onclick="resetFilters()">
            <i class="fas fa-undo"></i> Reset
        </button>
    </div>
</div>

<!-- Report Results -->
<div id="reportResults" style="display: none;">
    <div class="dashboard-card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
            <h3 id="reportTitle"><i class="fas fa-chart-pie"></i> Report Results</h3>
            <div>
                <button class="action-btn btn-success" onclick="exportToPDF()">
                    <i class="fas fa-file-pdf"></i> Export PDF
                </button>
                <button class="action-btn btn-info" onclick="exportToExcel()">
                    <i class="fas fa-file-excel"></i> Export Excel
                </button>
                <button class="action-btn btn-secondary" onclick="printReport()">
                    <i class="fas fa-print"></i> Print
                </button>
            </div>
        </div>
        
        <!-- Summary Cards -->
        <div class="stats-grid" id="reportSummary">
            <!-- Will be populated by JS -->
        </div>
        
        <!-- Charts -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin: 30px 0;">
            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                <canvas id="paymentsChart"></canvas>
            </div>
            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                <canvas id="travelersChart"></canvas>
            </div>
        </div>
        
        <!-- Data Table -->
        <div class="table-container" id="reportTable">
            <!-- Will be populated by JS -->
        </div>
    </div>
</div>

<!-- Report Modal -->
<div id="reportModal" class="modal modal-large" style="display: none;">
    <div class="modal-header">
        <h3 id="modalTitle"><i class="fas fa-chart-bar"></i> Report Options</h3>
        <button class="modal-close" onclick="closeReportModal()">&times;</button>
    </div>
    <div id="modalContent"></div>
    <div class="modal-footer">
        <button class="action-btn btn-primary" onclick="generateCustomReport()">Generate</button>
        <button class="action-btn btn-secondary" onclick="closeReportModal()">Cancel</button>
    </div>
</div>

<!-- Overlay -->
<div id="modalOverlay" class="modal-overlay" onclick="closeReportModal()"></div>

<!-- Include Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
.modal {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 30px;
    border-radius: 15px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    z-index: 2000;
    max-width: 800px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
}

.modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1999;
}

.report-stat {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    padding: 20px;
    border-radius: 10px;
    text-align: center;
}

.report-stat h4 {
    color: rgba(255,255,255,0.9);
    font-size: 0.9rem;
    margin-bottom: 10px;
}

.report-stat .number {
    font-size: 2rem;
    font-weight: bold;
}
</style>

<script>
    let reportsChart = null;
    let currentReportData = null;

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        loadBatchesForReport();
    });

    function toggleDateInputs() {
        const range = document.getElementById('dateRange').value;
        const startGroup = document.getElementById('startDateGroup');
        const endGroup = document.getElementById('endDateGroup');
        
        if (range === 'custom') {
            startGroup.style.display = 'block';
            endGroup.style.display = 'block';
        } else {
            startGroup.style.display = 'none';
            endGroup.style.display = 'none';
        }
    }

    async function loadBatchesForReport() {
        try {
            const response = await fetch('/api/batches/', {
                credentials: 'include'
            });
            if (response.ok) {
                const data = await response.json();
                if (data.success && data.batches) {
                    const select = document.getElementById('reportBatch');
                    select.innerHTML = '<option value="all">All Batches</option>';
                    data.batches.forEach(b => {
                        select.innerHTML += `<option value="${b.id}">${b.batch_name}</option>`;
                    });
                }
            }
        } catch (error) {
            console.error('Error loading batches:', error);
        }
    }

    function showReportModal(type) {
        const modal = document.getElementById('reportModal');
        const title = document.getElementById('modalTitle');
        const content = document.getElementById('modalContent');
        
        title.innerHTML = `<i class="fas fa-chart-bar"></i> ${type.charAt(0).toUpperCase() + type.slice(1)} Report Options`;
        
        let html = '';
        if (type === 'daily') {
            html = `
                <div class="form-group">
                    <label>Select Date</label>
                    <input type="date" id="reportDate" value="${new Date().toISOString().split('T')[0]}">
                </div>
                <div class="form-group">
                    <label>Include</label>
                    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                        <label><input type="checkbox" value="travelers" checked> New Travelers</label>
                        <label><input type="checkbox" value="payments" checked> Payments</label>
                        <label><input type="checkbox" value="bookings" checked> Bookings</label>
                    </div>
                </div>
            `;
        } else if (type === 'monthly') {
            html = `
                <div class="form-group">
                    <label>Select Month</label>
                    <input type="month" id="reportMonth" value="${new Date().toISOString().slice(0,7)}">
                </div>
                <div class="form-group">
                    <label>Report Type</label>
                    <select id="monthlyType">
                        <option value="summary">Summary Report</option>
                        <option value="detailed">Detailed Report</option>
                        <option value="comparison">Month Comparison</option>
                    </select>
                </div>
            `;
        } else if (type === 'batch') {
            html = `
                <div class="form-group">
                    <label>Select Batch</label>
                    <select id="batchReportSelect" style="width: 100%; padding: 12px;">
                        <option value="">Loading batches...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Report Period</label>
                    <select id="batchPeriod">
                        <option value="all">All Time</option>
                        <option value="thisyear">This Year</option>
                        <option value="lastyear">Last Year</option>
                        <option value="custom">Custom Range</option>
                    </select>
                </div>
            `;
            // Load batches
            setTimeout(loadBatchesForModal, 100);
        } else if (type === 'traveler') {
            html = `
                <div class="form-group">
                    <label>Report Type</label>
                    <select id="travelerReportType">
                        <option value="registration">Registration Trend</option>
                        <option value="demographics">Demographics</option>
                        <option value="batches">Batch Distribution</option>
                        <option value="status">Status Distribution</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Date Range</label>
                    <select id="travelerDateRange">
                        <option value="all">All Time</option>
                        <option value="thisyear">This Year</option>
                        <option value="thismonth">This Month</option>
                        <option value="custom">Custom</option>
                    </select>
                </div>
            `;
        } else if (type === 'payment') {
            html = `
                <div class="form-group">
                    <label>Report Type</label>
                    <select id="paymentReportType">
                        <option value="collection">Collection Summary</option>
                        <option value="pending">Pending Payments</option>
                        <option value="method">Payment Methods</option>
                        <option value="installment">Installment Analysis</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Date Range</label>
                    <input type="date" id="paymentStartDate" value="${new Date().toISOString().split('T')[0]}">
                    <input type="date" id="paymentEndDate" value="${new Date().toISOString().split('T')[0]}" style="margin-top: 10px;">
                </div>
            `;
        } else if (type === 'custom') {
            html = `
                <div class="form-group">
                    <label>Report Name</label>
                    <input type="text" id="customReportName" placeholder="Enter report name">
                </div>
                <div class="form-group">
                    <label>Select Fields</label>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                        <label><input type="checkbox" value="travelers" checked> Travelers</label>
                        <label><input type="checkbox" value="batches" checked> Batches</label>
                        <label><input type="checkbox" value="payments" checked> Payments</label>
                        <label><input type="checkbox" value="users" checked> Users</label>
                        <label><input type="checkbox" value="bookings" checked> Bookings</label>
                        <label><input type="checkbox" value="documents" checked> Documents</label>
                    </div>
                </div>
                <div class="form-group">
                    <label>Date Range</label>
                    <input type="date" id="customStartDate">
                    <input type="date" id="customEndDate" style="margin-top: 10px;">
                </div>
            `;
        }
        
        content.innerHTML = html;
        modal.style.display = 'block';
        document.getElementById('modalOverlay').style.display = 'block';
    }

    function loadBatchesForModal() {
        fetch('/api/batches/', { credentials: 'include' })
            .then(res => res.json())
            .then(data => {
                if (data.success && data.batches) {
                    const select = document.getElementById('batchReportSelect');
                    select.innerHTML = '<option value="">Select Batch</option>';
                    data.batches.forEach(b => {
                        select.innerHTML += `<option value="${b.id}">${b.batch_name}</option>`;
                    });
                }
            })
            .catch(err => console.error('Error loading batches:', err));
    }

    function closeReportModal() {
        document.getElementById('reportModal').style.display = 'none';
        document.getElementById('modalOverlay').style.display = 'none';
    }

    async function generateReport() {
        const range = document.getElementById('dateRange').value;
        const batch = document.getElementById('reportBatch').value;
        const status = document.getElementById('reportStatus').value;
        
        let startDate, endDate;
        
        if (range === 'custom') {
            startDate = document.getElementById('startDate').value;
            endDate = document.getElementById('endDate').value;
        } else {
            const dates = getDateRange(range);
            startDate = dates.start;
            endDate = dates.end;
        }
        
        // Show loading
        document.getElementById('reportResults').style.display = 'block';
        document.getElementById('reportTitle').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating Report...';
        
        try {
            // Fetch report data
            const response = await fetch('/api/reports/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({
                    startDate,
                    endDate,
                    batchId: batch,
                    status
                })
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    displayReport(data.report);
                } else {
                    showDemoReport();
                }
            } else {
                showDemoReport();
            }
        } catch (error) {
            console.error('Error generating report:', error);
            showDemoReport();
        }
    }

    function showDemoReport() {
        const reportData = {
            summary: {
                totalTravelers: 156,
                newTravelers: 23,
                totalPayments: 12560000,
                pendingPayments: 2450000,
                totalBatches: 17,
                activeBatches: 8,
                occupancyRate: 78.5
            },
            paymentsByMethod: {
                Cash: 4500000,
                'Bank Transfer': 5200000,
                UPI: 1850000,
                'Credit Card': 1010000
            },
            travelersByBatch: [
                { batch: 'Haj Platinum 2026', count: 45 },
                { batch: 'Haj Gold 2026', count: 82 },
                { batch: 'Haj Silver 2026', count: 120 },
                { batch: 'Umrah Ramadhan', count: 170 },
                { batch: 'Umrah Winter', count: 140 }
            ],
            recentActivity: [
                { date: '2026-02-18', type: 'payment', description: 'Payment received from Ahmed Khan', amount: 85000 },
                { date: '2026-02-17', type: 'traveler', description: 'New traveler registered: Fatima Begum' },
                { date: '2026-02-17', type: 'batch', description: 'Batch Haj Silver 2026 updated' }
            ]
        };
        
        displayReport(reportData);
    }

    function displayReport(data) {
        currentReportData = data;
        
        document.getElementById('reportTitle').innerHTML = '<i class="fas fa-chart-pie"></i> Report Results';
        
        // Display summary cards
        const summaryHtml = `
            <div class="stat-card">
                <i class="fas fa-users"></i>
                <h3>Total Travelers</h3>
                <div class="stat-number">${data.summary.totalTravelers}</div>
                <small>+${data.summary.newTravelers} this period</small>
            </div>
            <div class="stat-card">
                <i class="fas fa-rupee-sign"></i>
                <h3>Total Collections</h3>
                <div class="stat-number">₹${(data.summary.totalPayments / 100000).toFixed(2)}L</div>
                <small>₹${(data.summary.pendingPayments / 100000).toFixed(2)}L pending</small>
            </div>
            <div class="stat-card">
                <i class="fas fa-layer-group"></i>
                <h3>Active Batches</h3>
                <div class="stat-number">${data.summary.activeBatches}</div>
                <small>${data.summary.occupancyRate}% occupancy</small>
            </div>
            <div class="stat-card">
                <i class="fas fa-percent"></i>
                <h3>Collection Rate</h3>
                <div class="stat-number">${Math.round((data.summary.totalPayments - data.summary.pendingPayments) / data.summary.totalPayments * 100)}%</div>
                <small>of total expected</small>
            </div>
        `;
        document.getElementById('reportSummary').innerHTML = summaryHtml;
        
        // Create charts
        createPaymentsChart(data.paymentsByMethod);
        createTravelersChart(data.travelersByBatch);
        
        // Display table
        const tableHtml = `
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Type</th>
                        <th>Description</th>
                        <th>Amount</th>
                    </tr>
                </thead>
                <tbody>
                    ${data.recentActivity.map(item => `
                        <tr>
                            <td>${item.date}</td>
                            <td><span class="status-badge ${item.type === 'payment' ? 'status-active' : 'status-pending'}">${item.type}</span></td>
                            <td>${item.description}</td>
                            <td>${item.amount ? '₹' + item.amount.toLocaleString() : '-'}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
        document.getElementById('reportTable').innerHTML = tableHtml;
    }

    function createPaymentsChart(data) {
        const ctx = document.getElementById('paymentsChart').getContext('2d');
        
        if (reportsChart) {
            reportsChart.destroy();
        }
        
        reportsChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: Object.keys(data),
                datasets: [{
                    data: Object.values(data),
                    backgroundColor: ['#3498db', '#2ecc71', '#f39c12', '#e74c3c', '#9b59b6']
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Payments by Method'
                    }
                }
            }
        });
    }

    function createTravelersChart(data) {
        const ctx = document.getElementById('travelersChart').getContext('2d');
        
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.map(d => d.batch),
                datasets: [{
                    label: 'Number of Travelers',
                    data: data.map(d => d.count),
                    backgroundColor: '#3498db'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Travelers by Batch'
                    }
                }
            }
        });
    }

    function getDateRange(range) {
        const today = new Date();
        const end = new Date(today);
        const start = new Date(today);
        
        switch(range) {
            case 'today':
                start.setHours(0,0,0,0);
                end.setHours(23,59,59,999);
                break;
            case 'yesterday':
                start.setDate(today.getDate() - 1);
                start.setHours(0,0,0,0);
                end.setDate(today.getDate() - 1);
                end.setHours(23,59,59,999);
                break;
            case 'thisweek':
                start.setDate(today.getDate() - today.getDay());
                start.setHours(0,0,0,0);
                break;
            case 'lastweek':
                start.setDate(today.getDate() - today.getDay() - 7);
                end.setDate(today.getDate() - today.getDay() - 1);
                end.setHours(23,59,59,999);
                break;
            case 'thismonth':
                start.setDate(1);
                start.setHours(0,0,0,0);
                break;
            case 'lastmonth':
                start.setMonth(today.getMonth() - 1, 1);
                start.setHours(0,0,0,0);
                end.setMonth(today.getMonth(), 0);
                end.setHours(23,59,59,999);
                break;
            case 'thisyear':
                start.setMonth(0, 1);
                start.setHours(0,0,0,0);
                break;
        }
        
        return {
            start: start.toISOString().split('T')[0],
            end: end.toISOString().split('T')[0]
        };
    }

    function generateCustomReport() {
        closeReportModal();
        generateReport();
    }

    function exportToPDF() {
        if (!currentReportData) return;
        showNotification('PDF export feature coming soon!', 'info');
    }

    function exportToExcel() {
        if (!currentReportData) return;
        showNotification('Excel export feature coming soon!', 'info');
    }

    function printReport() {
        const content = document.getElementById('reportResults').innerHTML;
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <html>
            <head>
                <title>Haj Travel Report</title>
                <style>
                    body { font-family: Arial; padding: 30px; }
                    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                    th { background: #1e3c72; color: white; padding: 12px; }
                    td { padding: 10px; border: 1px solid #ddd; }
                    .stat-card { display: inline-block; width: 200px; margin: 10px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
                </style>
            </head>
            <body>
                <h1>Alhudha Haj Travel - System Report</h1>
                <p>Generated on: ${new Date().toLocaleString()}</p>
                ${content}
            </body>
            </html>
        `);
        printWindow.document.close();
        printWindow.print();
    }

    function resetFilters() {
        document.getElementById('dateRange').value = 'today';
        document.getElementById('reportBatch').value = 'all';
        document.getElementById('reportStatus').value = 'all';
        document.getElementById('startDateGroup').style.display = 'none';
        document.getElementById('endDateGroup').style.display = 'none';
        document.getElementById('reportResults').style.display = 'none';
    }
</script>
