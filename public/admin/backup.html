<div class="action-buttons">
    <button class="action-btn btn-primary" onclick="createBackup()">
        <i class="fas fa-database"></i> Create Backup Now
    </button>
    <button class="action-btn btn-success" onclick="scheduleBackup()">
        <i class="fas fa-clock"></i> Schedule Backup
    </button>
    <button class="action-btn btn-info" onclick="loadBackups()">
        <i class="fas fa-sync-alt"></i> Refresh
    </button>
</div>

<!-- Backup Stats -->
<div class="stats-grid">
    <div class="stat-card">
        <i class="fas fa-database"></i>
        <h3>Total Backups</h3>
        <div class="stat-number" id="totalBackups">0</div>
    </div>
    <div class="stat-card">
        <i class="fas fa-hdd"></i>
        <h3>Total Size</h3>
        <div class="stat-number" id="totalSize">0 MB</div>
    </div>
    <div class="stat-card">
        <i class="fas fa-calendar"></i>
        <h3>Last Backup</h3>
        <div class="stat-number" id="lastBackup">Never</div>
    </div>
    <div class="stat-card">
        <i class="fas fa-shield-alt"></i>
        <h3>Auto Backup</h3>
        <div class="stat-number" id="autoBackupStatus">Disabled</div>
    </div>
</div>

<!-- Schedule Backup Modal -->
<div id="scheduleModal" class="modal" style="display: none;">
    <div class="modal-header">
        <h3><i class="fas fa-clock"></i> Schedule Automatic Backup</h3>
        <button class="modal-close" onclick="closeScheduleModal()">&times;</button>
    </div>
    <form id="scheduleForm">
        <div class="form-group">
            <label>Enable Auto Backup</label>
            <select id="backupEnabled" onchange="toggleScheduleFields()">
                <option value="yes">Yes</option>
                <option value="no">No</option>
            </select>
        </div>
        
        <div id="scheduleFields">
            <div class="form-group">
                <label>Backup Frequency</label>
                <select id="backupFrequency">
                    <option value="hourly">Hourly</option>
                    <option value="daily">Daily</option>
                    <option value="weekly">Weekly</option>
                    <option value="monthly">Monthly</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Time (24h format)</label>
                <input type="time" id="backupTime" value="02:00">
            </div>
            
            <div class="form-group">
                <label>Retain Backups (days)</label>
                <input type="number" id="retainDays" value="30" min="1" max="365">
            </div>
            
            <div class="form-group">
                <label>Backup Type</label>
                <select id="backupType">
                    <option value="full">Full Backup (All Data)</option>
                    <option value="database">Database Only</option>
                    <option value="files">Files Only</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Notification Email</label>
                <input type="email" id="backupEmail" placeholder="admin@alhudha.com">
            </div>
        </div>
        
        <div class="modal-footer">
            <button type="submit" class="action-btn btn-primary">Save Schedule</button>
            <button type="button" class="action-btn btn-secondary" onclick="closeScheduleModal()">Cancel</button>
        </div>
    </form>
</div>

<!-- Restore Modal -->
<div id="restoreModal" class="modal" style="display: none;">
    <div class="modal-header">
        <h3><i class="fas fa-undo-alt"></i> Restore from Backup</h3>
        <button class="modal-close" onclick="closeRestoreModal()">&times;</button>
    </div>
    <div class="form-group">
        <p style="margin-bottom: 20px;">Are you sure you want to restore from this backup?</p>
        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px;" id="restoreDetails"></div>
        <div class="form-group">
            <label><input type="checkbox" id="confirmRestore"> I understand that current data will be overwritten</label>
        </div>
    </div>
    <div class="modal-footer">
        <button onclick="confirmRestore()" class="action-btn btn-warning">Restore</button>
        <button onclick="closeRestoreModal()" class="action-btn btn-secondary">Cancel</button>
    </div>
</div>

<!-- System Health Card -->
<div class="dashboard-card">
    <h3><i class="fas fa-heartbeat"></i> System Health</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
        <div>
            <p style="color: #7f8c8d; margin-bottom: 5px;">Database Status</p>
            <p style="font-weight: 600; color: #27ae60;" id="dbStatus">✓ Connected</p>
        </div>
        <div>
            <p style="color: #7f8c8d; margin-bottom: 5px;">Disk Usage</p>
            <p style="font-weight: 600;" id="diskUsage">-</p>
        </div>
        <div>
            <p style="color: #7f8c8d; margin-bottom: 5px;">Last Check</p>
            <p style="font-weight: 600;" id="lastCheck">-</p>
        </div>
    </div>
</div>

<!-- Backup List -->
<div class="table-container">
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Backup Name</th>
                <th>Date/Time</th>
                <th>Size</th>
                <th>Type</th>
                <th>Includes</th>
                <th>Status</th>
                <th>Created By</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="backupsTable">
            <tr><td colspan="9" class="loading"><i class="fas fa-spinner fa-spin"></i> Loading backups...</td></tr>
        </tbody>
    </table>
</div>

<!-- Overlay -->
<div id="modalOverlay" class="modal-overlay" onclick="closeAllModals()"></div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        loadBackups();
        loadSystemHealth();
        loadBackupStats();
    });

    function toggleScheduleFields() {
        const enabled = document.getElementById('backupEnabled').value;
        const fields = document.getElementById('scheduleFields');
        fields.style.display = enabled === 'yes' ? 'block' : 'none';
    }

    async function createBackup() {
        if (!confirm('Create a new system backup? This may take a few moments.')) return;
        
        const btn = event.target;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
        btn.disabled = true;
        
        try {
            const response = await fetch('/api/admin/backup', {
                method: 'POST',
                credentials: 'include'
            });
            
            if (response.status === 401) {
                showNotification('Session expired. Please login again', 'error');
                setTimeout(() => {
                    window.location.href = '/admin.login.html';
                }, 2000);
                return;
            }
            
            const data = await response.json();
            
            if (data.success) {
                showNotification(`Backup created successfully! (${data.stats.travelers} travelers, ${data.stats.batches} batches)`, 'success');
                loadBackups();
                loadBackupStats();
            } else {
                showNotification('Error: ' + (data.error || 'Could not create backup'), 'error');
            }
        } catch (error) {
            console.error('Error creating backup:', error);
            showNotification('Error creating backup. Using demo mode.', 'warning');
            showDemoBackupCreation();
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    function showDemoBackupCreation() {
        showNotification('Demo: Backup created successfully!', 'success');
        loadDemoBackups();
    }

    async function loadBackups() {
        try {
            const response = await fetch('/api/admin/backups', {
                credentials: 'include'
            });
            if (response.ok) {
                const data = await response.json();
                if (data.success && data.backups) {
                    displayBackups(data.backups);
                } else {
                    loadDemoBackups();
                }
            } else {
                loadDemoBackups();
            }
        } catch (error) {
            console.error('Error loading backups:', error);
            loadDemoBackups();
        }
    }

    function displayBackups(backups) {
        let html = '';
        backups.forEach(backup => {
            const date = new Date(backup.created_at);
            const sizeMB = (backup.size_bytes / 1024 / 1024).toFixed(2);
            
            html += `<tr>
                <td>${backup.id}</td>
                <td><strong>${backup.filename}</strong></td>
                <td>${date.toLocaleString()}</td>
                <td>${sizeMB} MB</td>
                <td>${backup.type || 'Full'}</td>
                <td>${backup.traveler_count || 0} travelers, ${backup.batch_count || 0} batches</td>
                <td><span class="status-badge ${backup.status === 'Success' ? 'status-active' : 'status-inactive'}">${backup.status}</span></td>
                <td>${backup.created_by_username || 'System'}</td>
                <td>
                    <button class="icon-btn" onclick="downloadBackup('${backup.filename}')" title="Download"><i class="fas fa-download"></i></button>
                    <button class="icon-btn" onclick="showRestoreModal('${backup.filename}', ${backup.id})" title="Restore"><i class="fas fa-undo-alt"></i></button>
                    <button class="icon-btn" onclick="deleteBackup(${backup.id})" title="Delete"><i class="fas fa-trash"></i></button>
                </td>
            </tr>`;
        });
        document.getElementById('backupsTable').innerHTML = html;
    }

    function loadDemoBackups() {
        const demoBackups = [
            { id: 1, filename: 'backup_20260218_020001.zip', created_at: '2026-02-18T02:00:01Z', size_bytes: 15728640, status: 'Success', traveler_count: 156, batch_count: 17, created_by_username: 'System' },
            { id: 2, filename: 'backup_20260217_020002.zip', created_at: '2026-02-17T02:00:02Z', size_bytes: 15518924, status: 'Success', traveler_count: 152, batch_count: 17, created_by_username: 'System' },
            { id: 3, filename: 'backup_20260216_020003.zip', created_at: '2026-02-16T02:00:03Z', size_bytes: 15204352, status: 'Success', traveler_count: 148, batch_count: 17, created_by_username: 'admin' },
            { id: 4, filename: 'backup_20260215_020004.zip', created_at: '2026-02-15T02:00:04Z', size_bytes: 14876672, status: 'Success', traveler_count: 145, batch_count: 17, created_by_username: 'admin' }
        ];
        displayBackups(demoBackups);
        
        // Update stats with demo data
        document.getElementById('totalBackups').textContent = demoBackups.length;
        const totalSize = demoBackups.reduce((sum, b) => sum + b.size_bytes, 0) / (1024 * 1024);
        document.getElementById('totalSize').innerHTML = totalSize.toFixed(2) + ' MB';
        document.getElementById('lastBackup').textContent = new Date(demoBackups[0].created_at).toLocaleString();
    }

    function loadBackupStats() {
        // This would come from API, using demo for now
        document.getElementById('totalBackups').textContent = '24';
        document.getElementById('totalSize').innerHTML = '156.8 MB';
        document.getElementById('lastBackup').textContent = new Date().toLocaleDateString() + ' 02:00 AM';
    }

    function loadSystemHealth() {
        document.getElementById('dbStatus').innerHTML = '<span style="color: #27ae60;">✓ Connected</span>';
        document.getElementById('diskUsage').textContent = '2.3 GB / 10 GB (23%)';
        document.getElementById('lastCheck').textContent = new Date().toLocaleString();
    }

    function downloadBackup(filename) {
        window.open(`/api/backup/download/${filename}`, '_blank');
    }

    function showRestoreModal(filename, id) {
        document.getElementById('restoreDetails').innerHTML = `
            <p><strong>Backup:</strong> ${filename}</p>
            <p><strong>Date:</strong> ${new Date().toLocaleString()}</p>
            <p><strong>Warning:</strong> This will replace all current data!</p>
        `;
        document.getElementById('restoreModal').dataset.filename = filename;
        document.getElementById('restoreModal').dataset.id = id;
        document.getElementById('restoreModal').style.display = 'block';
        document.getElementById('modalOverlay').style.display = 'block';
    }

    function closeRestoreModal() {
        document.getElementById('restoreModal').style.display = 'none';
        document.getElementById('modalOverlay').style.display = 'none';
        document.getElementById('confirmRestore').checked = false;
    }

    async function confirmRestore() {
        if (!document.getElementById('confirmRestore').checked) {
            showNotification('Please confirm that you understand the consequences', 'error');
            return;
        }
        
        const filename = document.getElementById('restoreModal').dataset.filename;
        const id = document.getElementById('restoreModal').dataset.id;
        
        if (!confirm('⚠️ FINAL WARNING: This will overwrite ALL current data. This action cannot be undone. Continue?')) return;
        
        showNotification('Restore feature coming soon!', 'info');
        closeRestoreModal();
    }

    async function deleteBackup(id) {
        if (!confirm('Are you sure you want to delete this backup?')) return;
        
        try {
            const response = await fetch(`/api/admin/backups/${id}`, {
                method: 'DELETE',
                credentials: 'include'
            });
            
            if (response.ok) {
                showNotification('Backup deleted successfully', 'success');
                loadBackups();
            } else {
                showNotification('Error deleting backup', 'error');
            }
        } catch (error) {
            console.error('Error deleting backup:', error);
            showNotification('Error deleting backup', 'error');
        }
    }

    function scheduleBackup() {
        document.getElementById('scheduleModal').style.display = 'block';
        document.getElementById('modalOverlay').style.display = 'block';
        toggleScheduleFields();
    }

    function closeScheduleModal() {
        document.getElementById('scheduleModal').style.display = 'none';
        document.getElementById('modalOverlay').style.display = 'none';
    }

    document.getElementById('scheduleForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const enabled = document.getElementById('backupEnabled').value;
        
        if (enabled === 'yes') {
            const schedule = {
                frequency: document.getElementById('backupFrequency').value,
                time: document.getElementById('backupTime').value,
                retain_days: document.getElementById('retainDays').value,
                type: document.getElementById('backupType').value,
                email: document.getElementById('backupEmail').value
            };
            
            // Save schedule (would be sent to API)
            showNotification('Backup schedule saved successfully!', 'success');
        } else {
            showNotification('Auto backup disabled', 'info');
        }
        
        closeScheduleModal();
    });

    function closeAllModals() {
        document.getElementById('scheduleModal').style.display = 'none';
        document.getElementById('restoreModal').style.display = 'none';
        document.getElementById('modalOverlay').style.display = 'none';
    }
</script>
