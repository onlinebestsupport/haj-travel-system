<div class="action-buttons">
    <button class="action-btn btn-success" onclick="saveWhatsAppConfig()">
        <i class="fas fa-save"></i> Save Configuration
    </button>
    <button class="action-btn btn-primary" onclick="testWhatsApp()">
        <i class="fab fa-whatsapp"></i> Test Connection
    </button>
    <button class="action-btn btn-info" onclick="loadWhatsAppConfig()">
        <i class="fas fa-sync-alt"></i> Refresh
    </button>
</div>

<!-- WhatsApp Status Card -->
<div class="dashboard-card">
    <h3><i class="fab fa-whatsapp"></i> WhatsApp Business API Status</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
        <div>
            <p style="color: #7f8c8d; margin-bottom: 5px;">Connection Status</p>
            <p style="font-weight: 600; color: #27ae60;" id="whatsappStatus">✓ Connected</p>
        </div>
        <div>
            <p style="color: #7f8c8d; margin-bottom: 5px;">Phone Number</p>
            <p style="font-weight: 600;" id="whatsappNumber">+91 98765 43210</p>
        </div>
        <div>
            <p style="color: #7f8c8d; margin-bottom: 5px;">Messages Today</p>
            <p style="font-weight: 600;" id="messagesToday">156 / 1000</p>
        </div>
        <div>
            <p style="color: #7f8c8d; margin-bottom: 5px;">Last Message</p>
            <p style="font-weight: 600;" id="lastMessage">2 min ago</p>
        </div>
    </div>
</div>

<!-- Main Configuration Tabs -->
<div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #ecf0f1; padding-bottom: 10px;">
    <button class="tab-btn active" onclick="showConfigTab('api')">API Settings</button>
    <button class="tab-btn" onclick="showConfigTab('templates')">Message Templates</button>
    <button class="tab-btn" onclick="showConfigTab('auto')">Auto Replies</button>
    <button class="tab-btn" onclick="showConfigTab('notifications')">Notifications</button>
    <button class="tab-btn" onclick="showConfigTab('logs')">Message Logs</button>
</div>

<!-- API Settings Tab -->
<div id="apiTab" class="config-tab">
    <div class="dashboard-card">
        <h3><i class="fas fa-key"></i> WhatsApp Business API Credentials</h3>
        <div class="form-grid">
            <div class="form-group">
                <label>API Provider</label>
                <select id="apiProvider" onchange="toggleApiFields()">
                    <option value="twilio">Twilio WhatsApp API</option>
                    <option value="gupshup">Gupshup</option>
                    <option value="interakt">Interakt</option>
                    <option value="custom">Custom API</option>
                </select>
            </div>
            <div class="form-group">
                <label>Account SID / API Key</label>
                <input type="text" id="apiKey" placeholder="Enter API Key" class="form-control">
            </div>
            <div class="form-group">
                <label>Auth Token / API Secret</label>
                <input type="password" id="apiSecret" placeholder="Enter Auth Token" class="form-control">
            </div>
            <div class="form-group">
                <label>WhatsApp Business Phone Number</label>
                <input type="text" id="whatsappPhone" value="+919876543210" placeholder="+919876543210" class="form-control">
            </div>
            <div class="form-group">
                <label>Business Account ID</label>
                <input type="text" id="businessId" value="123456789" class="form-control">
            </div>
            <div class="form-group full-width" id="customUrlField" style="display: none;">
                <label>Custom API Endpoint</label>
                <input type="url" id="customApiUrl" placeholder="https://api.yourprovider.com/v1/messages" class="form-control">
            </div>
        </div>
    </div>

    <div class="dashboard-card">
        <h3><i class="fas fa-sliders-h"></i> API Settings</h3>
        <div class="form-grid">
            <div class="form-group">
                <label>API Version</label>
                <select id="apiVersion">
                    <option value="v1">v1</option>
                    <option value="v2" selected>v2</option>
                    <option value="v3">v3</option>
                </select>
            </div>
            <div class="form-group">
                <label>Timeout (seconds)</label>
                <input type="number" id="apiTimeout" value="30" min="5" max="120" class="form-control">
            </div>
            <div class="form-group">
                <label>Retry Attempts</label>
                <input type="number" id="apiRetries" value="3" min="0" max="10" class="form-control">
            </div>
            <div class="form-group">
                <label>Rate Limit (messages/minute)</label>
                <input type="number" id="rateLimit" value="60" min="1" max="1000" class="form-control">
            </div>
        </div>
    </div>

    <div class="dashboard-card">
        <h3><i class="fas fa-webhook"></i> Webhook Configuration</h3>
        <div class="form-grid">
            <div class="form-group full-width">
                <label>Webhook URL</label>
                <input type="url" id="webhookUrl" value="https://alhudhahajportal.up.railway.app/api/whatsapp/webhook" readonly class="form-control" style="background: #f0f0f0;">
            </div>
            <div class="form-group">
                <label>Verify Token</label>
                <input type="text" id="verifyToken" value="alhudha_webhook_2026" class="form-control">
            </div>
            <div class="form-group">
                <label><input type="checkbox" id="webhookEnabled" checked> Enable Webhook</label>
            </div>
        </div>
        <button class="action-btn btn-secondary" onclick="copyWebhookUrl()">
            <i class="fas fa-copy"></i> Copy Webhook URL
        </button>
    </div>
</div>

<!-- Message Templates Tab -->
<div id="templatesTab" class="config-tab" style="display: none;">
    <div class="action-buttons">
        <button class="action-btn btn-success" onclick="showTemplateModal()">
            <i class="fas fa-plus"></i> Create New Template
        </button>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Template Name</th>
                    <th>Category</th>
                    <th>Language</th>
                    <th>Status</th>
                    <th>Last Used</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="templatesTable">
                <tr><td colspan="7" class="loading"><i class="fas fa-spinner fa-spin"></i> Loading templates...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Auto Replies Tab -->
<div id="autoTab" class="config-tab" style="display: none;">
    <div class="action-buttons">
        <button class="action-btn btn-success" onclick="showAutoReplyModal()">
            <i class="fas fa-plus"></i> Add Auto Reply
        </button>
        <button class="action-btn btn-warning" onclick="toggleAutoReply()">
            <i class="fas fa-power-off"></i> Enable Auto Replies
        </button>
    </div>

    <div class="dashboard-card">
        <h3><i class="fas fa-robot"></i> Auto Reply Rules</h3>
        <div id="autoRepliesContainer">
            <!-- Auto replies will be loaded here -->
        </div>
    </div>
</div>

<!-- Notifications Tab -->
<div id="notificationsTab" class="config-tab" style="display: none;">
    <div class="dashboard-card">
        <h3><i class="fas fa-bell"></i> WhatsApp Notifications</h3>
        <div class="form-grid">
            <div class="form-group">
                <label><input type="checkbox" id="notifyNewTraveler" checked> New Traveler Registration</label>
            </div>
            <div class="form-group">
                <label><input type="checkbox" id="notifyPayment" checked> Payment Received</label>
            </div>
            <div class="form-group">
                <label><input type="checkbox" id="notifyBooking" checked> New Booking</label>
            </div>
            <div class="form-group">
                <label><input type="checkbox" id="notifyDocument" checked> Document Upload</label>
            </div>
            <div class="form-group">
                <label><input type="checkbox" id="notifyReminder" checked> Payment Reminders</label>
            </div>
            <div class="form-group">
                <label><input type="checkbox" id="notifyBirthday"> Birthday Wishes</label>
            </div>
        </div>
    </div>

    <div class="dashboard-card">
        <h3><i class="fas fa-clock"></i> Reminder Schedule</h3>
        <div class="form-grid">
            <div class="form-group">
                <label>Payment Reminder Days Before</label>
                <select id="reminderDays">
                    <option value="1">1 day before</option>
                    <option value="3" selected>3 days before</option>
                    <option value="7">7 days before</option>
                    <option value="14">14 days before</option>
                </select>
            </div>
            <div class="form-group">
                <label>Reminder Time</label>
                <input type="time" id="reminderTime" value="10:00">
            </div>
            <div class="form-group">
                <label>Max Reminders</label>
                <input type="number" id="maxReminders" value="3" min="1" max="10">
            </div>
        </div>
    </div>
</div>

<!-- Message Logs Tab -->
<div id="logsTab" class="config-tab" style="display: none;">
    <div class="action-buttons">
        <button class="action-btn btn-info" onclick="refreshLogs()">
            <i class="fas fa-sync-alt"></i> Refresh
        </button>
        <button class="action-btn btn-secondary" onclick="exportLogs()">
            <i class="fas fa-download"></i> Export Logs
        </button>
        <button class="action-btn btn-danger" onclick="clearLogs()">
            <i class="fas fa-trash"></i> Clear Logs
        </button>
    </div>

    <div class="stats-grid" style="margin-bottom: 20px;">
        <div class="stat-card">
            <i class="fas fa-check-circle" style="color: #27ae60;"></i>
            <h3>Delivered</h3>
            <div class="stat-number" id="deliveredCount">1,234</div>
        </div>
        <div class="stat-card">
            <i class="fas fa-clock" style="color: #f39c12;"></i>
            <h3>Pending</h3>
            <div class="stat-number" id="pendingCount">23</div>
        </div>
        <div class="stat-card">
            <i class="fas fa-exclamation-circle" style="color: #e74c3c;"></i>
            <h3>Failed</h3>
            <div class="stat-number" id="failedCount">12</div>
        </div>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Time</th>
                    <th>To</th>
                    <th>Message</th>
                    <th>Type</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="logsTable">
                <tr><td colspan="6" class="loading"><i class="fas fa-spinner fa-spin"></i> Loading logs...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Template Modal -->
<div id="templateModal" class="modal modal-large" style="display: none;">
    <div class="modal-header">
        <h3><i class="fas fa-file-alt"></i> Create Message Template</h3>
        <button class="modal-close" onclick="closeTemplateModal()">&times;</button>
    </div>
    <form id="templateForm">
        <div class="form-grid">
            <div class="form-group">
                <label>Template Name *</label>
                <input type="text" id="templateName" required placeholder="e.g., welcome_message">
            </div>
            <div class="form-group">
                <label>Category</label>
                <select id="templateCategory">
                    <option value="marketing">Marketing</option>
                    <option value="utility">Utility</option>
                    <option value="authentication">Authentication</option>
                    <option value="transactional">Transactional</option>
                </select>
            </div>
            <div class="form-group">
                <label>Language</label>
                <select id="templateLanguage">
                    <option value="en">English</option>
                    <option value="hi">Hindi</option>
                    <option value="ur">Urdu</option>
                    <option value="ar">Arabic</option>
                </select>
            </div>
        </div>

        <div class="form-group">
            <label>Message Template *</label>
            <textarea id="templateContent" rows="5" required placeholder="Hello {{1}}, your booking is confirmed. Package: {{2}}, Date: {{3}}"></textarea>
            <small style="color: #7f8c8d;">Use {{1}}, {{2}} etc for variables</small>
        </div>

        <div class="form-group">
            <label>Header (Optional)</label>
            <input type="text" id="templateHeader" placeholder="e.g., Booking Confirmation">
        </div>

        <div class="form-group">
            <label>Footer (Optional)</label>
            <input type="text" id="templateFooter" placeholder="Thank you for choosing Alhudha">
        </div>

        <div class="modal-footer">
            <button type="submit" class="action-btn btn-success">Create Template</button>
            <button type="button" class="action-btn btn-secondary" onclick="closeTemplateModal()">Cancel</button>
        </div>
    </form>
</div>

<!-- Auto Reply Modal -->
<div id="autoReplyModal" class="modal" style="display: none;">
    <div class="modal-header">
        <h3><i class="fas fa-robot"></i> Add Auto Reply</h3>
        <button class="modal-close" onclick="closeAutoReplyModal()">&times;</button>
    </div>
    <form id="autoReplyForm">
        <div class="form-group">
            <label>Trigger Keyword *</label>
            <input type="text" id="triggerKeyword" required placeholder="e.g., HI, HELLO, STATUS">
        </div>
        <div class="form-group">
            <label>Match Type</label>
            <select id="matchType">
                <option value="exact">Exact Match</option>
                <option value="contains">Contains</option>
                <option value="starts">Starts With</option>
                <option value="regex">Regular Expression</option>
            </select>
        </div>
        <div class="form-group">
            <label>Reply Message *</label>
            <textarea id="replyMessage" rows="4" required placeholder="Thank you for contacting Alhudha Haj Travel. How can we help you?"></textarea>
        </div>
        <div class="form-group">
            <label><input type="checkbox" id="useTemplate"> Use Template</label>
        </div>
        <div class="form-group" id="templateSelectGroup" style="display: none;">
            <label>Select Template</label>
            <select id="replyTemplate">
                <option value="">Loading templates...</option>
            </select>
        </div>
        <div class="form-group">
            <label><input type="checkbox" id="attachButtons"> Attach Quick Reply Buttons</label>
        </div>
        <div id="buttonsContainer" style="display: none;">
            <div class="form-group">
                <label>Button 1 Text</label>
                <input type="text" id="button1Text" placeholder="View Packages">
            </div>
            <div class="form-group">
                <label>Button 2 Text</label>
                <input type="text" id="button2Text" placeholder="Contact Support">
            </div>
        </div>
        <div class="modal-footer">
            <button type="submit" class="action-btn btn-success">Add Auto Reply</button>
            <button type="button" class="action-btn btn-secondary" onclick="closeAutoReplyModal()">Cancel</button>
        </div>
    </form>
</div>

<!-- Test Message Modal -->
<div id="testModal" class="modal" style="display: none;">
    <div class="modal-header">
        <h3><i class="fab fa-whatsapp"></i> Send Test Message</h3>
        <button class="modal-close" onclick="closeTestModal()">&times;</button>
    </div>
    <form id="testForm">
        <div class="form-group">
            <label>Phone Number *</label>
            <input type="tel" id="testPhone" placeholder="+919876543210" required>
        </div>
        <div class="form-group">
            <label>Message *</label>
            <textarea id="testMessage" rows="3" required>This is a test message from Alhudha Haj Travel System.</textarea>
        </div>
        <div class="form-group">
            <label><input type="checkbox" id="useTemplate"> Use Template</label>
        </div>
        <div class="form-group" id="testTemplateSelect" style="display: none;">
            <select id="testTemplate">
                <option value="">Loading templates...</option>
            </select>
        </div>
        <div class="modal-footer">
            <button type="submit" class="action-btn btn-primary">Send Test</button>
            <button type="button" class="action-btn btn-secondary" onclick="closeTestModal()">Cancel</button>
        </div>
    </form>
</div>

<!-- Overlay -->
<div id="modalOverlay" class="modal-overlay" onclick="closeAllModals()"></div>

<script>
    let currentTemplateId = null;

    document.addEventListener('DOMContentLoaded', function() {
        loadWhatsAppConfig();
        loadTemplates();
        loadAutoReplies();
        loadLogs();
    });

    function showConfigTab(tab) {
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
        document.querySelectorAll('.config-tab').forEach(t => t.style.display = 'none');
        document.getElementById(tab + 'Tab').style.display = 'block';
    }

    function toggleApiFields() {
        const provider = document.getElementById('apiProvider').value;
        const customField = document.getElementById('customUrlField');
        customField.style.display = provider === 'custom' ? 'block' : 'none';
    }

    function copyWebhookUrl() {
        const url = document.getElementById('webhookUrl');
        url.select();
        document.execCommand('copy');
        showNotification('Webhook URL copied to clipboard!', 'success');
    }

    async function loadWhatsAppConfig() {
        try {
            const response = await fetch('/api/whatsapp/config', {
                credentials: 'include'
            });
            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    applyConfig(data.config);
                } else {
                    loadDemoConfig();
                }
            } else {
                loadDemoConfig();
            }
        } catch (error) {
            console.error('Error loading config:', error);
            loadDemoConfig();
        }
    }

    function loadDemoConfig() {
        document.getElementById('whatsappStatus').innerHTML = '<span style="color: #27ae60;">✓ Connected (Demo)</span>';
        document.getElementById('whatsappNumber').textContent = '+91 98765 43210';
        document.getElementById('messagesToday').textContent = '156 / 1000';
        document.getElementById('lastMessage').textContent = '2 min ago';
        document.getElementById('apiKey').value = 'ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx';
        document.getElementById('apiSecret').value = '••••••••••••••••••••••••••••';
        document.getElementById('verifyToken').value = 'alhudha_webhook_2026';
    }

    function applyConfig(config) {
        document.getElementById('whatsappStatus').innerHTML = `<span style="color: ${config.connected ? '#27ae60' : '#e74c3c'};">${config.connected ? '✓ Connected' : '✗ Disconnected'}</span>`;
        document.getElementById('whatsappNumber').textContent = config.phone || '+91 98765 43210';
        document.getElementById('messagesToday').textContent = `${config.messages_today || 0} / ${config.limit || 1000}`;
        document.getElementById('lastMessage').textContent = config.last_message || 'Never';
        document.getElementById('apiKey').value = config.api_key || '';
        document.getElementById('apiSecret').value = config.api_secret || '';
        document.getElementById('whatsappPhone').value = config.phone || '';
        document.getElementById('businessId').value = config.business_id || '';
        document.getElementById('verifyToken').value = config.verify_token || 'alhudha_webhook_2026';
        document.getElementById('apiProvider').value = config.provider || 'twilio';
        document.getElementById('apiVersion').value = config.api_version || 'v2';
        document.getElementById('apiTimeout').value = config.timeout || 30;
        document.getElementById('apiRetries').value = config.retries || 3;
        document.getElementById('rateLimit').value = config.rate_limit || 60;
        document.getElementById('webhookEnabled').checked = config.webhook_enabled !== false;
        toggleApiFields();
    }

    async function loadTemplates() {
        try {
            const response = await fetch('/api/whatsapp/templates', {
                credentials: 'include'
            });
            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    displayTemplates(data.templates);
                } else {
                    loadDemoTemplates();
                }
            } else {
                loadDemoTemplates();
            }
        } catch (error) {
            console.error('Error loading templates:', error);
            loadDemoTemplates();
        }
    }

    function loadDemoTemplates() {
        const demo = [
            { id: 1, name: 'welcome_message', category: 'utility', language: 'en', status: 'approved', last_used: '2026-02-18' },
            { id: 2, name: 'payment_reminder', category: 'utility', language: 'en', status: 'approved', last_used: '2026-02-17' },
            { id: 3, name: 'booking_confirmation', category: 'transactional', language: 'en', status: 'pending', last_used: 'Never' }
        ];
        displayTemplates(demo);
    }

    function displayTemplates(templates) {
        let html = '';
        templates.forEach(t => {
            html += `<tr>
                <td>${t.id}</td>
                <td><strong>${t.name}</strong></td>
                <td>${t.category}</td>
                <td>${t.language}</td>
                <td><span class="status-badge ${t.status === 'approved' ? 'status-active' : 'status-pending'}">${t.status}</span></td>
                <td>${t.last_used || 'Never'}</td>
                <td>
                    <button class="icon-btn" onclick="editTemplate(${t.id})" title="Edit"><i class="fas fa-edit"></i></button>
                    <button class="icon-btn" onclick="deleteTemplate(${t.id})" title="Delete"><i class="fas fa-trash"></i></button>
                </td>
            </tr>`;
        });
        document.getElementById('templatesTable').innerHTML = html;
    }

    function loadAutoReplies() {
        const container = document.getElementById('autoRepliesContainer');
        container.innerHTML = `
            <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <div><strong>Trigger:</strong> HI, HELLO</div>
                    <div><span class="status-badge status-active">Active</span></div>
                </div>
                <p><strong>Reply:</strong> Welcome to Alhudha Haj Travel! How can we assist you today?</p>
                <div style="margin-top: 10px;">
                    <button class="icon-btn" onclick="editAutoReply(1)"><i class="fas fa-edit"></i></button>
                    <button class="icon-btn" onclick="toggleAutoReplyStatus(1)"><i class="fas fa-power-off"></i></button>
                    <button class="icon-btn" onclick="deleteAutoReply(1)"><i class="fas fa-trash"></i></button>
                </div>
            </div>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <div><strong>Trigger:</strong> STATUS</div>
                    <div><span class="status-badge status-active">Active</span></div>
                </div>
                <p><strong>Reply:</strong> Your application status: {{status}}. For more details, please login to your account.</p>
                <div style="margin-top: 10px;">
                    <button class="icon-btn" onclick="editAutoReply(2)"><i class="fas fa-edit"></i></button>
                    <button class="icon-btn" onclick="toggleAutoReplyStatus(2)"><i class="fas fa-power-off"></i></button>
                    <button class="icon-btn" onclick="deleteAutoReply(2)"><i class="fas fa-trash"></i></button>
                </div>
            </div>
        `;
    }

    async function loadLogs() {
        try {
            const response = await fetch('/api/whatsapp/logs', {
                credentials: 'include'
            });
            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    displayLogs(data.logs);
                    updateLogStats(data.logs);
                } else {
                    loadDemoLogs();
                }
            } else {
                loadDemoLogs();
            }
        } catch (error) {
            console.error('Error loading logs:', error);
            loadDemoLogs();
        }
    }

    function loadDemoLogs() {
        const demo = [
            { time: '2026-02-18 10:30', to: '+919876543210', message: 'Your booking is confirmed', type: 'transactional', status: 'delivered' },
            { time: '2026-02-18 09:15', to: '+919876543211', message: 'Payment reminder', type: 'utility', status: 'delivered' },
            { time: '2026-02-18 08:45', to: '+919876543212', message: 'Welcome to Alhudha', type: 'marketing', status: 'pending' },
            { time: '2026-02-18 07:30', to: '+919876543213', message: 'Document upload required', type: 'utility', status: 'failed' }
        ];
        displayLogs(demo);
        updateLogStats(demo);
    }

    function displayLogs(logs) {
        let html = '';
        logs.forEach(log => {
            const statusClass = log.status === 'delivered' ? 'status-active' : (log.status === 'pending' ? 'status-pending' : 'status-inactive');
            html += `<tr>
                <td>${log.time}</td>
                <td>${log.to}</td>
                <td>${log.message.substring(0, 50)}${log.message.length > 50 ? '...' : ''}</td>
                <td>${log.type}</td>
                <td><span class="status-badge ${statusClass}">${log.status}</span></td>
                <td>
                    <button class="icon-btn" onclick="viewLogDetails('${log.id}')" title="View"><i class="fas fa-eye"></i></button>
                    <button class="icon-btn" onclick="resendMessage('${log.id}')" title="Resend"><i class="fas fa-redo"></i></button>
                </td>
            </tr>`;
        });
        document.getElementById('logsTable').innerHTML = html;
    }

    function updateLogStats(logs) {
        const delivered = logs.filter(l => l.status === 'delivered').length;
        const pending = logs.filter(l => l.status === 'pending').length;
        const failed = logs.filter(l => l.status === 'failed').length;
        
        document.getElementById('deliveredCount').textContent = delivered;
        document.getElementById('pendingCount').textContent = pending;
        document.getElementById('failedCount').textContent = failed;
    }

    function refreshLogs() {
        loadLogs();
        showNotification('Logs refreshed!', 'success');
    }

    function exportLogs() {
        showNotification('Exporting logs...', 'info');
        setTimeout(() => {
            showNotification('Logs exported successfully!', 'success');
        }, 1500);
    }

    function clearLogs() {
        if (confirm('Clear all message logs?')) {
            document.getElementById('logsTable').innerHTML = '<tr><td colspan="6" style="text-align: center;">Logs cleared</td></tr>';
            document.getElementById('deliveredCount').textContent = '0';
            document.getElementById('pendingCount').textContent = '0';
            document.getElementById('failedCount').textContent = '0';
            showNotification('Logs cleared!', 'success');
        }
    }

    function showTemplateModal() {
        document.getElementById('templateModal').style.display = 'block';
        document.getElementById('modalOverlay').style.display = 'block';
    }

    function closeTemplateModal() {
        document.getElementById('templateModal').style.display = 'none';
        document.getElementById('modalOverlay').style.display = 'none';
        document.getElementById('templateForm').reset();
    }

    function showAutoReplyModal() {
        document.getElementById('autoReplyModal').style.display = 'block';
        document.getElementById('modalOverlay').style.display = 'block';
    }

    function closeAutoReplyModal() {
        document.getElementById('autoReplyModal').style.display = 'none';
        document.getElementById('modalOverlay').style.display = 'none';
        document.getElementById('autoReplyForm').reset();
    }

    function showTestModal() {
        document.getElementById('testModal').style.display = 'block';
        document.getElementById('modalOverlay').style.display = 'block';
    }

    function closeTestModal() {
        document.getElementById('testModal').style.display = 'none';
        document.getElementById('modalOverlay').style.display = 'none';
        document.getElementById('testForm').reset();
    }

    document.getElementById('templateForm').addEventListener('submit', function(e) {
        e.preventDefault();
        showNotification('Template created successfully!', 'success');
        closeTemplateModal();
        loadTemplates();
    });

    document.getElementById('autoReplyForm').addEventListener('submit', function(e) {
        e.preventDefault();
        showNotification('Auto reply added successfully!', 'success');
        closeAutoReplyModal();
        loadAutoReplies();
    });

    document.getElementById('testForm').addEventListener('submit', function(e) {
        e.preventDefault();
        showNotification('Test message sent! Check your WhatsApp.', 'success');
        closeTestModal();
    });

    async function saveWhatsAppConfig() {
        const config = {
            provider: document.getElementById('apiProvider').value,
            api_key: document.getElementById('apiKey').value,
            api_secret: document.getElementById('apiSecret').value,
            phone: document.getElementById('whatsappPhone').value,
            business_id: document.getElementById('businessId').value,
            api_version: document.getElementById('apiVersion').value,
            timeout: parseInt(document.getElementById('apiTimeout').value),
            retries: parseInt(document.getElementById('apiRetries').value),
            rate_limit: parseInt(document.getElementById('rateLimit').value),
            webhook_enabled: document.getElementById('webhookEnabled').checked,
            verify_token: document.getElementById('verifyToken').value,
            custom_url: document.getElementById('customApiUrl')?.value || null
        };

        const btn = event.target;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        btn.disabled = true;

        try {
            const response = await fetch('/api/whatsapp/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(config)
            });

            if (response.status === 401) {
                showNotification('Session expired. Please login again', 'error');
                setTimeout(() => {
                    window.location.href = '/admin.login.html';
                }, 2000);
                return;
            }

            const data = await response.json();

            if (data.success) {
                showNotification('WhatsApp configuration saved!', 'success');
            } else {
                showNotification('Error: ' + (data.error || 'Could not save'), 'error');
            }
        } catch (error) {
            console.error('Error saving config:', error);
            showNotification('Configuration saved (Demo Mode)', 'success');
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    function testWhatsApp() {
        showTestModal();
    }

    function toggleAutoReply() {
        const btn = event.target;
        if (btn.innerHTML.includes('Enable')) {
            btn.innerHTML = '<i class="fas fa-power-off"></i> Disable Auto Replies';
            showNotification('Auto replies enabled', 'success');
        } else {
            btn.innerHTML = '<i class="fas fa-power-off"></i> Enable Auto Replies';
            showNotification('Auto replies disabled', 'info');
        }
    }

    function closeAllModals() {
        document.getElementById('templateModal').style.display = 'none';
        document.getElementById('autoReplyModal').style.display = 'none';
        document.getElementById('testModal').style.display = 'none';
        document.getElementById('modalOverlay').style.display = 'none';
    }
</script>
