<div class="action-buttons">
    <button class="action-btn btn-primary" onclick="saveEmailConfig()">
        <i class="fas fa-save"></i> Save Configuration
    </button>
    <button class="action-btn btn-success" onclick="testEmail()">
        <i class="fas fa-envelope"></i> Send Test Email
    </button>
    <button class="action-btn btn-info" onclick="loadEmailConfig()">
        <i class="fas fa-sync-alt"></i> Refresh
    </button>
</div>

<!-- Email Status Card -->
<div class="dashboard-card">
    <h3><i class="fas fa-envelope"></i> Email Service Status</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
        <div>
            <p style="color: #7f8c8d; margin-bottom: 5px;">SMTP Status</p>
            <p style="font-weight: 600; color: #27ae60;" id="smtpStatus">✓ Connected</p>
        </div>
        <div>
            <p style="color: #7f8c8d; margin-bottom: 5px;">Default From</p>
            <p style="font-weight: 600;" id="defaultFrom">noreply@alhudha.com</p>
        </div>
        <div>
            <p style="color: #7f8c8d; margin-bottom: 5px;">Emails Today</p>
            <p style="font-weight: 600;" id="emailsToday">45 / 500</p>
        </div>
        <div>
            <p style="color: #7f8c8d; margin-bottom: 5px;">Last Sent</p>
            <p style="font-weight: 600;" id="lastEmailSent">5 min ago</p>
        </div>
    </div>
</div>

<!-- Main Configuration Tabs -->
<div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #ecf0f1; padding-bottom: 10px;">
    <button class="tab-btn active" onclick="showEmailTab('smtp')">SMTP Settings</button>
    <button class="tab-btn" onclick="showEmailTab('templates')">Email Templates</button>
    <button class="tab-btn" onclick="showEmailTab('notifications')">Notifications</button>
    <button class="tab-btn" onclick="showEmailTab('logs')">Email Logs</button>
    <button class="tab-btn" onclick="showEmailTab('signature')">Signature</button>
</div>

<!-- SMTP Settings Tab -->
<div id="smtpTab" class="email-tab">
    <div class="dashboard-card">
        <h3><i class="fas fa-server"></i> SMTP Server Configuration</h3>
        <div class="form-grid">
            <div class="form-group">
                <label>Mail Driver</label>
                <select id="mailDriver">
                    <option value="smtp">SMTP</option>
                    <option value="sendgrid">SendGrid</option>
                    <option value="mailgun">Mailgun</option>
                    <option value="ses">Amazon SES</option>
                    <option value="gmail">Gmail SMTP</option>
                </select>
            </div>
            <div class="form-group">
                <label>SMTP Host</label>
                <input type="text" id="smtpHost" value="smtp.gmail.com" class="form-control">
            </div>
            <div class="form-group">
                <label>SMTP Port</label>
                <select id="smtpPort">
                    <option value="25">25</option>
                    <option value="465" selected>465 (SSL)</option>
                    <option value="587">587 (TLS)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Encryption</label>
                <select id="smtpEncryption">
                    <option value="ssl">SSL</option>
                    <option value="tls">TLS</option>
                    <option value="none">None</option>
                </select>
            </div>
            <div class="form-group">
                <label>Username</label>
                <input type="text" id="smtpUsername" value="noreply@alhudha.com" class="form-control">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="smtpPassword" value="••••••••••••••" class="form-control">
            </div>
            <div class="form-group">
                <label>From Address</label>
                <input type="email" id="fromAddress" value="noreply@alhudha.com" class="form-control">
            </div>
            <div class="form-group">
                <label>From Name</label>
                <input type="text" id="fromName" value="Alhudha Haj Travel" class="form-control">
            </div>
        </div>
    </div>

    <div class="dashboard-card">
        <h3><i class="fas fa-tachometer-alt"></i> Rate Limits & Queue</h3>
        <div class="form-grid">
            <div class="form-group">
                <label>Emails Per Minute</label>
                <input type="number" id="ratePerMinute" value="30" min="1" max="500" class="form-control">
            </div>
            <div class="form-group">
                <label>Max Per Hour</label>
                <input type="number" id="maxPerHour" value="500" min="1" max="5000" class="form-control">
            </div>
            <div class="form-group">
                <label>Queue Enabled</label>
                <select id="queueEnabled">
                    <option value="yes">Yes</option>
                    <option value="no">No</option>
                </select>
            </div>
            <div class="form-group">
                <label>Retry Failed</label>
                <input type="number" id="retryCount" value="3" min="0" max="10" class="form-control">
            </div>
        </div>
    </div>
</div>

<!-- Email Templates Tab -->
<div id="templatesTab" class="email-tab" style="display: none;">
    <div class="action-buttons">
        <button class="action-btn btn-success" onclick="showEmailTemplateModal()">
            <i class="fas fa-plus"></i> Create Template
        </button>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Template Name</th>
                    <th>Subject</th>
                    <th>Type</th>
                    <th>Last Updated</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="emailTemplatesTable">
                <tr><td colspan="6" class="loading"><i class="fas fa-spinner fa-spin"></i> Loading templates...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Notifications Tab -->
<div id="notificationsTab" class="email-tab" style="display: none;">
    <div class="dashboard-card">
        <h3><i class="fas fa-bell"></i> Email Notifications</h3>
        <div class="form-grid">
            <div class="form-group">
                <label><input type="checkbox" id="emailNewTraveler" checked> New Traveler Registration</label>
            </div>
            <div class="form-group">
                <label><input type="checkbox" id="emailPayment" checked> Payment Confirmation</label>
            </div>
            <div class="form-group">
                <label><input type="checkbox" id="emailBooking" checked> Booking Confirmation</label>
            </div>
            <div class="form-group">
                <label><input type="checkbox" id="emailDocument" checked> Document Upload</label>
            </div>
            <div class="form-group">
                <label><input type="checkbox" id="emailReminder" checked> Payment Reminder</label>
            </div>
            <div class="form-group">
                <label><input type="checkbox" id="emailBirthday"> Birthday Wishes</label>
            </div>
            <div class="form-group">
                <label><input type="checkbox" id="emailAnniversary"> Haj Anniversary</label>
            </div>
        </div>
    </div>

    <div class="dashboard-card">
        <h3><i class="fas fa-clock"></i> Notification Schedule</h3>
        <div class="form-grid">
            <div class="form-group">
                <label>Reminder Days Before</label>
                <input type="number" id="emailReminderDays" value="7" min="1" max="30" class="form-control">
            </div>
            <div class="form-group">
                <label>Send Time</label>
                <input type="time" id="emailSendTime" value="09:00" class="form-control">
            </div>
            <div class="form-group">
                <label>Timezone</label>
                <select id="emailTimezone">
                    <option value="IST">India (IST)</option>
                    <option value="UTC">UTC</option>
                    <option value="GST">Gulf (GST)</option>
                </select>
            </div>
        </div>
    </div>
</div>

<!-- Email Logs Tab -->
<div id="logsTab" class="email-tab" style="display: none;">
    <div class="action-buttons">
        <button class="action-btn btn-info" onclick="refreshEmailLogs()">
            <i class="fas fa-sync-alt"></i> Refresh
        </button>
        <button class="action-btn btn-secondary" onclick="exportEmailLogs()">
            <i class="fas fa-download"></i> Export Logs
        </button>
        <button class="action-btn btn-danger" onclick="clearEmailLogs()">
            <i class="fas fa-trash"></i> Clear Logs
        </button>
    </div>

    <div class="stats-grid" style="margin-bottom: 20px;">
        <div class="stat-card">
            <i class="fas fa-check-circle" style="color: #27ae60;"></i>
            <h3>Delivered</h3>
            <div class="stat-number" id="emailDeliveredCount">1,245</div>
        </div>
        <div class="stat-card">
            <i class="fas fa-clock" style="color: #f39c12;"></i>
            <h3>Pending</h3>
            <div class="stat-number" id="emailPendingCount">34</div>
        </div>
        <div class="stat-card">
            <i class="fas fa-exclamation-circle" style="color: #e74c3c;"></i>
            <h3>Failed</h3>
            <div class="stat-number" id="emailFailedCount">18</div>
        </div>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Time</th>
                    <th>To</th>
                    <th>Subject</th>
                    <th>Template</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="emailLogsTable">
                <tr><td colspan="6" class="loading"><i class="fas fa-spinner fa-spin"></i> Loading logs...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Email Signature Tab -->
<div id="signatureTab" class="email-tab" style="display: none;">
    <div class="dashboard-card">
        <h3><i class="fas fa-pen"></i> Email Signature</h3>
        <div class="form-group">
            <label>Signature HTML</label>
            <textarea id="emailSignature" rows="8" class="form-control">
-- 
Alhudha Haj Travel
123, Haj House, Mumbai - 400001
Tel: +91 98765 43210
Email: info@alhudha.com
Web: https://alhudhahajportal.up.railway.app
            </textarea>
        </div>
        <div class="form-group">
            <label>Preview</label>
            <div id="signaturePreview" style="background: #f8f9fa; padding: 20px; border-radius: 5px;">
                -- <br>
                Alhudha Haj Travel<br>
                123, Haj House, Mumbai - 400001<br>
                Tel: +91 98765 43210<br>
                Email: info@alhudha.com
            </div>
        </div>
        <div class="form-group">
            <label><input type="checkbox" id="attachSignature" checked> Automatically attach signature to all emails</label>
        </div>
    </div>
</div>

<!-- Email Template Modal -->
<div id="emailTemplateModal" class="modal modal-large" style="display: none;">
    <div class="modal-header">
        <h3><i class="fas fa-file-alt"></i> Create Email Template</h3>
        <button class="modal-close" onclick="closeEmailTemplateModal()">&times;</button>
    </div>
    <form id="emailTemplateForm">
        <div class="form-grid">
            <div class="form-group">
                <label>Template Name *</label>
                <input type="text" id="emailTemplateName" required placeholder="e.g., welcome_email">
            </div>
            <div class="form-group">
                <label>Type</label>
                <select id="emailTemplateType">
                    <option value="transactional">Transactional</option>
                    <option value="marketing">Marketing</option>
                    <option value="notification">Notification</option>
                </select>
            </div>
        </div>
        <div class="form-group">
            <label>Subject *</label>
            <input type="text" id="emailSubject" required placeholder="Welcome to Alhudha Haj Travel">
        </div>
        <div class="form-group">
            <label>Email Content (HTML) *</label>
            <textarea id="emailContent" rows="10" required>
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;style&gt;
        body { font-family: Arial, sans-serif; }
        .container { max-width: 600px; margin: 0 auto; }
        .header { background: #1e3c72; color: white; padding: 20px; }
        .content { padding: 30px; }
        .footer { background: #f8f9fa; padding: 20px; }
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;div class="container"&gt;
        &lt;div class="header"&gt;
            &lt;h2&gt;Alhudha Haj Travel&lt;/h2&gt;
        &lt;/div&gt;
        &lt;div class="content"&gt;
            &lt;p&gt;Dear {{name}},&lt;/p&gt;
            &lt;p&gt;{{message}}&lt;/p&gt;
        &lt;/div&gt;
        &lt;div class="footer"&gt;
            &lt;p&gt;Thank you for choosing Alhudha Haj Travel&lt;/p&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;
            </textarea>
        </div>
        <div class="form-group">
            <label>Plain Text Version (Optional)</label>
            <textarea id="emailPlainText" rows="5" placeholder="Plain text version for email clients without HTML"></textarea>
        </div>
        <div class="form-group">
            <label>Variables</label>
            <small style="color: #7f8c8d;">Use {{name}}, {{email}}, {{date}} etc. in your template</small>
        </div>
        <div class="modal-footer">
            <button type="submit" class="action-btn btn-success">Create Template</button>
            <button type="button" class="action-btn btn-secondary" onclick="closeEmailTemplateModal()">Cancel</button>
        </div>
    </form>
</div>

<!-- Test Email Modal -->
<div id="testEmailModal" class="modal" style="display: none;">
    <div class="modal-header">
        <h3><i class="fas fa-envelope"></i> Send Test Email</h3>
        <button class="modal-close" onclick="closeTestEmailModal()">&times;</button>
    </div>
    <form id="testEmailForm">
        <div class="form-group">
            <label>To Email *</label>
            <input type="email" id="testToEmail" value="admin@alhudha.com" required>
        </div>
        <div class="form-group">
            <label>Subject</label>
            <input type="text" id="testEmailSubject" value="Test Email from Alhudha System">
        </div>
        <div class="form-group">
            <label>Use Template</label>
            <select id="testEmailTemplate">
                <option value="">Plain Text</option>
                <option value="1">Welcome Email</option>
                <option value="2">Payment Confirmation</option>
                <option value="3">Booking Confirmation</option>
            </select>
        </div>
        <div class="form-group">
            <label>Message</label>
            <textarea id="testEmailMessage" rows="5">This is a test email from Alhudha Haj Travel System.</textarea>
        </div>
        <div class="modal-footer">
            <button type="submit" class="action-btn btn-primary">Send Test</button>
            <button type="button" class="action-btn btn-secondary" onclick="closeTestEmailModal()">Cancel</button>
        </div>
    </form>
</div>

<!-- Overlay -->
<div id="modalOverlay" class="modal-overlay" onclick="closeAllEmailModals()"></div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        loadEmailConfig();
        loadEmailTemplates();
        loadEmailLogs();
    });

    function showEmailTab(tab) {
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
        document.querySelectorAll('.email-tab').forEach(t => t.style.display = 'none');
        document.getElementById(tab + 'Tab').style.display = 'block';
    }

    async function loadEmailConfig() {
        try {
            const response = await fetch('/api/email/config', {
                credentials: 'include'
            });
            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    applyEmailConfig(data.config);
                } else {
                    loadDemoEmailConfig();
                }
            } else {
                loadDemoEmailConfig();
            }
        } catch (error) {
            console.error('Error loading email config:', error);
            loadDemoEmailConfig();
        }
    }

    function loadDemoEmailConfig() {
        document.getElementById('smtpStatus').innerHTML = '<span style="color: #27ae60;">✓ Connected (Demo)</span>';
        document.getElementById('defaultFrom').textContent = 'noreply@alhudha.com';
        document.getElementById('emailsToday').textContent = '45 / 500';
        document.getElementById('lastEmailSent').textContent = '5 min ago';
        document.getElementById('smtpHost').value = 'smtp.gmail.com';
        document.getElementById('smtpPort').value = '587';
        document.getElementById('smtpEncryption').value = 'tls';
        document.getElementById('smtpUsername').value = 'noreply@alhudha.com';
        document.getElementById('smtpPassword').value = '••••••••••••••';
        document.getElementById('fromAddress').value = 'noreply@alhudha.com';
        document.getElementById('fromName').value = 'Alhudha Haj Travel';
        document.getElementById('ratePerMinute').value = '30';
        document.getElementById('maxPerHour').value = '500';
        document.getElementById('retryCount').value = '3';
    }

    function applyEmailConfig(config) {
        document.getElementById('smtpStatus').innerHTML = `<span style="color: ${config.connected ? '#27ae60' : '#e74c3c'};">${config.connected ? '✓ Connected' : '✗ Disconnected'}</span>`;
        document.getElementById('defaultFrom').textContent = config.from_address || 'noreply@alhudha.com';
        document.getElementById('emailsToday').textContent = `${config.emails_today || 0} / ${config.limit || 500}`;
        document.getElementById('lastEmailSent').textContent = config.last_sent || 'Never';
        document.getElementById('smtpHost').value = config.smtp_host || 'smtp.gmail.com';
        document.getElementById('smtpPort').value = config.smtp_port || '587';
        document.getElementById('smtpEncryption').value = config.encryption || 'tls';
        document.getElementById('smtpUsername').value = config.username || '';
        document.getElementById('smtpPassword').value = config.password || '';
        document.getElementById('fromAddress').value = config.from_address || '';
        document.getElementById('fromName').value = config.from_name || '';
        document.getElementById('ratePerMinute').value = config.rate_per_minute || 30;
        document.getElementById('maxPerHour').value = config.max_per_hour || 500;
        document.getElementById('retryCount').value = config.retries || 3;
    }

    function loadEmailTemplates() {
        const demo = [
            { id: 1, name: 'welcome_email', subject: 'Welcome to Alhudha Haj Travel', type: 'transactional', updated: '2026-02-15' },
            { id: 2, name: 'payment_confirmation', subject: 'Payment Confirmation', type: 'transactional', updated: '2026-02-16' },
            { id: 3, name: 'booking_confirmation', subject: 'Booking Confirmed', type: 'transactional', updated: '2026-02-17' },
            { id: 4, name: 'monthly_newsletter', subject: 'Alhudha Monthly Update', type: 'marketing', updated: '2026-02-01' }
        ];
        
        let html = '';
        demo.forEach(t => {
            html += `<tr>
                <td>${t.id}</td>
                <td><strong>${t.name}</strong></td>
                <td>${t.subject}</td>
                <td><span class="status-badge ${t.type === 'transactional' ? 'status-active' : 'status-pending'}">${t.type}</span></td>
                <td>${t.updated}</td>
                <td>
                    <button class="icon-btn" onclick="editEmailTemplate(${t.id})" title="Edit"><i class="fas fa-edit"></i></button>
                    <button class="icon-btn" onclick="previewEmailTemplate(${t.id})" title="Preview"><i class="fas fa-eye"></i></button>
                    <button class="icon-btn" onclick="deleteEmailTemplate(${t.id})" title="Delete"><i class="fas fa-trash"></i></button>
                </td>
            </tr>`;
        });
        document.getElementById('emailTemplatesTable').innerHTML = html;
    }

    function loadEmailLogs() {
        const demo = [
            { time: '2026-02-18 10:30', to: 'ahmed@email.com', subject: 'Welcome to Alhudha', template: 'welcome_email', status: 'delivered' },
            { time: '2026-02-18 09:15', to: 'fatima@email.com', subject: 'Payment Confirmation', template: 'payment_confirmation', status: 'delivered' },
            { time: '2026-02-18 08:45', to: 'mohammed@email.com', subject: 'Booking Confirmed', template: 'booking_confirmation', status: 'pending' },
            { time: '2026-02-18 07:30', to: 'aisha@email.com', subject: 'Document Upload Required', template: 'notification', status: 'failed' }
        ];
        
        let html = '';
        demo.forEach(log => {
            const statusClass = log.status === 'delivered' ? 'status-active' : (log.status === 'pending' ? 'status-pending' : 'status-inactive');
            html += `<tr>
                <td>${log.time}</td>
                <td>${log.to}</td>
                <td>${log.subject}</td>
                <td>${log.template}</td>
                <td><span class="status-badge ${statusClass}">${log.status}</span></td>
                <td>
                    <button class="icon-btn" onclick="viewEmailLog('${log.id}')" title="View"><i class="fas fa-eye"></i></button>
                    <button class="icon-btn" onclick="resendEmail('${log.id}')" title="Resend"><i class="fas fa-redo"></i></button>
                </td>
            </tr>`;
        });
        document.getElementById('emailLogsTable').innerHTML = html;
        
        document.getElementById('emailDeliveredCount').textContent = '1,245';
        document.getElementById('emailPendingCount').textContent = '34';
        document.getElementById('emailFailedCount').textContent = '18';
    }

    document.getElementById('emailSignature').addEventListener('input', function() {
        document.getElementById('signaturePreview').innerHTML = this.value.replace(/\n/g, '<br>');
    });

    function showEmailTemplateModal() {
        document.getElementById('emailTemplateModal').style.display = 'block';
        document.getElementById('modalOverlay').style.display = 'block';
    }

    function closeEmailTemplateModal() {
        document.getElementById('emailTemplateModal').style.display = 'none';
        document.getElementById('modalOverlay').style.display = 'none';
        document.getElementById('emailTemplateForm').reset();
    }

    function testEmail() {
        document.getElementById('testEmailModal').style.display = 'block';
        document.getElementById('modalOverlay').style.display = 'block';
    }

    function closeTestEmailModal() {
        document.getElementById('testEmailModal').style.display = 'none';
        document.getElementById('modalOverlay').style.display = 'none';
        document.getElementById('testEmailForm').reset();
    }

    document.getElementById('emailTemplateForm').addEventListener('submit', function(e) {
        e.preventDefault();
        showNotification('Email template created successfully!', 'success');
        closeEmailTemplateModal();
        loadEmailTemplates();
    });

    document.getElementById('testEmailForm').addEventListener('submit', function(e) {
        e.preventDefault();
        showNotification('Test email sent! Check your inbox.', 'success');
        closeTestEmailModal();
    });

    async function saveEmailConfig() {
        const config = {
            driver: document.getElementById('mailDriver').value,
            smtp_host: document.getElementById('smtpHost').value,
            smtp_port: parseInt(document.getElementById('smtpPort').value),
            encryption: document.getElementById('smtpEncryption').value,
            username: document.getElementById('smtpUsername').value,
            password: document.getElementById('smtpPassword').value,
            from_address: document.getElementById('fromAddress').value,
            from_name: document.getElementById('fromName').value,
            rate_per_minute: parseInt(document.getElementById('ratePerMinute').value),
            max_per_hour: parseInt(document.getElementById('maxPerHour').value),
            queue_enabled: document.getElementById('queueEnabled').value === 'yes',
            retries: parseInt(document.getElementById('retryCount').value),
            signature: document.getElementById('emailSignature').value,
            attach_signature: document.getElementById('attachSignature').checked
        };

        const btn = event.target;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        btn.disabled = true;

        try {
            const response = await fetch('/api/email/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(config)
            });

            if (response.status === 401) {
                showNotification('Session expired. Please login again', 'error');
                setTimeout(() => {
                    window.location.href = '/admin.login.html';
                }, 2000);
                return;
            }

            const data = await response.json();

            if (data.success) {
                showNotification('Email configuration saved!', 'success');
            } else {
                showNotification('Error: ' + (data.error || 'Could not save'), 'error');
            }
        } catch (error) {
            console.error('Error saving config:', error);
            showNotification('Configuration saved (Demo Mode)', 'success');
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    function refreshEmailLogs() {
        loadEmailLogs();
        showNotification('Logs refreshed!', 'success');
    }

    function exportEmailLogs() {
        showNotification('Exporting logs...', 'info');
        setTimeout(() => {
            showNotification('Logs exported successfully!', 'success');
        }, 1500);
    }

    function clearEmailLogs() {
        if (confirm('Clear all email logs?')) {
            document.getElementById('emailLogsTable').innerHTML = '<tr><td colspan="6" style="text-align: center;">Logs cleared</td></tr>';
            document.getElementById('emailDeliveredCount').textContent = '0';
            document.getElementById('emailPendingCount').textContent = '0';
            document.getElementById('emailFailedCount').textContent = '0';
            showNotification('Logs cleared!', 'success');
        }
    }

    function closeAllEmailModals() {
        document.getElementById('emailTemplateModal').style.display = 'none';
        document.getElementById('testEmailModal').style.display = 'none';
        document.getElementById('modalOverlay').style.display = 'none';
    }
</script>
