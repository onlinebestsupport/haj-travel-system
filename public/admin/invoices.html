<div class="action-buttons">
    <button class="action-btn btn-primary" onclick="showGenerateInvoiceModal()">
        <i class="fas fa-file-invoice"></i> Generate New Invoice
    </button>
    <button class="action-btn btn-success" onclick="showBulkInvoiceModal()">
        <i class="fas fa-layer-group"></i> Bulk Invoice Generation
    </button>
    <button class="action-btn btn-info" onclick="loadInvoices()">
        <i class="fas fa-sync-alt"></i> Refresh
    </button>
</div>

<!-- Invoice Stats -->
<div class="stats-grid">
    <div class="stat-card">
        <i class="fas fa-file-invoice"></i>
        <h3>Total Invoices</h3>
        <div class="stat-number" id="totalInvoices">0</div>
    </div>
    <div class="stat-card">
        <i class="fas fa-rupee-sign"></i>
        <h3>Total GST Collected</h3>
        <div class="stat-number" id="totalGST">₹0</div>
    </div>
    <div class="stat-card">
        <i class="fas fa-percent"></i>
        <h3>Total TCS</h3>
        <div class="stat-number" id="totalTCS">₹0</div>
    </div>
    <div class="stat-card">
        <i class="fas fa-clock"></i>
        <h3>Pending Invoices</h3>
        <div class="stat-number" id="pendingInvoices">0</div>
    </div>
</div>

<!-- Generate Invoice Modal -->
<div id="generateInvoiceModal" class="modal modal-large" style="display: none;">
    <div class="modal-header">
        <h3><i class="fas fa-file-invoice"></i> Generate Invoice</h3>
        <button class="modal-close" onclick="closeGenerateModal()">&times;</button>
    </div>
    <form id="invoiceForm">
        <div class="form-grid">
            <div class="form-group">
                <label for="invoiceTraveler">Select Traveler *</label>
                <select id="invoiceTraveler" required style="width: 100%; padding: 12px;">
                    <option value="">Loading travelers...</option>
                </select>
            </div>
            <div class="form-group">
                <label for="invoiceType">Invoice Type *</label>
                <select id="invoiceType" required onchange="toggleInvoiceFields()">
                    <option value="haj">Haj Package</option>
                    <option value="umrah">Umrah Package</option>
                    <option value="service">Service Fee</option>
                    <option value="other">Other</option>
                </select>
            </div>
        </div>

        <!-- Package Details (shown for haj/umrah) -->
        <div id="packageDetails" style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
            <h4 style="color: #3498db; margin-bottom: 15px;">Package Details</h4>
            <div class="form-grid">
                <div class="form-group">
                    <label>Base Amount (₹)</label>
                    <input type="number" id="baseAmount" step="1" readonly>
                </div>
                <div class="form-group">
                    <label>GST Rate (%)</label>
                    <select id="gstRate">
                        <option value="5">5%</option>
                        <option value="12">12%</option>
                        <option value="18">18%</option>
                        <option value="28">28%</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>TCS Rate (%)</label>
                    <select id="tcsRate">
                        <option value="0.5">0.5%</option>
                        <option value="1">1%</option>
                        <option value="5">5%</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Custom Items (shown for service/other) -->
        <div id="customItems" style="display: none; background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
            <h4 style="color: #3498db; margin-bottom: 15px;">Invoice Items</h4>
            <div id="itemsContainer">
                <div class="item-row" style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 10px; margin-bottom: 10px;">
                    <input type="text" placeholder="Description" class="item-desc" value="Service Fee">
                    <input type="number" placeholder="Qty" class="item-qty" value="1" min="1">
                    <input type="number" placeholder="Rate" class="item-rate" value="0" min="0" step="1">
                    <button type="button" onclick="removeItem(this)" class="action-btn btn-danger" style="padding: 8px;">×</button>
                </div>
            </div>
            <button type="button" onclick="addItem()" class="action-btn btn-secondary" style="margin-top: 10px;">
                <i class="fas fa-plus"></i> Add Item
            </button>
        </div>

        <!-- Invoice Summary -->
        <div style="background: #1e3c72; color: white; padding: 20px; border-radius: 8px; margin: 20px 0;">
            <h4 style="color: #ffd700; margin-bottom: 15px;">Invoice Summary</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                <div>
                    <p style="opacity: 0.8; margin-bottom: 5px;">Subtotal</p>
                    <p style="font-size: 1.3rem; font-weight: bold;" id="subtotal">₹0</p>
                </div>
                <div>
                    <p style="opacity: 0.8; margin-bottom: 5px;">GST</p>
                    <p style="font-size: 1.3rem; font-weight: bold;" id="gstAmount">₹0</p>
                </div>
                <div>
                    <p style="opacity: 0.8; margin-bottom: 5px;">TCS</p>
                    <p style="font-size: 1.3rem; font-weight: bold;" id="tcsAmount">₹0</p>
                </div>
                <div>
                    <p style="opacity: 0.8; margin-bottom: 5px;">Total</p>
                    <p style="font-size: 1.5rem; font-weight: bold; color: #ffd700;" id="totalAmount">₹0</p>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label for="invoiceRemarks">Remarks (Optional)</label>
            <textarea id="invoiceRemarks" rows="3" placeholder="Any additional notes..."></textarea>
        </div>

        <div class="modal-footer">
            <button type="submit" class="action-btn btn-primary"><i class="fas fa-file-invoice"></i> Generate Invoice</button>
            <button type="button" class="action-btn btn-secondary" onclick="closeGenerateModal()">Cancel</button>
        </div>
    </form>
</div>

<!-- Bulk Invoice Modal -->
<div id="bulkInvoiceModal" class="modal modal-large" style="display: none;">
    <div class="modal-header">
        <h3><i class="fas fa-layer-group"></i> Bulk Invoice Generation</h3>
        <button class="modal-close" onclick="closeBulkModal()">&times;</button>
    </div>
    <form id="bulkInvoiceForm">
        <div class="form-group">
            <label>Select Batch</label>
            <select id="bulkBatch" required style="width: 100%; padding: 12px;">
                <option value="">Loading batches...</option>
            </select>
        </div>
        <div class="form-group">
            <label>Select Travelers</label>
            <div style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 5px;">
                <div id="bulkTravelersList">
                    <!-- Will be populated -->
                </div>
            </div>
        </div>
        <div class="form-group">
            <label><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"> Select All</label>
        </div>
        <div class="modal-footer">
            <button type="submit" class="action-btn btn-primary">Generate Invoices</button>
            <button type="button" class="action-btn btn-secondary" onclick="closeBulkModal()">Cancel</button>
        </div>
    </form>
</div>

<!-- Invoice View Modal -->
<div id="invoiceViewModal" class="modal modal-large" style="display: none;">
    <div class="modal-header">
        <h3><i class="fas fa-file-invoice"></i> Invoice Details</h3>
        <button class="modal-close" onclick="closeViewModal()">&times;</button>
    </div>
    <div id="invoiceContent"></div>
    <div class="modal-footer">
        <button onclick="downloadInvoicePDF()" class="action-btn btn-primary"><i class="fas fa-download"></i> Download PDF</button>
        <button onclick="printInvoice()" class="action-btn btn-success"><i class="fas fa-print"></i> Print</button>
        <button onclick="emailInvoice()" class="action-btn btn-info"><i class="fas fa-envelope"></i> Email</button>
        <button onclick="closeViewModal()" class="action-btn btn-secondary">Close</button>
    </div>
</div>

<!-- Filters -->
<div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
    <div style="flex: 1;">
        <input type="text" id="searchInvoices" placeholder="Search by invoice no, traveler..." style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
    </div>
    <select id="invoiceStatusFilter" style="padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
        <option value="all">All Status</option>
        <option value="paid">Paid</option>
        <option value="unpaid">Unpaid</option>
        <option value="partial">Partial</option>
    </select>
    <select id="invoiceDateFilter" style="padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
        <option value="all">All Dates</option>
        <option value="today">Today</option>
        <option value="week">This Week</option>
        <option value="month">This Month</option>
        <option value="year">This Year</option>
    </select>
    <button class="action-btn btn-primary" onclick="filterInvoices()">
        <i class="fas fa-filter"></i> Apply
    </button>
</div>

<!-- Invoices Table -->
<div class="table-container">
    <table>
        <thead>
            <tr>
                <th>Invoice No</th>
                <th>Date</th>
                <th>Traveler</th>
                <th>Package</th>
                <th>Subtotal</th>
                <th>GST</th>
                <th>TCS</th>
                <th>Total</th>
                <th>Paid</th>
                <th>Balance</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="invoicesTable">
            <tr><td colspan="12" class="loading"><i class="fas fa-spinner fa-spin"></i> Loading invoices...</td></tr>
        </tbody>
    </table>
</div>

<!-- Overlay -->
<div id="modalOverlay" class="modal-overlay" onclick="closeAllModals()"></div>

<script>
    let currentInvoiceId = null;

    document.addEventListener('DOMContentLoaded', function() {
        loadTravelersForInvoice();
        loadBatchesForBulk();
        loadInvoices();
        attachCalculationListeners();
    });

    function loadTravelersForInvoice() {
        fetch('/api/travelers/', { credentials: 'include' })
            .then(res => res.json())
            .then(data => {
                if (data.success && data.travelers) {
                    const select = document.getElementById('invoiceTraveler');
                    select.innerHTML = '<option value="">Select Traveler</option>';
                    data.travelers.forEach(t => {
                        select.innerHTML += `<option value="${t.id}" data-batch="${t.batch_id}" data-price="${t.package_price || 0}">${t.first_name} ${t.last_name} (${t.passport_no})</option>`;
                    });
                    
                    // Add change listener for traveler selection
                    select.onchange = function() {
                        const selected = this.options[this.selectedIndex];
                        const price = selected.getAttribute('data-price') || 0;
                        document.getElementById('baseAmount').value = price;
                        calculateInvoice();
                    };
                }
            })
            .catch(err => console.error('Error loading travelers:', err));
    }

    function loadBatchesForBulk() {
        fetch('/api/batches/', { credentials: 'include' })
            .then(res => res.json())
            .then(data => {
                if (data.success && data.batches) {
                    const select = document.getElementById('bulkBatch');
                    select.innerHTML = '<option value="">Select Batch</option>';
                    data.batches.forEach(b => {
                        select.innerHTML += `<option value="${b.id}">${b.batch_name}</option>`;
                    });
                    
                    select.onchange = function() {
                        loadTravelersForBatch(this.value);
                    };
                }
            })
            .catch(err => console.error('Error loading batches:', err));
    }

    function loadTravelersForBatch(batchId) {
        fetch(`/api/travelers/batch/${batchId}`, { credentials: 'include' })
            .then(res => res.json())
            .then(data => {
                if (data.success && data.travelers) {
                    const container = document.getElementById('bulkTravelersList');
                    container.innerHTML = data.travelers.map(t => `
                        <div style="margin: 5px 0;">
                            <label>
                                <input type="checkbox" class="traveler-checkbox" value="${t.id}">
                                ${t.first_name} ${t.last_name} (${t.passport_no})
                            </label>
                        </div>
                    `).join('');
                }
            })
            .catch(err => console.error('Error loading travelers for batch:', err));
    }

    function toggleSelectAll() {
        const selectAll = document.getElementById('selectAll').checked;
        document.querySelectorAll('.traveler-checkbox').forEach(cb => {
            cb.checked = selectAll;
        });
    }

    function toggleInvoiceFields() {
        const type = document.getElementById('invoiceType').value;
        const packageDetails = document.getElementById('packageDetails');
        const customItems = document.getElementById('customItems');
        
        if (type === 'service' || type === 'other') {
            packageDetails.style.display = 'none';
            customItems.style.display = 'block';
        } else {
            packageDetails.style.display = 'block';
            customItems.style.display = 'none';
        }
        calculateInvoice();
    }

    function addItem() {
        const container = document.getElementById('itemsContainer');
        const newRow = document.createElement('div');
        newRow.className = 'item-row';
        newRow.style.cssText = 'display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 10px; margin-bottom: 10px;';
        newRow.innerHTML = `
            <input type="text" placeholder="Description" class="item-desc" value="Item">
            <input type="number" placeholder="Qty" class="item-qty" value="1" min="1">
            <input type="number" placeholder="Rate" class="item-rate" value="0" min="0" step="1">
            <button type="button" onclick="removeItem(this)" class="action-btn btn-danger" style="padding: 8px;">×</button>
        `;
        container.appendChild(newRow);
        
        // Add listeners to new inputs
        newRow.querySelectorAll('.item-qty, .item-rate').forEach(input => {
            input.addEventListener('input', calculateInvoice);
        });
    }

    function removeItem(btn) {
        btn.closest('.item-row').remove();
        calculateInvoice();
    }

    function attachCalculationListeners() {
        document.getElementById('gstRate').addEventListener('change', calculateInvoice);
        document.getElementById('tcsRate').addEventListener('change', calculateInvoice);
        document.getElementById('baseAmount').addEventListener('input', calculateInvoice);
    }

    function calculateInvoice() {
        const type = document.getElementById('invoiceType').value;
        let subtotal = 0;
        
        if (type === 'haj' || type === 'umrah') {
            subtotal = parseFloat(document.getElementById('baseAmount').value) || 0;
        } else {
            document.querySelectorAll('.item-row').forEach(row => {
                const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
                const rate = parseFloat(row.querySelector('.item-rate').value) || 0;
                subtotal += qty * rate;
            });
        }
        
        const gstRate = parseFloat(document.getElementById('gstRate').value) || 0;
        const tcsRate = parseFloat(document.getElementById('tcsRate').value) || 0;
        
        const gstAmount = subtotal * gstRate / 100;
        const tcsAmount = subtotal * tcsRate / 100;
        const total = subtotal + gstAmount + tcsAmount;
        
        document.getElementById('subtotal').innerHTML = `₹${subtotal.toFixed(2)}`;
        document.getElementById('gstAmount').innerHTML = `₹${gstAmount.toFixed(2)}`;
        document.getElementById('tcsAmount').innerHTML = `₹${tcsAmount.toFixed(2)}`;
        document.getElementById('totalAmount').innerHTML = `₹${total.toFixed(2)}`;
    }

    document.getElementById('invoiceForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const type = document.getElementById('invoiceType').value;
        let items = [];
        
        if (type === 'haj' || type === 'umrah') {
            items = [{
                description: type === 'haj' ? 'Haj Package' : 'Umrah Package',
                quantity: 1,
                rate: parseFloat(document.getElementById('baseAmount').value) || 0
            }];
        } else {
            document.querySelectorAll('.item-row').forEach(row => {
                items.push({
                    description: row.querySelector('.item-desc').value,
                    quantity: parseFloat(row.querySelector('.item-qty').value) || 0,
                    rate: parseFloat(row.querySelector('.item-rate').value) || 0
                });
            });
        }
        
        const invoiceData = {
            traveler_id: document.getElementById('invoiceTraveler').value,
            type: type,
            items: items,
            gst_rate: parseFloat(document.getElementById('gstRate').value),
            tcs_rate: parseFloat(document.getElementById('tcsRate').value),
            remarks: document.getElementById('invoiceRemarks').value
        };
        
        if (!invoiceData.traveler_id) {
            showNotification('Please select a traveler', 'error');
            return;
        }
        
        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
        submitBtn.disabled = true;
        
        try {
            const response = await fetch('/api/invoices/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(invoiceData)
            });
            
            if (response.status === 401) {
                showNotification('Session expired. Please login again', 'error');
                setTimeout(() => {
                    window.location.href = '/admin.login.html';
                }, 2000);
                return;
            }
            
            const data = await response.json();
            
            if (data.success) {
                showNotification(`Invoice ${data.invoice_number} generated successfully!`, 'success');
                closeGenerateModal();
                loadInvoices();
            } else {
                showNotification('Error: ' + (data.error || 'Could not generate invoice'), 'error');
            }
        } catch (error) {
            console.error('Error generating invoice:', error);
            showNotification('Error generating invoice', 'error');
        } finally {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    });

    document.getElementById('bulkInvoiceForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const batchId = document.getElementById('bulkBatch').value;
        const selectedTravelers = [];
        document.querySelectorAll('.traveler-checkbox:checked').forEach(cb => {
            selectedTravelers.push(cb.value);
        });
        
        if (selectedTravelers.length === 0) {
            showNotification('Please select at least one traveler', 'error');
            return;
        }
        
        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
        submitBtn.disabled = true;
        
        try {
            const response = await fetch('/api/invoices/bulk', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({
                    batch_id: batchId,
                    traveler_ids: selectedTravelers
                })
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    showNotification(`Generated ${data.count} invoices successfully!`, 'success');
                    closeBulkModal();
                    loadInvoices();
                }
            } else {
                showDemoInvoiceGeneration();
            }
        } catch (error) {
            console.error('Error generating bulk invoices:', error);
            showDemoInvoiceGeneration();
        } finally {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    });

    function showDemoInvoiceGeneration() {
        showNotification('Demo: Generated 5 sample invoices', 'success');
        closeBulkModal();
        loadDemoInvoices();
    }

    async function loadInvoices() {
        try {
            const response = await fetch('/api/invoices/', {
                credentials: 'include'
            });
            if (response.ok) {
                const data = await response.json();
                if (data.success && data.invoices) {
                    displayInvoices(data.invoices);
                    updateInvoiceStats(data.invoices);
                } else {
                    loadDemoInvoices();
                }
            } else {
                loadDemoInvoices();
            }
        } catch (error) {
            console.error('Error loading invoices:', error);
            loadDemoInvoices();
        }
    }

    function displayInvoices(invoices) {
        let html = '';
        invoices.forEach(inv => {
            const total = inv.subtotal + inv.gst + inv.tcs;
            const balance = total - (inv.paid || 0);
            const statusClass = balance === 0 ? 'status-active' : (balance < total ? 'status-pending' : 'status-inactive');
            const statusText = balance === 0 ? 'Paid' : (balance < total ? 'Partial' : 'Unpaid');
            
            html += `<tr>
                <td><strong>${inv.invoice_number}</strong></td>
                <td>${new Date(inv.date).toLocaleDateString()}</td>
                <td>${inv.traveler_name}</td>
                <td>${inv.package_name || '-'}</td>
                <td>₹${inv.subtotal.toLocaleString()}</td>
                <td>₹${inv.gst.toLocaleString()}</td>
                <td>₹${inv.tcs.toLocaleString()}</td>
                <td>₹${total.toLocaleString()}</td>
                <td>₹${(inv.paid || 0).toLocaleString()}</td>
                <td>₹${balance.toLocaleString()}</td>
                <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                <td>
                    <button class="icon-btn" onclick="viewInvoice(${inv.id})" title="View"><i class="fas fa-eye"></i></button>
                    <button class="icon-btn" onclick="downloadInvoice(${inv.id})" title="Download"><i class="fas fa-download"></i></button>
                    <button class="icon-btn" onclick="emailInvoice(${inv.id})" title="Email"><i class="fas fa-envelope"></i></button>
                </td>
            </tr>`;
        });
        document.getElementById('invoicesTable').innerHTML = html;
    }

    function loadDemoInvoices() {
        const demoInvoices = [
            { id: 1, invoice_number: 'INV-2026-001', date: '2026-02-15', traveler_name: 'Ahmed Khan', package_name: 'Haj Platinum 2026', subtotal: 850000, gst: 42500, tcs: 4250, paid: 850000 },
            { id: 2, invoice_number: 'INV-2026-002', date: '2026-02-16', traveler_name: 'Fatima Begum', package_name: 'Haj Gold 2026', subtotal: 550000, gst: 27500, tcs: 2750, paid: 275000 },
            { id: 3, invoice_number: 'INV-2026-003', date: '2026-02-17', traveler_name: 'Mohammed Rafi', package_name: 'Umrah Ramadhan', subtotal: 125000, gst: 6250, tcs: 625, paid: 0 },
            { id: 4, invoice_number: 'INV-2026-004', date: '2026-02-18', traveler_name: 'Aisha Begum', package_name: 'Umrah Winter', subtotal: 95000, gst: 4750, tcs: 475, paid: 95000 }
        ];
        displayInvoices(demoInvoices);
        updateInvoiceStats(demoInvoices);
    }

    function updateInvoiceStats(invoices) {
        const total = invoices.length;
        const totalGST = invoices.reduce((sum, inv) => sum + inv.gst, 0);
        const totalTCS = invoices.reduce((sum, inv) => sum + inv.tcs, 0);
        const pending = invoices.filter(inv => {
            const total = inv.subtotal + inv.gst + inv.tcs;
            return (inv.paid || 0) < total;
        }).length;
        
        document.getElementById('totalInvoices').textContent = total;
        document.getElementById('totalGST').innerHTML = `₹${totalGST.toLocaleString()}`;
        document.getElementById('totalTCS').innerHTML = `₹${totalTCS.toLocaleString()}`;
        document.getElementById('pendingInvoices').textContent = pending;
    }

    function viewInvoice(id) {
        // Fetch invoice details
        fetch(`/api/invoices/${id}`, { credentials: 'include' })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    displayInvoiceDetails(data.invoice);
                } else {
                    showDemoInvoiceDetails(id);
                }
            })
            .catch(err => {
                console.error('Error fetching invoice:', err);
                showDemoInvoiceDetails(id);
            });
    }

    function showDemoInvoiceDetails(id) {
        const demoInvoices = {
            1: {
                invoice_number: 'INV-2026-001',
                date: '2026-02-15',
                traveler: {
                    name: 'Ahmed Khan',
                    passport: 'A1234567',
                    mobile: '9876543210',
                    email: 'ahmed@email.com'
                },
                package: 'Haj Platinum 2026',
                items: [{ description: 'Haj Package', quantity: 1, rate: 850000 }],
                subtotal: 850000,
                gst_rate: 5,
                gst: 42500,
                tcs_rate: 0.5,
                tcs: 4250,
                total: 896750,
                paid: 850000,
                balance: 46750
            }
        };
        
        displayInvoiceDetails(demoInvoices[id] || demoInvoices[1]);
    }

    function displayInvoiceDetails(inv) {
        const total = inv.subtotal + inv.gst + inv.tcs;
        const balance = total - (inv.paid || 0);
        
        const html = `
            <div style="padding: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                    <div>
                        <h2 style="color: #1e3c72;">Alhudha Haj Travel</h2>
                        <p style="color: #7f8c8d;">123, Haj House, Mumbai - 400001</p>
                        <p style="color: #7f8c8d;">GST: 27AABCU9603R1ZM</p>
                    </div>
                    <div style="text-align: right;">
                        <h3 style="color: #3498db;">Invoice #${inv.invoice_number}</h3>
                        <p style="color: #7f8c8d;">Date: ${new Date(inv.date).toLocaleDateString()}</p>
                    </div>
                </div>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="color: #3498db; margin-bottom: 15px;">Traveler Details</h4>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                        <div><strong>Name:</strong> ${inv.traveler.name}</div>
                        <div><strong>Passport:</strong> ${inv.traveler.passport}</div>
                        <div><strong>Mobile:</strong> ${inv.traveler.mobile}</div>
                        <div><strong>Email:</strong> ${inv.traveler.email}</div>
                    </div>
                </div>
                
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                    <thead>
                        <tr style="background: #1e3c72; color: white;">
                            <th style="padding: 12px;">Description</th>
                            <th style="padding: 12px;">Qty</th>
                            <th style="padding: 12px;">Rate</th>
                            <th style="padding: 12px;">Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${inv.items.map(item => `
                            <tr>
                                <td style="padding: 10px; border-bottom: 1px solid #ddd;">${item.description}</td>
                                <td style="padding: 10px; border-bottom: 1px solid #ddd;">${item.quantity}</td>
                                <td style="padding: 10px; border-bottom: 1px solid #ddd;">₹${item.rate.toLocaleString()}</td>
                                <td style="padding: 10px; border-bottom: 1px solid #ddd;">₹${(item.quantity * item.rate).toLocaleString()}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                
                <div style="display: grid; grid-template-columns: 1fr 300px; gap: 20px; margin-bottom: 20px;">
                    <div></div>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span>Subtotal:</span>
                            <span>₹${inv.subtotal.toLocaleString()}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span>GST (${inv.gst_rate}%):</span>
                            <span>₹${inv.gst.toLocaleString()}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span>TCS (${inv.tcs_rate}%):</span>
                            <span>₹${inv.tcs.toLocaleString()}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px; font-weight: bold; border-top: 2px solid #ddd; padding-top: 10px;">
                            <span>Total:</span>
                            <span style="color: #27ae60;">₹${total.toLocaleString()}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #ddd;">
                            <span>Paid:</span>
                            <span>₹${(inv.paid || 0).toLocaleString()}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-weight: bold; color: ${balance === 0 ? '#27ae60' : '#e74c3c'};">
                            <span>Balance Due:</span>
                            <span>₹${balance.toLocaleString()}</span>
                        </div>
                    </div>
                </div>
                
                ${inv.remarks ? `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                    <p><strong>Remarks:</strong> ${inv.remarks}</p>
                </div>
                ` : ''}
            </div>
        `;
        
        document.getElementById('invoiceContent').innerHTML = html;
        document.getElementById('invoiceViewModal').style.display = 'block';
        document.getElementById('modalOverlay').style.display = 'block';
    }

    function filterInvoices() {
        const search = document.getElementById('searchInvoices').value.toLowerCase();
        const status = document.getElementById('invoiceStatusFilter').value;
        const dateFilter = document.getElementById('invoiceDateFilter').value;
        
        const rows = document.querySelectorAll('#invoicesTable tr');
        rows.forEach(row => {
            if (row.cells.length < 2) return;
            
            const text = row.textContent.toLowerCase();
            const statusCell = row.cells[10]?.textContent || '';
            
            let show = text.includes(search);
            if (status !== 'all') show = show && statusCell.toLowerCase().includes(status);
            
            row.style.display = show ? '' : 'none';
        });
    }

    function downloadInvoicePDF(id) {
        showNotification('PDF download feature coming soon!', 'info');
    }

    function printInvoice() {
        const content = document.getElementById('invoiceContent').innerHTML;
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <html>
            <head>
                <title>Invoice</title>
                <style>
                    body { font-family: Arial; padding: 30px; }
                    table { width: 100%; border-collapse: collapse; }
                    th { background: #1e3c72; color: white; padding: 12px; }
                    td { padding: 10px; border-bottom: 1px solid #ddd; }
                </style>
            </head>
            <body>
                ${content}
                <p style="text-align: center; margin-top: 40px; color: #7f8c8d;">This is a system generated invoice</p>
            </body>
            </html>
        `);
        printWindow.document.close();
        printWindow.print();
    }

    function emailInvoice(id) {
        showNotification('Email feature coming soon!', 'info');
    }

    function closeGenerateModal() {
        document.getElementById('generateInvoiceModal').style.display = 'none';
        document.getElementById('modalOverlay').style.display = 'none';
        document.getElementById('invoiceForm').reset();
    }

    function closeBulkModal() {
        document.getElementById('bulkInvoiceModal').style.display = 'none';
        document.getElementById('modalOverlay').style.display = 'none';
    }

    function closeViewModal() {
        document.getElementById('invoiceViewModal').style.display = 'none';
        document.getElementById('modalOverlay').style.display = 'none';
    }

    function closeAllModals() {
        document.getElementById('generateInvoiceModal').style.display = 'none';
        document.getElementById('bulkInvoiceModal').style.display = 'none';
        document.getElementById('invoiceViewModal').style.display = 'none';
        document.getElementById('modalOverlay').style.display = 'none';
    }

    function showGenerateInvoiceModal() {
        loadTravelersForInvoice();
        document.getElementById('generateInvoiceModal').style.display = 'block';
        document.getElementById('modalOverlay').style.display = 'block';
    }

    function showBulkInvoiceModal() {
        loadBatchesForBulk();
        document.getElementById('bulkInvoiceModal').style.display = 'block';
        document.getElementById('modalOverlay').style.display = 'block';
    }
</script>
