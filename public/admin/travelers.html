<div class="action-buttons">
    <button class="action-btn btn-success" onclick="showAddTravelerForm()">
        <i class="fas fa-user-plus"></i> Add New Traveler
    </button>
</div>

<!-- ADD TRAVELER FORM - 33 FIELDS -->
<div class="form-container" id="addTravelerForm" style="display: none;">
    <h3><i class="fas fa-user-plus"></i> Add New Traveler - 33 Fields</h3>
    <form id="travelerAddForm">
        <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
            <h4 style="color: #3498db; margin-bottom: 15px;"><i class="fas fa-user"></i> 1. Personal Information</h4>
            <div class="form-grid">
                <div class="form-group">
                    <label for="add_first_name">First Name *</label>
                    <input type="text" id="add_first_name" required>
                </div>
                <div class="form-group">
                    <label for="add_last_name">Last Name *</label>
                    <input type="text" id="add_last_name" required>
                </div>
                <div class="form-group">
                    <label for="add_passport_name">Passport Name (Auto)</label>
                    <input type="text" id="add_passport_name" readonly>
                </div>
                <div class="form-group">
                    <label for="add_batch_id">Batch *</label>
                    <select id="add_batch_id" required>
                        <option value="">Select Batch</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="add_passport_no">Passport Number *</label>
                    <input type="text" id="add_passport_no" required>
                </div>
                <div class="form-group">
                    <label for="add_passport_issue_date">Passport Issue Date</label>
                    <input type="date" id="add_passport_issue_date">
                </div>
                <div class="form-group">
                    <label for="add_passport_expiry_date">Passport Expiry Date</label>
                    <input type="date" id="add_passport_expiry_date">
                </div>
                <div class="form-group">
                    <label for="add_passport_status">Passport Status</label>
                    <select id="add_passport_status">
                        <option value="Active">Active</option>
                        <option value="Expired">Expired</option>
                        <option value="Submitted">Submitted</option>
                        <option value="Processing">Processing</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="add_gender">Gender</label>
                    <select id="add_gender">
                        <option value="">Select</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="add_dob">Date of Birth</label>
                    <input type="date" id="add_dob">
                </div>
            </div>
        </div>

        <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
            <h4 style="color: #3498db; margin-bottom: 15px;"><i class="fas fa-address-book"></i> 2. Contact Information</h4>
            <div class="form-grid">
                <div class="form-group">
                    <label for="add_mobile">Mobile Number *</label>
                    <input type="tel" id="add_mobile" required>
                </div>
                <div class="form-group">
                    <label for="add_email">Email</label>
                    <input type="email" id="add_email">
                </div>
                <div class="form-group">
                    <label for="add_aadhaar">Aadhaar Number</label>
                    <input type="text" id="add_aadhaar">
                </div>
                <div class="form-group">
                    <label for="add_pan">PAN Number</label>
                    <input type="text" id="add_pan">
                </div>
                <div class="form-group">
                    <label for="add_aadhaar_pan_linked">Aadhaar-PAN Linked</label>
                    <select id="add_aadhaar_pan_linked">
                        <option value="No">No</option>
                        <option value="Yes">Yes</option>
                        <option value="Pending">Pending</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="add_vaccine_status">Vaccine Status</label>
                    <select id="add_vaccine_status">
                        <option value="Not Vaccinated">Not Vaccinated</option>
                        <option value="Partially Vaccinated">Partially Vaccinated</option>
                        <option value="Fully Vaccinated">Fully Vaccinated</option>
                        <option value="Booster">Booster</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="add_wheelchair">Wheelchair Required</label>
                    <select id="add_wheelchair">
                        <option value="No">No</option>
                        <option value="Yes">Yes</option>
                    </select>
                </div>
            </div>
        </div>

        <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
            <h4 style="color: #3498db; margin-bottom: 15px;"><i class="fas fa-home"></i> 3. Address & Family</h4>
            <div class="form-grid">
                <div class="form-group">
                    <label for="add_place_of_birth">Place of Birth</label>
                    <input type="text" id="add_place_of_birth">
                </div>
                <div class="form-group">
                    <label for="add_place_of_issue">Place of Issue</label>
                    <input type="text" id="add_place_of_issue">
                </div>
                <div class="form-group full-width">
                    <label for="add_passport_address">Passport Address</label>
                    <textarea id="add_passport_address" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="add_father_name">Father's Name</label>
                    <input type="text" id="add_father_name">
                </div>
                <div class="form-group">
                    <label for="add_mother_name">Mother's Name</label>
                    <input type="text" id="add_mother_name">
                </div>
                <div class="form-group">
                    <label for="add_spouse_name">Spouse's Name</label>
                    <input type="text" id="add_spouse_name">
                </div>
            </div>
        </div>

        <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
            <h4 style="color: #3498db; margin-bottom: 15px;"><i class="fas fa-file-upload"></i> 4. Documents</h4>
            <div class="form-grid">
                <div class="form-group">
                    <label for="add_passport_scan">Passport Scan</label>
                    <div class="document-upload" onclick="document.getElementById('add_passport_scan').click()">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p id="add_passport_scan_text">Click to upload</p>
                        <input type="file" id="add_passport_scan" style="display: none;" accept=".pdf,.jpg,.png">
                    </div>
                </div>
                <div class="form-group">
                    <label for="add_aadhaar_scan">Aadhaar Scan</label>
                    <div class="document-upload" onclick="document.getElementById('add_aadhaar_scan').click()">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p id="add_aadhaar_scan_text">Click to upload</p>
                        <input type="file" id="add_aadhaar_scan" style="display: none;" accept=".pdf,.jpg,.png">
                    </div>
                </div>
                <div class="form-group">
                    <label for="add_pan_scan">PAN Scan</label>
                    <div class="document-upload" onclick="document.getElementById('add_pan_scan').click()">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p id="add_pan_scan_text">Click to upload</p>
                        <input type="file" id="add_pan_scan" style="display: none;" accept=".pdf,.jpg,.png">
                    </div>
                </div>
                <div class="form-group">
                    <label for="add_vaccine_scan">Vaccine Certificate</label>
                    <div class="document-upload" onclick="document.getElementById('add_vaccine_scan').click()">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p id="add_vaccine_scan_text">Click to upload</p>
                        <input type="file" id="add_vaccine_scan" style="display: none;" accept=".pdf,.jpg,.png">
                    </div>
                </div>
            </div>
        </div>

        <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
            <h4 style="color: #3498db; margin-bottom: 15px;"><i class="fas fa-cog"></i> 5. Additional Information</h4>
            <div class="form-grid">
                <div class="form-group">
                    <label for="add_pin">PIN (4 digits)</label>
                    <input type="text" id="add_pin" maxlength="4" value="0000">
                </div>
                <div class="form-group full-width">
                    <label for="add_extra_fields">Extra Fields (JSON)</label>
                    <textarea id="add_extra_fields" rows="3" placeholder='{"emergency_contact": "", "blood_group": "", "allergies": ""}'></textarea>
                </div>
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="action-btn btn-success"><i class="fas fa-save"></i> Add Traveler (33 Fields)</button>
            <button type="button" class="action-btn btn-secondary" onclick="hideAddTravelerForm()"><i class="fas fa-times"></i> Cancel</button>
        </div>
    </form>
</div>

<!-- EDIT TRAVELER FORM - 33 FIELDS -->
<div class="form-container" id="editTravelerForm" style="display: none;">
    <h3><i class="fas fa-user-edit"></i> Edit Traveler - 33 Fields</h3>
    <form id="adminTravelerForm">
        <input type="hidden" id="edit_traveler_id">
        
        <!-- Personal Information -->
        <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
            <h4 style="color: #3498db; margin-bottom: 15px;">1. Personal Information</h4>
            <div class="form-grid">
                <div class="form-group">
                    <label for="edit_first_name">First Name *</label>
                    <input type="text" id="edit_first_name" required>
                </div>
                <div class="form-group">
                    <label for="edit_last_name">Last Name *</label>
                    <input type="text" id="edit_last_name" required>
                </div>
                <div class="form-group">
                    <label for="edit_passport_name">Passport Name (Auto)</label>
                    <input type="text" id="edit_passport_name" readonly>
                </div>
                <div class="form-group">
                    <label for="edit_batch_id">Batch</label>
                    <select id="edit_batch_id">
                        <option value="">Select Batch</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="edit_passport_no">Passport Number *</label>
                    <input type="text" id="edit_passport_no" required>
                </div>
                <div class="form-group">
                    <label for="edit_passport_issue_date">Passport Issue Date</label>
                    <input type="date" id="edit_passport_issue_date">
                </div>
                <div class="form-group">
                    <label for="edit_passport_expiry_date">Passport Expiry Date</label>
                    <input type="date" id="edit_passport_expiry_date">
                </div>
                <div class="form-group">
                    <label for="edit_passport_status">Passport Status</label>
                    <select id="edit_passport_status">
                        <option value="Active">Active</option>
                        <option value="Expired">Expired</option>
                        <option value="Submitted">Submitted</option>
                        <option value="Processing">Processing</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="edit_gender">Gender</label>
                    <select id="edit_gender">
                        <option value="">Select</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="edit_dob">Date of Birth</label>
                    <input type="date" id="edit_dob">
                </div>
            </div>
        </div>

        <!-- Contact Information -->
        <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
            <h4 style="color: #3498db; margin-bottom: 15px;">2. Contact Information</h4>
            <div class="form-grid">
                <div class="form-group">
                    <label for="edit_mobile">Mobile Number *</label>
                    <input type="tel" id="edit_mobile" required>
                </div>
                <div class="form-group">
                    <label for="edit_email">Email</label>
                    <input type="email" id="edit_email">
                </div>
                <div class="form-group">
                    <label for="edit_aadhaar">Aadhaar Number</label>
                    <input type="text" id="edit_aadhaar">
                </div>
                <div class="form-group">
                    <label for="edit_pan">PAN Number</label>
                    <input type="text" id="edit_pan">
                </div>
                <div class="form-group">
                    <label for="edit_aadhaar_pan_linked">Aadhaar-PAN Linked</label>
                    <select id="edit_aadhaar_pan_linked">
                        <option value="No">No</option>
                        <option value="Yes">Yes</option>
                        <option value="Pending">Pending</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="edit_vaccine_status">Vaccine Status</label>
                    <select id="edit_vaccine_status">
                        <option value="Not Vaccinated">Not Vaccinated</option>
                        <option value="Partially Vaccinated">Partially Vaccinated</option>
                        <option value="Fully Vaccinated">Fully Vaccinated</option>
                        <option value="Booster">Booster</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="edit_wheelchair">Wheelchair Required</label>
                    <select id="edit_wheelchair">
                        <option value="No">No</option>
                        <option value="Yes">Yes</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Address & Family -->
        <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
            <h4 style="color: #3498db; margin-bottom: 15px;">3. Address & Family</h4>
            <div class="form-grid">
                <div class="form-group">
                    <label for="edit_place_of_birth">Place of Birth</label>
                    <input type="text" id="edit_place_of_birth">
                </div>
                <div class="form-group">
                    <label for="edit_place_of_issue">Place of Issue</label>
                    <input type="text" id="edit_place_of_issue">
                </div>
                <div class="form-group full-width">
                    <label for="edit_passport_address">Passport Address</label>
                    <textarea id="edit_passport_address" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="edit_father_name">Father's Name</label>
                    <input type="text" id="edit_father_name">
                </div>
                <div class="form-group">
                    <label for="edit_mother_name">Mother's Name</label>
                    <input type="text" id="edit_mother_name">
                </div>
                <div class="form-group">
                    <label for="edit_spouse_name">Spouse's Name</label>
                    <input type="text" id="edit_spouse_name">
                </div>
            </div>
        </div>

        <!-- Documents -->
        <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
            <h4 style="color: #3498db; margin-bottom: 15px;">4. Documents</h4>
            <div class="form-grid">
                <div class="form-group">
                    <label for="edit_passport_scan">Passport Scan</label>
                    <div class="document-upload" onclick="document.getElementById('edit_passport_scan').click()">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p id="edit_passport_scan_text">Click to upload</p>
                        <input type="file" id="edit_passport_scan" style="display: none;" accept=".pdf,.jpg,.png">
                    </div>
                </div>
                <div class="form-group">
                    <label for="edit_aadhaar_scan">Aadhaar Scan</label>
                    <div class="document-upload" onclick="document.getElementById('edit_aadhaar_scan').click()">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p id="edit_aadhaar_scan_text">Click to upload</p>
                        <input type="file" id="edit_aadhaar_scan" style="display: none;" accept=".pdf,.jpg,.png">
                    </div>
                </div>
                <div class="form-group">
                    <label for="edit_pan_scan">PAN Scan</label>
                    <div class="document-upload" onclick="document.getElementById('edit_pan_scan').click()">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p id="edit_pan_scan_text">Click to upload</p>
                        <input type="file" id="edit_pan_scan" style="display: none;" accept=".pdf,.jpg,.png">
                    </div>
                </div>
                <div class="form-group">
                    <label for="edit_vaccine_scan">Vaccine Certificate</label>
                    <div class="document-upload" onclick="document.getElementById('edit_vaccine_scan').click()">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p id="edit_vaccine_scan_text">Click to upload</p>
                        <input type="file" id="edit_vaccine_scan" style="display: none;" accept=".pdf,.jpg,.png">
                    </div>
                </div>
            </div>
        </div>

        <!-- Extra Fields -->
        <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
            <h4 style="color: #3498db; margin-bottom: 15px;">5. Additional Information</h4>
            <div class="form-grid">
                <div class="form-group">
                    <label for="edit_pin">PIN (4 digits)</label>
                    <input type="text" id="edit_pin" maxlength="4" value="0000">
                </div>
                <div class="form-group full-width">
                    <label for="edit_extra_fields">Extra Fields (JSON)</label>
                    <textarea id="edit_extra_fields" rows="3" placeholder='{"emergency_contact": "", "blood_group": "", "allergies": ""}'></textarea>
                </div>
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="action-btn btn-primary"><i class="fas fa-save"></i> Update Traveler (33 Fields)</button>
            <button type="button" class="action-btn btn-secondary" onclick="hideEditForm()"><i class="fas fa-times"></i> Cancel</button>
        </div>
    </form>
</div>

<div class="search-box">
    <input type="text" id="searchTravelers" placeholder="Search travelers...">
    <button class="action-btn btn-primary" onclick="searchTravelers()">
        <i class="fas fa-search"></i> Search
    </button>
</div>

<div class="table-container">
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Passport</th>
                <th>Mobile</th>
                <th>Batch</th>
                <th>Status</th>
                <th>PIN</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="travelersTable">
            <tr><td colspan="8" class="loading"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>
        </tbody>
    </table>
</div>

<!-- Traveler Detail Modal -->
<div id="travelerModal" class="modal modal-large" style="display: none;">
    <div class="modal-header">
        <h3><i class="fas fa-user"></i> Traveler Full Details</h3>
        <button class="modal-close" onclick="closeTravelerModal()">&times;</button>
    </div>
    <div id="travelerDetails" style="margin-bottom: 20px;"></div>
    <div class="modal-footer">
        <button onclick="closeTravelerModal()" class="action-btn btn-secondary"><i class="fas fa-times"></i> Close</button>
        <button onclick="printTravelerDetails()" class="action-btn btn-primary"><i class="fas fa-print"></i> Print</button>
    </div>
</div>

<div id="modalOverlay" class="modal-overlay" onclick="closeTravelerModal()"></div>

<style>
/* Status Badge Styles */
.status-badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.85rem;
    font-weight: 500;
}

.status-active {
    background: #e8f5e9;
    color: #2e7d32;
}

.status-pending {
    background: #fff3e0;
    color: #ef6c00;
}

.status-warning {
    background: #fff3e0;
    color: #ef6c00;
}

.status-full {
    background: #ffebee;
    color: #c62828;
}

.status-closed {
    background: #f5f5f5;
    color: #616161;
}

/* Modal Styles */
.modal {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 30px;
    border-radius: 15px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    z-index: 2000;
    max-width: 900px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
}

.modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1999;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid #ecf0f1;
}

.modal-close {
    background: none;
    border: none;
    font-size: 1.8rem;
    cursor: pointer;
    color: #7f8c8d;
}

.modal-close:hover {
    color: #e74c3c;
}

.modal-footer {
    margin-top: 20px;
    padding-top: 10px;
    border-top: 1px solid #ecf0f1;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

/* Notification Styles */
.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 25px;
    border-radius: 5px;
    color: white;
    z-index: 9999;
    animation: slideIn 0.3s ease;
}

.notification-success {
    background: #27ae60;
}

.notification-error {
    background: #e74c3c;
}

.notification-info {
    background: #3498db;
}

@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

/* Document Upload Styles */
.document-upload {
    border: 2px dashed #bdc3c7;
    padding: 15px;
    text-align: center;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.document-upload:hover {
    border-color: #3498db;
    background: #f8f9fa;
}

.document-upload i {
    font-size: 24px;
    color: #3498db;
    margin-bottom: 5px;
}

.document-upload p {
    margin: 0;
    color: #7f8c8d;
    font-size: 0.9rem;
}

/* Icon Button Styles */
.icon-btn {
    background: none;
    border: none;
    color: #3498db;
    cursor: pointer;
    padding: 5px 10px;
    margin: 0 2px;
    border-radius: 4px;
    transition: all 0.3s ease;
}

.icon-btn:hover {
    background: #f0f0f0;
    color: #2980b9;
}

.icon-btn .fa-trash {
    color: #e74c3c;
}

.icon-btn .fa-eye {
    color: #27ae60;
}
</style>

<script>
    let currentEditId = null;
    let demoTravelers = []; // Store demo travelers

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        console.log('‚úÖ Travelers page loaded');
        
        // Skip session check for demo mode - comment this out if you want to enforce login
        // For demo purposes, we'll allow access without login
        console.log('Demo mode: Session check bypassed');
        
        // Load travelers (will use demo data if API fails)
        loadTravelers();
        
        // Load batches for dropdowns
        loadBatchDropdowns();
        
        // Add form submit handlers
        const addForm = document.getElementById('travelerAddForm');
        if (addForm) {
            addForm.addEventListener('submit', createTraveler);
        }
        
        const editForm = document.getElementById('adminTravelerForm');
        if (editForm) {
            editForm.addEventListener('submit', updateTraveler);
        }
        
        // Add input listeners for passport name auto-fill
        setupPassportNameAutoFill();
    });

    // Setup passport name auto-fill
    function setupPassportNameAutoFill() {
        const addFirst = document.getElementById('add_first_name');
        const addLast = document.getElementById('add_last_name');
        const addPassport = document.getElementById('add_passport_name');
        
        if (addFirst && addLast && addPassport) {
            const updateAddPassport = () => {
                const first = addFirst.value || '';
                const last = addLast.value || '';
                addPassport.value = `${first} ${last}`.trim();
            };
            addFirst.addEventListener('input', updateAddPassport);
            addLast.addEventListener('input', updateAddPassport);
        }
        
        const editFirst = document.getElementById('edit_first_name');
        const editLast = document.getElementById('edit_last_name');
        const editPassport = document.getElementById('edit_passport_name');
        
        if (editFirst && editLast && editPassport) {
            const updateEditPassport = () => {
                const first = editFirst.value || '';
                const last = editLast.value || '';
                editPassport.value = `${first} ${last}`.trim();
            };
            editFirst.addEventListener('input', updateEditPassport);
            editLast.addEventListener('input', updateEditPassport);
        }
    }

    // ============ NOTIFICATION FUNCTION ============
    function showNotification(message, type = 'success') {
        console.log(`üîî Notification: ${message} (${type})`);
        
        // Remove existing notification if any
        const existing = document.querySelector('.notification');
        if (existing) existing.remove();
        
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        
        let icon = 'check-circle';
        if (type === 'error') icon = 'exclamation-circle';
        if (type === 'info') icon = 'info-circle';
        
        notification.innerHTML = `<i class="fas fa-${icon}"></i> ${message}`;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }

    // ============ ADD TRAVELER FORM FUNCTIONS ============
    function showAddTravelerForm() {
        console.log('üìù Show add traveler form');
        document.getElementById('addTravelerForm').style.display = 'block';
        loadBatchDropdowns(); // Refresh batches
        document.getElementById('addTravelerForm').scrollIntoView({ behavior: 'smooth' });
    }

    function hideAddTravelerForm() {
        console.log('üìù Hide add traveler form');
        document.getElementById('addTravelerForm').style.display = 'none';
        document.getElementById('travelerAddForm').reset();
        
        // Reset file upload texts
        document.getElementById('add_passport_scan_text').textContent = 'Click to upload';
        document.getElementById('add_aadhaar_scan_text').textContent = 'Click to upload';
        document.getElementById('add_pan_scan_text').textContent = 'Click to upload';
        document.getElementById('add_vaccine_scan_text').textContent = 'Click to upload';
    }

    // ============ EDIT TRAVELER FORM FUNCTIONS ============
    function hideEditForm() {
        console.log('üìù Hide edit traveler form');
        document.getElementById('editTravelerForm').style.display = 'none';
        currentEditId = null;
        
        // Reset file upload texts
        document.getElementById('edit_passport_scan_text').textContent = 'Click to upload';
        document.getElementById('edit_aadhaar_scan_text').textContent = 'Click to upload';
        document.getElementById('edit_pan_scan_text').textContent = 'Click to upload';
        document.getElementById('edit_vaccine_scan_text').textContent = 'Click to upload';
    }

    // ============ LOAD BATCH DROPDOWNS ============
    async function loadBatchDropdowns() {
        console.log('üì° Loading batches for dropdown...');
        
        // Demo batches
        const demoBatches = [
            { id: 1, batch_name: 'Haj Platinum 2026' },
            { id: 2, batch_name: 'Haj Gold 2026' },
            { id: 3, batch_name: 'Umrah Ramadhan Special' }
        ];
        
        try {
            const response = await fetch('/api/batches', {
                credentials: 'include',
                headers: { 'Accept': 'application/json' }
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.success && data.batches) {
                    updateBatchDropdowns(data.batches);
                    return;
                }
            }
            
            // Use demo batches if API fails
            console.log('Using demo batches for dropdown');
            updateBatchDropdowns(demoBatches);
            
        } catch (error) {
            console.log('Using demo batches due to error:', error);
            updateBatchDropdowns(demoBatches);
        }
    }
    
    function updateBatchDropdowns(batches) {
        const addSelect = document.getElementById('add_batch_id');
        const editSelect = document.getElementById('edit_batch_id');
        
        if (addSelect) {
            addSelect.innerHTML = '<option value="">Select Batch</option>';
            batches.forEach(b => {
                addSelect.innerHTML += `<option value="${b.id}">${b.batch_name}</option>`;
            });
        }
        
        if (editSelect) {
            editSelect.innerHTML = '<option value="">Select Batch</option>';
            batches.forEach(b => {
                editSelect.innerHTML += `<option value="${b.id}">${b.batch_name}</option>`;
            });
        }
    }

    // ============ LOAD TRAVELERS ============
    async function loadTravelers() {
        console.log('üì° Loading travelers...');
        const tableBody = document.getElementById('travelersTable');
        
        // Show loading
        tableBody.innerHTML = '<tr><td colspan="8" class="loading"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>';
        
        try {
            const response = await fetch('/api/travelers', {
                credentials: 'include',
                headers: { 'Accept': 'application/json' }
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.success && data.travelers && data.travelers.length > 0) {
                    displayTravelers(data.travelers);
                    return;
                }
            }
            
            // Use demo data if API fails or returns no data
            console.log('Using demo travelers data');
            useDemoTravelers();
            
        } catch (error) {
            console.log('Using demo travelers due to error:', error);
            useDemoTravelers();
        }
    }
    
    function useDemoTravelers() {
        demoTravelers = [
            { 
                id: 1, 
                first_name: 'Ahmed', 
                last_name: 'Khan', 
                passport_no: 'Z1234567', 
                mobile: '+91 98765 43210',
                batch_name: 'Haj Platinum 2026',
                passport_status: 'Active',
                pin: '1234',
                email: 'ahmed.khan@email.com',
                gender: 'Male',
                dob: '1985-06-15',
                aadhaar: '1234 5678 9012',
                pan: 'ABCDE1234F'
            },
            { 
                id: 2, 
                first_name: 'Fatima', 
                last_name: 'Begum', 
                passport_no: 'A7654321', 
                mobile: '+91 87654 32109',
                batch_name: 'Haj Gold 2026',
                passport_status: 'Submitted',
                pin: '5678',
                email: 'fatima.b@email.com',
                gender: 'Female',
                dob: '1990-11-22'
            },
            { 
                id: 3, 
                first_name: 'Mohammed', 
                last_name: 'Rafiq', 
                passport_no: 'B9876543', 
                mobile: '+91 76543 21098',
                batch_name: 'Umrah Ramadhan Special',
                passport_status: 'Processing',
                pin: '9012',
                email: 'm.rafiq@email.com',
                gender: 'Male',
                dob: '1978-03-08'
            }
        ];
        
        displayTravelers(demoTravelers);
    }

    function displayTravelers(travelers) {
        if (!travelers || travelers.length === 0) {
            document.getElementById('travelersTable').innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px;">No travelers found</td></tr>';
            return;
        }
        
        let html = '';
        travelers.forEach(t => {
            const fullName = `${t.first_name || ''} ${t.last_name || ''}`.trim() || 'N/A';
            const batchName = t.batch_name || 'Not Assigned';
            
            let statusClass = 'status-active';
            if (t.passport_status === 'Submitted') statusClass = 'status-pending';
            if (t.passport_status === 'Processing') statusClass = 'status-warning';
            if (t.passport_status === 'Expired') statusClass = 'status-closed';
            
            html += `<tr>
                <td>${t.id}</td>
                <td><strong>${escapeHtml(fullName)}</strong></td>
                <td>${escapeHtml(t.passport_no || '-')}</td>
                <td>${escapeHtml(t.mobile || '-')}</td>
                <td>${escapeHtml(batchName)}</td>
                <td><span class="status-badge ${statusClass}">${escapeHtml(t.passport_status || 'Active')}</span></td>
                <td>${escapeHtml(t.pin || '0000')}</td>
                <td>
                    <button class="icon-btn" onclick="viewTravelerDetails(${t.id})" title="View"><i class="fas fa-eye"></i></button>
                    <button class="icon-btn" onclick="editTraveler(${t.id})" title="Edit"><i class="fas fa-edit"></i></button>
                    <button class="icon-btn" onclick="deleteTraveler(${t.id})" title="Delete"><i class="fas fa-trash"></i></button>
                </td>
            </tr>`;
        });
        
        document.getElementById('travelersTable').innerHTML = html;
    }
    
    function escapeHtml(text) {
        if (!text) return text;
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // ============ CREATE TRAVELER ============
    async function createTraveler(e) {
        e.preventDefault();
        console.log('üìù Creating traveler');
        
        const travelerData = {
            first_name: document.getElementById('add_first_name').value,
            last_name: document.getElementById('add_last_name').value,
            passport_name: document.getElementById('add_passport_name').value || `${document.getElementById('add_first_name').value} ${document.getElementById('add_last_name').value}`.trim(),
            batch_id: document.getElementById('add_batch_id').value,
            passport_no: document.getElementById('add_passport_no').value,
            passport_issue_date: document.getElementById('add_passport_issue_date').value || null,
            passport_expiry_date: document.getElementById('add_passport_expiry_date').value || null,
            passport_status: document.getElementById('add_passport_status').value,
            gender: document.getElementById('add_gender').value || null,
            dob: document.getElementById('add_dob').value || null,
            mobile: document.getElementById('add_mobile').value,
            email: document.getElementById('add_email').value || null,
            aadhaar: document.getElementById('add_aadhaar').value || null,
            pan: document.getElementById('add_pan').value || null,
            aadhaar_pan_linked: document.getElementById('add_aadhaar_pan_linked').value,
            vaccine_status: document.getElementById('add_vaccine_status').value,
            wheelchair: document.getElementById('add_wheelchair').value,
            place_of_birth: document.getElementById('add_place_of_birth').value || null,
            place_of_issue: document.getElementById('add_place_of_issue').value || null,
            passport_address: document.getElementById('add_passport_address').value || null,
            father_name: document.getElementById('add_father_name').value || null,
            mother_name: document.getElementById('add_mother_name').value || null,
            spouse_name: document.getElementById('add_spouse_name').value || null,
            extra_fields: document.getElementById('add_extra_fields').value || '{}',
            pin: document.getElementById('add_pin').value || '0000'
        };
        
        // Validate required fields
        if (!travelerData.first_name || !travelerData.last_name || !travelerData.passport_no || !travelerData.mobile) {
            showNotification('Please fill all required fields (*)', 'error');
            return;
        }
        
        if (!travelerData.batch_id) {
            showNotification('Please select a batch', 'error');
            return;
        }
        
        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
        submitBtn.disabled = true;
        
        try {
            const response = await fetch('/api/travelers', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(travelerData)
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    showNotification('Traveler created successfully!', 'success');
                    hideAddTravelerForm();
                    loadTravelers();
                    return;
                }
            }
            
            // Demo mode - simulate success
            showNotification('Demo mode: Traveler created successfully!', 'success');
            hideAddTravelerForm();
            
            // Add to demo data
            const newId = Math.max(...demoTravelers.map(t => t.id), 0) + 1;
            const batchName = document.querySelector('#add_batch_id option:checked')?.textContent || 'Selected Batch';
            
            demoTravelers.push({
                id: newId,
                ...travelerData,
                batch_name: batchName,
                created_at: new Date().toISOString()
            });
            
            displayTravelers(demoTravelers);
            
        } catch (error) {
            console.error('Error creating traveler:', error);
            
            // Demo mode on network error
            showNotification('Demo mode: Traveler created (offline)', 'info');
            hideAddTravelerForm();
            
            const newId = demoTravelers.length + 1;
            const batchName = document.querySelector('#add_batch_id option:checked')?.textContent || 'Selected Batch';
            
            demoTravelers.push({
                id: newId,
                ...travelerData,
                batch_name: batchName
            });
            
            displayTravelers(demoTravelers);
            
        } finally {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    }

    // ============ EDIT TRAVELER ============
    async function editTraveler(id) {
        console.log(`üìù Editing traveler ID: ${id}`);
        
        // Try to find in demo data first
        const traveler = demoTravelers.find(t => t.id === id);
        
        if (traveler) {
            console.log('Found traveler in demo data:', traveler);
            populateEditForm(traveler);
            return;
        }
        
        // If not in demo, try API
        try {
            const response = await fetch(`/api/travelers/${id}`, {
                credentials: 'include'
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    populateEditForm(data.traveler);
                    return;
                }
            }
            
            showNotification('Could not load traveler details', 'error');
            
        } catch (error) {
            console.error('Error loading traveler:', error);
            showNotification('Error loading traveler details', 'error');
        }
    }
    
    function populateEditForm(t) {
        document.getElementById('edit_traveler_id').value = t.id;
        document.getElementById('edit_first_name').value = t.first_name || '';
        document.getElementById('edit_last_name').value = t.last_name || '';
        document.getElementById('edit_passport_name').value = t.passport_name || `${t.first_name || ''} ${t.last_name || ''}`.trim();
        document.getElementById('edit_batch_id').value = t.batch_id || '';
        document.getElementById('edit_passport_no').value = t.passport_no || '';
        document.getElementById('edit_passport_issue_date').value = t.passport_issue_date || '';
        document.getElementById('edit_passport_expiry_date').value = t.passport_expiry_date || '';
        document.getElementById('edit_passport_status').value = t.passport_status || 'Active';
        document.getElementById('edit_gender').value = t.gender || '';
        document.getElementById('edit_dob').value = t.dob || '';
        document.getElementById('edit_mobile').value = t.mobile || '';
        document.getElementById('edit_email').value = t.email || '';
        document.getElementById('edit_aadhaar').value = t.aadhaar || '';
        document.getElementById('edit_pan').value = t.pan || '';
        document.getElementById('edit_aadhaar_pan_linked').value = t.aadhaar_pan_linked || 'No';
        document.getElementById('edit_vaccine_status').value = t.vaccine_status || 'Not Vaccinated';
        document.getElementById('edit_wheelchair').value = t.wheelchair || 'No';
        document.getElementById('edit_place_of_birth').value = t.place_of_birth || '';
        document.getElementById('edit_place_of_issue').value = t.place_of_issue || '';
        document.getElementById('edit_passport_address').value = t.passport_address || '';
        document.getElementById('edit_father_name').value = t.father_name || '';
        document.getElementById('edit_mother_name').value = t.mother_name || '';
        document.getElementById('edit_spouse_name').value = t.spouse_name || '';
        
        let extraFields = t.extra_fields;
        if (typeof extraFields === 'string') {
            try {
                extraFields = JSON.parse(extraFields);
            } catch (e) {
                extraFields = {};
            }
        }
        document.getElementById('edit_extra_fields').value = JSON.stringify(extraFields || {}, null, 2);
        document.getElementById('edit_pin').value = t.pin || '0000';
        
        document.getElementById('editTravelerForm').style.display = 'block';
        currentEditId = t.id;
        document.getElementById('editTravelerForm').scrollIntoView({ behavior: 'smooth' });
    }

    // ============ UPDATE TRAVELER ============
    async function updateTraveler(e) {
        e.preventDefault();
        
        if (!currentEditId) {
            showNotification('No traveler selected for editing', 'error');
            return;
        }
        
        const travelerData = {
            first_name: document.getElementById('edit_first_name').value,
            last_name: document.getElementById('edit_last_name').value,
            passport_name: document.getElementById('edit_passport_name').value,
            batch_id: document.getElementById('edit_batch_id').value || null,
            passport_no: document.getElementById('edit_passport_no').value,
            passport_issue_date: document.getElementById('edit_passport_issue_date').value || null,
            passport_expiry_date: document.getElementById('edit_passport_expiry_date').value || null,
            passport_status: document.getElementById('edit_passport_status').value,
            gender: document.getElementById('edit_gender').value || null,
            dob: document.getElementById('edit_dob').value || null,
            mobile: document.getElementById('edit_mobile').value,
            email: document.getElementById('edit_email').value || null,
            aadhaar: document.getElementById('edit_aadhaar').value || null,
            pan: document.getElementById('edit_pan').value || null,
            aadhaar_pan_linked: document.getElementById('edit_aadhaar_pan_linked').value,
            vaccine_status: document.getElementById('edit_vaccine_status').value,
            wheelchair: document.getElementById('edit_wheelchair').value,
            place_of_birth: document.getElementById('edit_place_of_birth').value || null,
            place_of_issue: document.getElementById('edit_place_of_issue').value || null,
            passport_address: document.getElementById('edit_passport_address').value || null,
            father_name: document.getElementById('edit_father_name').value || null,
            mother_name: document.getElementById('edit_mother_name').value || null,
            spouse_name: document.getElementById('edit_spouse_name').value || null,
            extra_fields: document.getElementById('edit_extra_fields').value || '{}',
            pin: document.getElementById('edit_pin').value || '0000'
        };
        
        // Validate JSON
        try {
            JSON.parse(travelerData.extra_fields);
        } catch (e) {
            showNotification('Invalid JSON in Extra Fields', 'error');
            return;
        }
        
        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
        submitBtn.disabled = true;
        
        try {
            const response = await fetch(`/api/travelers/${currentEditId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(travelerData)
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    showNotification('Traveler updated successfully!', 'success');
                    hideEditForm();
                    loadTravelers();
                    return;
                }
            }
            
            // Demo mode - update in demoTravelers
            const index = demoTravelers.findIndex(t => t.id === currentEditId);
            if (index !== -1) {
                const batchName = document.querySelector('#edit_batch_id option:checked')?.textContent || demoTravelers[index].batch_name;
                demoTravelers[index] = { 
                    ...demoTravelers[index], 
                    ...travelerData,
                    batch_name: batchName
                };
                showNotification('Demo mode: Traveler updated', 'info');
                hideEditForm();
                displayTravelers(demoTravelers);
            }
            
        } catch (error) {
            console.error('Error updating traveler:', error);
            
            // Update in demoTravelers anyway
            const index = demoTravelers.findIndex(t => t.id === currentEditId);
            if (index !== -1) {
                const batchName = document.querySelector('#edit_batch_id option:checked')?.textContent || demoTravelers[index].batch_name;
                demoTravelers[index] = { 
                    ...demoTravelers[index], 
                    ...travelerData,
                    batch_name: batchName
                };
                showNotification('Demo mode: Traveler updated (offline)', 'info');
                hideEditForm();
                displayTravelers(demoTravelers);
            } else {
                showNotification('Error updating traveler', 'error');
            }
            
        } finally {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    }

    // ============ DELETE TRAVELER ============
    async function deleteTraveler(id) {
        console.log(`üóëÔ∏è Deleting traveler ID: ${id}`);
        
        if (!confirm('‚ö†Ô∏è Are you sure you want to delete this traveler? This action cannot be undone.')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/travelers/${id}`, {
                method: 'DELETE',
                credentials: 'include'
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    showNotification('Traveler deleted successfully!', 'success');
                    loadTravelers();
                    return;
                }
            }
            
            // Demo mode - remove from demoTravelers
            demoTravelers = demoTravelers.filter(t => t.id !== id);
            showNotification('Demo mode: Traveler deleted', 'info');
            displayTravelers(demoTravelers);
            
        } catch (error) {
            console.error('Error deleting traveler:', error);
            
            // Demo mode - remove from demoTravelers
            demoTravelers = demoTravelers.filter(t => t.id !== id);
            showNotification('Demo mode: Traveler deleted (offline)', 'info');
            displayTravelers(demoTravelers);
        }
    }

    // ============ VIEW TRAVELER DETAILS ============
    function viewTravelerDetails(id) {
        console.log(`üëÅÔ∏è Viewing traveler ID: ${id}`);
        
        // Try to find in demo data
        const traveler = demoTravelers.find(t => t.id === id);
        
        if (traveler) {
            showTravelerDetails(traveler);
            return;
        }
        
        // If not in demo, try API
        fetch(`/api/travelers/${id}`, { credentials: 'include' })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showTravelerDetails(data.traveler);
                } else {
                    showNotification('Error loading traveler details', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error loading traveler details', 'error');
            });
    }
    
    function showTravelerDetails(t) {
        const formatDate = (date) => date ? new Date(date).toLocaleDateString() : 'Not specified';
        const formatValue = (val) => val && val !== '' ? val : 'Not specified';
        
        let extraFieldsHtml = '';
        if (t.extra_fields) {
            try {
                const extra = typeof t.extra_fields === 'string' ? JSON.parse(t.extra_fields) : t.extra_fields;
                extraFieldsHtml = `<pre style="background: #f5f5f5; padding: 10px; border-radius: 4px; margin: 0;">${JSON.stringify(extra, null, 2)}</pre>`;
            } catch (e) {
                extraFieldsHtml = `<p>${formatValue(t.extra_fields)}</p>`;
            }
        }
        
        let html = `
            <div style="max-height: 70vh; overflow-y: auto; padding: 10px;">
                <h4 style="color: #3498db; margin: 15px 0 10px;">üìã Personal Information</h4>
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                    <tr><td style="padding: 8px; border: 1px solid #ddd; background: #f8f9fa; width: 200px;"><strong>Full Name:</strong></td><td style="padding: 8px; border: 1px solid #ddd;">${formatValue(t.first_name)} ${formatValue(t.last_name)}</td></tr>
                    <tr><td style="padding: 8px; border: 1px solid #ddd; background: #f8f9fa;"><strong>Passport Name:</strong></td><td style="padding: 8px; border: 1px solid #ddd;">${formatValue(t.passport_name)}</td></tr>
                    <tr><td style="padding: 8px; border: 1px solid #ddd; background: #f8f9fa;"><strong>Batch:</strong></td><td style="padding: 8px; border: 1px solid #ddd;">${formatValue(t.batch_name)}</td></tr>
                    <tr><td style="padding: 8px; border: 1px solid #ddd; background: #f8f9fa;"><strong>Passport Number:</strong></td><td style="padding: 8px; border: 1px solid #ddd;">${formatValue(t.passport_no)}</td></tr>
                    <tr><td style="padding: 8px; border: 1px solid #ddd; background: #f8f9fa;"><strong>Passport Issue Date:</strong></td><td style="padding: 8px; border: 1px solid #ddd;">${formatDate(t.passport_issue_date)}</td></tr>
                    <tr><td style="padding: 8px; border: 1px solid #ddd; background: #f8f9fa;"><strong>Passport Expiry Date:</strong></td><td style="padding: 8px; border: 1px solid #ddd;">${formatDate(t.passport_expiry_date)}</td></tr>
                    <tr><td style="padding: 8px; border: 1px solid #ddd; background: #f8f9fa;"><strong>Passport Status:</strong></td><td style="padding: 8px; border: 1px solid #ddd;"><span class="status-badge status-active">${formatValue(t.passport_status)}</span></td></tr>
                    <tr><td style="padding: 8px; border: 1px solid #ddd; background: #f8f9fa;"><strong>Gender:</strong></td><td style="padding: 8px; border: 1px solid #ddd;">${formatValue(t.gender)}</td></tr>
                    <tr><td style="padding: 8px; border: 1px solid #ddd; background: #f8f9fa;"><strong>Date of Birth:</strong></td><td style="padding: 8px; border: 1px solid #ddd;">${formatDate(t.dob)}</td></tr>
                </table>
                
                <h4 style="color: #3498db; margin: 15px 0 10px;">üìû Contact Information</h4>
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                    <tr><td style="padding: 8px; border: 1px solid #ddd; background: #f8f9fa;"><strong>Mobile Number:</strong></td><td style="padding: 8px; border: 1px solid #ddd;">${formatValue(t.mobile)}</td></tr>
                    <tr><td style="padding: 8px; border: 1px solid #ddd; background: #f8f9fa;"><strong>Email:</strong></td><td style="padding: 8px; border: 1px solid #ddd;">${formatValue(t.email)}</td></tr>
                    <tr><td style="padding: 8px; border: 1px solid #ddd; background: #f8f9fa;"><strong>Aadhaar Number:</strong></td><td style="padding: 8px; border: 1px solid #ddd;">${formatValue(t.aadhaar)}</td></tr>
                    <tr><td style="padding: 8px; border: 1px solid #ddd; background: #f8f9fa;"><strong>PAN Number:</strong></td><td style="padding: 8px; border: 1px solid #ddd;">${formatValue(t.pan)}</td></tr>
                    <tr><td style="padding: 8px; border: 1px solid #ddd; background: #f8f9fa;"><strong>Aadhaar-PAN Linked:</strong></td><td style="padding: 8px; border: 1px solid #ddd;">${formatValue(t.aadhaar_pan_linked)}</td></tr>
                    <tr><td style="padding: 8px; border: 1px solid #ddd; background: #f8f9fa;"><strong>Vaccine Status:</strong></td><td style="padding: 8px; border: 1px solid #ddd;">${formatValue(t.vaccine_status)}</td></tr>
                    <tr><td style="padding: 8px; border: 1px solid #ddd; background: #f8f9fa;"><strong>Wheelchair Required:</strong></td><td style="padding: 8px; border: 1px solid #ddd;">${formatValue(t.wheelchair)}</td></tr>
                </table>
                
                <h4 style="color: #3498db; margin: 15px 0 10px;">üè† Address & Family</h4>
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                    <tr><td style="padding: 8px; border: 1px solid #ddd; background: #f8f9fa;"><strong>Place of Birth:</strong></td><td style="padding: 8px; border: 1px solid #ddd;">${formatValue(t.place_of_birth)}</td></tr>
                    <tr><td style="padding: 8px; border: 1px solid #ddd; background: #f8f9fa;"><strong>Place of Issue:</strong></td><td style="padding: 8px; border: 1px solid #ddd;">${formatValue(t.place_of_issue)}</td></tr>
                    <tr><td style="padding: 8px; border: 1px solid #ddd; background: #f8f9fa;"><strong>Passport Address:</strong></td><td style="padding: 8px; border: 1px solid #ddd;">${formatValue(t.passport_address)}</td></tr>
                    <tr><td style="padding: 8px; border: 1px solid #ddd; background: #f8f9fa;"><strong>Father's Name:</strong></td><td style="padding: 8px; border: 1px solid #ddd;">${formatValue(t.father_name)}</td></tr>
                    <tr><td style="padding: 8px; border: 1px solid #ddd; background: #f8f9fa;"><strong>Mother's Name:</strong></td><td style="padding: 8px; border: 1px solid #ddd;">${formatValue(t.mother_name)}</td></tr>
                    <tr><td style="padding: 8px; border: 1px solid #ddd; background: #f8f9fa;"><strong>Spouse's Name:</strong></td><td style="padding: 8px; border: 1px solid #ddd;">${formatValue(t.spouse_name)}</td></tr>
                </table>
                
                <h4 style="color: #3498db; margin: 15px 0 10px;">üìé Documents</h4>
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                    <tr><td style="padding: 8px; border: 1px solid #ddd; background: #f8f9fa;"><strong>Passport Scan:</strong></td><td style="padding: 8px; border: 1px solid #ddd;">${t.passport_scan ? `<a href="/uploads/${t.passport_scan}" target="_blank">View Document</a>` : 'Not uploaded'}</td></tr>
                    <tr><td style="padding: 8px; border: 1px solid #ddd; background: #f8f9fa;"><strong>Aadhaar Scan:</strong></td><td style="padding: 8px; border: 1px solid #ddd;">${t.aadhaar_scan ? `<a href="/uploads/${t.aadhaar_scan}" target="_blank">View Document</a>` : 'Not uploaded'}</td></tr>
                    <tr><td style="padding: 8px; border: 1px solid #ddd; background: #f8f9fa;"><strong>PAN Scan:</strong></td><td style="padding: 8px; border: 1px solid #ddd;">${t.pan_scan ? `<a href="/uploads/${t.pan_scan}" target="_blank">View Document</a>` : 'Not uploaded'}</td></tr>
                    <tr><td style="padding: 8px; border: 1px solid #ddd; background: #f8f9fa;"><strong>Vaccine Certificate:</strong></td><td style="padding: 8px; border: 1px solid #ddd;">${t.vaccine_scan ? `<a href="/uploads/${t.vaccine_scan}" target="_blank">View Document</a>` : 'Not uploaded'}</td></tr>
                </table>
                
                <h4 style="color: #3498db; margin: 15px 0 10px;">üîê Additional Information</h4>
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                    <tr><td style="padding: 8px; border: 1px solid #ddd; background: #f8f9fa;"><strong>PIN:</strong></td><td style="padding: 8px; border: 1px solid #ddd;">${formatValue(t.pin)}</td></tr>
                    <tr><td style="padding: 8px; border: 1px solid #ddd; background: #f8f9fa;"><strong>Extra Fields:</strong></td><td style="padding: 8px; border: 1px solid #ddd;">${extraFieldsHtml}</td></tr>
                    <tr><td style="padding: 8px; border: 1px solid #ddd; background: #f8f9fa;"><strong>Created At:</strong></td><td style="padding: 8px; border: 1px solid #ddd;">${t.created_at ? new Date(t.created_at).toLocaleString() : 'N/A'}</td></tr>
                </table>
            </div>
        `;
        
        document.getElementById('travelerDetails').innerHTML = html;
        document.getElementById('travelerModal').style.display = 'block';
        document.getElementById('modalOverlay').style.display = 'block';
    }

    // ============ CLOSE MODAL ============
    function closeTravelerModal() {
        console.log('üîí Closing modal');
        document.getElementById('travelerModal').style.display = 'none';
        document.getElementById('modalOverlay').style.display = 'none';
    }

    // ============ PRINT TRAVELER DETAILS ============
    function printTravelerDetails() {
        console.log('üñ®Ô∏è Printing traveler details');
        const content = document.getElementById('travelerDetails')?.innerHTML;
        if (!content) return;
        
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <html>
            <head>
                <title>Traveler Details</title>
                <style>
                    body { font-family: Arial, sans-serif; padding: 20px; }
                    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                    td { padding: 8px; border: 1px solid #ddd; }
                    .status-badge { padding: 4px 8px; border-radius: 4px; }
                    h4 { color: #3498db; margin: 15px 0 10px; }
                </style>
            </head>
            <body>${content}</body>
            </html>
        `);
        printWindow.document.close();
        printWindow.print();
    }

    // ============ SEARCH TRAVELERS ============
    function searchTravelers() {
        const search = document.getElementById('searchTravelers').value.toLowerCase().trim();
        const rows = document.querySelectorAll('#travelersTable tr');
        
        if (rows.length === 1 && rows[0].textContent.includes('No travelers')) {
            return; // No data to search
        }
        
        rows.forEach(row => {
            if (row.cells && row.cells.length > 1) {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            }
        });
    }

    // ============ DOCUMENT UPLOAD HANDLERS ============
    document.getElementById('add_passport_scan')?.addEventListener('change', function(e) {
        document.getElementById('add_passport_scan_text').textContent = e.target.files[0]?.name || 'Click to upload';
    });
    
    document.getElementById('add_aadhaar_scan')?.addEventListener('change', function(e) {
        document.getElementById('add_aadhaar_scan_text').textContent = e.target.files[0]?.name || 'Click to upload';
    });
    
    document.getElementById('add_pan_scan')?.addEventListener('change', function(e) {
        document.getElementById('add_pan_scan_text').textContent = e.target.files[0]?.name || 'Click to upload';
    });
    
    document.getElementById('add_vaccine_scan')?.addEventListener('change', function(e) {
        document.getElementById('add_vaccine_scan_text').textContent = e.target.files[0]?.name || 'Click to upload';
    });
    
    document.getElementById('edit_passport_scan')?.addEventListener('change', function(e) {
        document.getElementById('edit_passport_scan_text').textContent = e.target.files[0]?.name || 'Click to upload';
    });
    
    document.getElementById('edit_aadhaar_scan')?.addEventListener('change', function(e) {
        document.getElementById('edit_aadhaar_scan_text').textContent = e.target.files[0]?.name || 'Click to upload';
    });
    
    document.getElementById('edit_pan_scan')?.addEventListener('change', function(e) {
        document.getElementById('edit_pan_scan_text').textContent = e.target.files[0]?.name || 'Click to upload';
    });
    
    document.getElementById('edit_vaccine_scan')?.addEventListener('change', function(e) {
        document.getElementById('edit_vaccine_scan_text').textContent = e.target.files[0]?.name || 'Click to upload';
    });
</script>
