<div class="action-buttons">
    <button class="action-btn btn-primary" onclick="showCreateBatchForm()">
        <i class="fas fa-plus"></i> Create New Batch
    </button>
</div>

<!-- CREATE BATCH FORM -->
<div class="form-container" id="createBatchForm" style="display: none;">
    <h3><i class="fas fa-plus-circle"></i> Create New Haj/Umrah Package</h3>
    <form id="batchCreateForm">
        <div class="form-grid">
            <div class="form-group">
                <label for="batch_name"><i class="fas fa-tag"></i> Batch Name *</label>
                <input type="text" id="batch_name" required placeholder="e.g., Haj Silver 2026">
            </div>
            <div class="form-group">
                <label for="total_seats"><i class="fas fa-chair"></i> Total Seats</label>
                <input type="number" id="total_seats" value="150" min="1">
            </div>
            <div class="form-group">
                <label for="price"><i class="fas fa-rupee-sign"></i> Price (‚Çπ)</label>
                <input type="number" id="price" step="1" placeholder="58555">
            </div>
            <div class="form-group">
                <label for="departure_date"><i class="fas fa-plane-departure"></i> Departure Date</label>
                <input type="date" id="departure_date">
            </div>
            <div class="form-group">
                <label for="return_date"><i class="fas fa-plane-arrival"></i> Return Date</label>
                <input type="date" id="return_date">
            </div>
            <div class="form-group">
                <label for="status"><i class="fas fa-info-circle"></i> Status</label>
                <select id="status">
                    <option value="Open">Open</option>
                    <option value="Closing Soon">Closing Soon</option>
                    <option value="Full">Full</option>
                    <option value="Closed">Closed</option>
                </select>
            </div>
            <div class="form-group full-width">
                <label for="description"><i class="fas fa-align-left"></i> Description</label>
                <textarea id="description" rows="3" placeholder="Package details..."></textarea>
            </div>
        </div>
        <div class="form-actions">
            <button type="submit" class="action-btn btn-primary"><i class="fas fa-save"></i> Create Batch</button>
            <button type="button" class="action-btn btn-secondary" onclick="hideCreateBatchForm()"><i class="fas fa-times"></i> Cancel</button>
        </div>
    </form>
</div>

<!-- EDIT BATCH FORM -->
<div class="form-container" id="editBatchForm" style="display: none;">
    <h3><i class="fas fa-edit"></i> Edit Batch</h3>
    <form id="batchEditForm" onsubmit="event.preventDefault(); updateBatch();">
        <input type="hidden" id="edit_batch_id">
        <div class="form-grid">
            <div class="form-group">
                <label for="edit_batch_name">Batch Name *</label>
                <input type="text" id="edit_batch_name" required>
            </div>
            <div class="form-group">
                <label for="edit_departure_date">Departure Date</label>
                <input type="date" id="edit_departure_date">
            </div>
            <div class="form-group">
                <label for="edit_return_date">Return Date</label>
                <input type="date" id="edit_return_date">
            </div>
            <div class="form-group">
                <label for="edit_price">Price (‚Çπ)</label>
                <input type="number" id="edit_price" step="1">
            </div>
            <div class="form-group">
                <label for="edit_total_seats">Total Seats</label>
                <input type="number" id="edit_total_seats">
            </div>
            <div class="form-group">
                <label for="edit_status">Status</label>
                <select id="edit_status">
                    <option value="Open">Open</option>
                    <option value="Closing Soon">Closing Soon</option>
                    <option value="Full">Full</option>
                    <option value="Closed">Closed</option>
                </select>
            </div>
        </div>
        <div class="form-actions">
            <button type="submit" class="action-btn btn-primary"><i class="fas fa-save"></i> Update Batch</button>
            <button type="button" class="action-btn btn-secondary" onclick="hideEditBatchForm()"><i class="fas fa-times"></i> Cancel</button>
        </div>
    </form>
</div>

<!-- SEARCH -->
<div class="search-box">
    <input type="text" id="searchBatches" placeholder="Search batches...">
    <button class="action-btn btn-primary" onclick="searchBatches()">
        <i class="fas fa-search"></i> Search
    </button>
</div>

<!-- BATCHES TABLE -->
<div class="table-container">
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Package Name</th>
                <th>Departure</th>
                <th>Return</th>
                <th>Price</th>
                <th>Seats</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="batchesTable">
            <tr><td colspan="8" class="loading"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>
        </tbody>
    </table>
</div>

<style>
.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 25px;
    border-radius: 5px;
    color: white;
    z-index: 9999;
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

.notification-success { background: #27ae60; }
.notification-error { background: #e74c3c; }
.notification-info { background: #3498db; }
</style>

<script>
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        console.log('‚úÖ Batches page loaded');
        loadBatches();
    });

    // ============ NOTIFICATION FUNCTION ============
    function showNotification(message, type) {
        console.log(`üîî ${type}: ${message}`);
        
        // Remove any existing notification
        const existing = document.querySelector('.notification');
        if (existing) existing.remove();
        
        // Create new notification
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i> ${message}`;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }

    // ============ BATCH FORM FUNCTIONS ============
    function showCreateBatchForm() {
        document.getElementById('createBatchForm').style.display = 'block';
        document.getElementById('createBatchForm').scrollIntoView({ behavior: 'smooth' });
    }

    function hideCreateBatchForm() {
        document.getElementById('createBatchForm').style.display = 'none';
        document.getElementById('batchCreateForm').reset();
    }

    function hideEditBatchForm() {
        document.getElementById('editBatchForm').style.display = 'none';
    }

    // ============ LOAD BATCHES ============
    async function loadBatches() {
        console.log('üì° Loading batches...');
        const tableBody = document.getElementById('batchesTable');
        
        try {
            const response = await fetch('/api/batches/', {
                credentials: 'include'
            });
            
            console.log('Batches API response status:', response.status);
            
            if (response.ok) {
                const data = await response.json();
                console.log('Batches data received:', data);
                
                if (data.success && data.batches && data.batches.length > 0) {
                    console.log(`‚úÖ Found ${data.batches.length} batches`);
                    displayBatches(data.batches);
                    return;
                } else {
                    console.log('‚ö†Ô∏è No batches found in database');
                    tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px;">No batches found</td></tr>';
                }
            } else if (response.status === 401) {
                showNotification('Session expired. Please login again', 'error');
                setTimeout(() => {
                    window.location.href = '/admin.login.html';
                }, 2000);
            } else {
                console.log('‚ùå Failed to load batches, using demo data');
                useDemoBatches();
            }
        } catch (error) {
            console.error('‚ùå Error loading batches:', error);
            useDemoBatches();
        }
    }
    
    // ============ USE DEMO BATCHES (FALLBACK) ============
    function useDemoBatches() {
        console.log('üìã Using demo batch data');
        const demoBatches = [
            { id: 1, batch_name: 'Haj Platinum 2026', departure_date: '2026-06-14', return_date: '2026-07-31', price: 850000, booked_seats: 45, total_seats: 50, status: 'Open' },
            { id: 2, batch_name: 'Haj Gold 2026', departure_date: '2026-06-15', return_date: '2026-07-30', price: 550000, booked_seats: 82, total_seats: 100, status: 'Open' },
            { id: 3, batch_name: 'Umrah Ramadhan Special', departure_date: '2026-03-01', return_date: '2026-03-20', price: 125000, booked_seats: 170, total_seats: 200, status: 'Closing Soon' }
        ];
        displayBatches(demoBatches);
    }
    
    // ============ DISPLAY BATCHES ============
    function displayBatches(batches) {
        console.log('üìã Displaying batches...');
        let html = '';
        batches.forEach(b => {
            const price = b.price ? parseFloat(b.price).toLocaleString('en-IN', {maximumFractionDigits: 0}) : '0';
            const statusClass = b.status === 'Open' ? 'status-active' : 
                               (b.status === 'Closing Soon' ? 'status-pending' : 
                               (b.status === 'Full' ? 'status-inactive' : 'status-inactive'));
            
            html += `<tr>
                <td>${b.id}</td>
                <td><strong>${b.batch_name}</strong></td>
                <td>${b.departure_date || 'TBD'}</td>
                <td>${b.return_date || 'TBD'}</td>
                <td>‚Çπ${price}</td>
                <td>${b.booked_seats || 0}/${b.total_seats || 150}</td>
                <td><span class="status-badge ${statusClass}">${b.status || 'Open'}</span></td>
                <td>
                    <button class="icon-btn" onclick="editBatch(${b.id})" title="Edit"><i class="fas fa-edit"></i></button>
                    <button class="icon-btn" onclick="deleteBatch(${b.id})" title="Delete"><i class="fas fa-trash"></i></button>
                </td>
            </tr>`;
        });
        document.getElementById('batchesTable').innerHTML = html;
        console.log('‚úÖ Batches displayed');
        
        // Update batch dropdowns if they exist (for travelers page)
        const addSelect = document.getElementById('add_batch_id');
        if (addSelect) {
            addSelect.innerHTML = '<option value="">Select Batch</option>';
            batches.forEach(b => {
                addSelect.innerHTML += `<option value="${b.id}">${b.batch_name}</option>`;
            });
        }
        
        const editSelect = document.getElementById('edit_batch_id');
        if (editSelect) {
            editSelect.innerHTML = '<option value="">Select Batch</option>';
            batches.forEach(b => {
                editSelect.innerHTML += `<option value="${b.id}">${b.batch_name}</option>`;
            });
        }
    }

    // ============ EDIT BATCH ============
    function editBatch(id) {
        console.log(`üìù Editing batch ID: ${id}`);
        const rows = document.querySelectorAll('#batchesTable tr');
        let batchData = null;
        
        for (let row of rows) {
            if (row.cells && row.cells[0] && row.cells[0].innerText == id) {
                // Parse price - remove ‚Çπ and commas
                const priceText = row.cells[4].innerText.replace('‚Çπ', '').replace(/,/g, '');
                // Parse seats - get total from "X/Y" format
                const seatsText = row.cells[5].innerText.split('/')[1];
                
                batchData = {
                    id: id,
                    name: row.cells[1].innerText,
                    departure: row.cells[2].innerText,
                    return: row.cells[3].innerText,
                    price: priceText,
                    seats: seatsText,
                    status: row.cells[6].innerText
                };
                break;
            }
        }
        
        if (!batchData) {
            showNotification('Could not find batch data', 'error');
            return;
        }
        
        console.log('Batch data for edit:', batchData);
        
        document.getElementById('edit_batch_id').value = batchData.id;
        document.getElementById('edit_batch_name').value = batchData.name;
        document.getElementById('edit_departure_date').value = batchData.departure !== 'TBD' ? batchData.departure : '';
        document.getElementById('edit_return_date').value = batchData.return !== 'TBD' ? batchData.return : '';
        document.getElementById('edit_price').value = batchData.price;
        document.getElementById('edit_total_seats').value = batchData.seats;
        document.getElementById('edit_status').value = batchData.status;
        
        document.getElementById('editBatchForm').style.display = 'block';
        document.getElementById('editBatchForm').scrollIntoView({ behavior: 'smooth' });
    }

    // ============ UPDATE BATCH ============
    async function updateBatch() {
        console.log('üìù Updating batch...');
        const batchId = document.getElementById('edit_batch_id').value;
        const batchName = document.getElementById('edit_batch_name').value.trim();
        
        if (!batchName) {
            showNotification('Batch name is required', 'error');
            return;
        }
        
        const batchData = {
            batch_name: batchName,
            departure_date: document.getElementById('edit_departure_date').value || null,
            return_date: document.getElementById('edit_return_date').value || null,
            price: document.getElementById('edit_price').value ? parseFloat(document.getElementById('edit_price').value) : null,
            total_seats: document.getElementById('edit_total_seats').value ? parseInt(document.getElementById('edit_total_seats').value) : 150,
            status: document.getElementById('edit_status').value
        };
        
        console.log('Update data:', batchData);
        
        const updateBtn = document.querySelector('#batchEditForm button[type="submit"]');
        const originalText = updateBtn.innerHTML;
        updateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
        updateBtn.disabled = true;
        
        try {
            const response = await fetch(`/api/batches/${batchId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(batchData)
            });
            
            console.log('Update API response status:', response.status);
            
            if (response.status === 401) {
                showNotification('Session expired. Please login again', 'error');
                setTimeout(() => {
                    window.location.href = '/admin.login.html';
                }, 2000);
                return;
            }
            
            const data = await response.json();
            console.log('Update API response:', data);
            
            if (data.success) {
                showNotification('Batch updated successfully!', 'success');
                hideEditBatchForm();
                loadBatches();
            } else {
                showNotification('Error: ' + (data.error || 'Update failed'), 'error');
            }
        } catch (error) {
            console.error('‚ùå Error updating batch:', error);
            showNotification('Error updating batch', 'error');
        } finally {
            updateBtn.innerHTML = originalText;
            updateBtn.disabled = false;
        }
    }

    // ============ DELETE BATCH ============
    async function deleteBatch(id) {
        console.log(`üóëÔ∏è Deleting batch ID: ${id}`);
        if (!confirm('‚ö†Ô∏è Are you sure you want to delete this batch? This action cannot be undone.')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/batches/${id}`, {
                method: 'DELETE',
                credentials: 'include'
            });
            
            console.log('Delete API response status:', response.status);
            
            if (response.status === 401) {
                showNotification('Session expired. Please login again', 'error');
                setTimeout(() => {
                    window.location.href = '/admin.login.html';
                }, 2000);
                return;
            }
            
            const data = await response.json();
            console.log('Delete API response:', data);
            
            if (data.success) {
                showNotification('Batch deleted successfully!', 'success');
                loadBatches();
            } else {
                showNotification('Error: ' + (data.error || 'Could not delete batch'), 'error');
            }
        } catch (error) {
            console.error('‚ùå Error deleting batch:', error);
            showNotification('Error deleting batch', 'error');
        }
    }

    // ============ CREATE BATCH ============
    document.getElementById('batchCreateForm')?.addEventListener('submit', async function(e) {
        e.preventDefault();
        console.log('üìù Creating new batch...');
        
        const priceInput = document.getElementById('price').value;
        let price = null;
        
        if (priceInput) {
            price = parseFloat(priceInput);
        }
        
        const batchData = {
            batch_name: document.getElementById('batch_name').value,
            total_seats: parseInt(document.getElementById('total_seats').value) || 150,
            price: price,
            departure_date: document.getElementById('departure_date').value || null,
            return_date: document.getElementById('return_date').value || null,
            status: document.getElementById('status').value,
            description: document.getElementById('description').value
        };
        
        console.log('Create data:', batchData);
        
        if (!batchData.batch_name) {
            showNotification('Batch name is required', 'error');
            return;
        }
        
        const createBtn = e.target.querySelector('button[type="submit"]');
        const originalText = createBtn.innerHTML;
        createBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
        createBtn.disabled = true;
        
        try {
            const response = await fetch('/api/batches/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(batchData)
            });
            
            console.log('Create API response status:', response.status);
            
            if (response.status === 401) {
                showNotification('Session expired. Please login again', 'error');
                setTimeout(() => {
                    window.location.href = '/admin.login.html';
                }, 2000);
                return;
            }
            
            const data = await response.json();
            console.log('Create API response:', data);
            
            if (data.success) {
                showNotification(`Batch created successfully with price ‚Çπ${price || 'N/A'}`, 'success');
                hideCreateBatchForm();
                loadBatches();
            } else {
                showNotification('Error: ' + (data.error || 'Could not create batch'), 'error');
            }
        } catch (error) {
            console.error('‚ùå Error creating batch:', error);
            showNotification('Error creating batch', 'error');
        } finally {
            createBtn.innerHTML = originalText;
            createBtn.disabled = false;
        }
    });

    // ============ SEARCH BATCHES ============
    function searchBatches() {
        const search = document.getElementById('searchBatches').value.toLowerCase();
        console.log('üîç Searching for:', search);
        
        const rows = document.querySelectorAll('#batchesTable tr');
        let visibleCount = 0;
        
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            const isVisible = text.includes(search);
            row.style.display = isVisible ? '' : 'none';
            if (isVisible) visibleCount++;
        });
        
        console.log(`Search found ${visibleCount} results`);
    }
</script>
