<div class="action-buttons">
    <button class="action-btn btn-warning" onclick="showAddPaymentForm()">
        <i class="fas fa-plus"></i> Record New Payment
    </button>
</div>

<!-- Payment Stats -->
<div class="stats-grid">
    <div class="stat-card">
        <i class="fas fa-rupee-sign"></i>
        <h3>Total Collected</h3>
        <div class="stat-number" id="paymentTotalCollected">₹0</div>
    </div>
    <div class="stat-card">
        <i class="fas fa-clock"></i>
        <h3>Pending Amount</h3>
        <div class="stat-number" id="paymentPendingAmount">₹0</div>
    </div>
    <div class="stat-card">
        <i class="fas fa-check-circle"></i>
        <h3>Paid Payments</h3>
        <div class="stat-number" id="paidCount">0</div>
    </div>
    <div class="stat-card">
        <i class="fas fa-hourglass-half"></i>
        <h3>Pending Payments</h3>
        <div class="stat-number" id="pendingCount">0</div>
    </div>
</div>

<!-- Add Payment Form -->
<div class="form-container" id="addPaymentForm" style="display: none;">
    <h3><i class="fas fa-credit-card"></i> Record New Payment</h3>
    
    <div id="paymentVerification">
        <div class="form-grid">
            <div class="form-group">
                <label for="payment_search">Traveler ID or Passport Number</label>
                <input type="text" id="payment_search" placeholder="Enter ID or Passport Number">
                <small style="color: #7f8c8d;">Enter traveler ID or passport number to verify</small>
            </div>
        </div>
        <button class="action-btn btn-primary" onclick="verifyTraveler()">
            <i class="fas fa-search"></i> Verify Traveler
        </button>
    </div>

    <form id="paymentForm" style="display: none;">
        <input type="hidden" id="payment_traveler_id">
        <input type="hidden" id="payment_traveler_name">
        
        <div class="verification-panel">
            <h4 style="color: #3498db; margin-bottom: 15px;"><i class="fas fa-user-check"></i> Traveler Verified</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div>
                    <p style="color: #7f8c8d; margin-bottom: 5px;">Traveler Name</p>
                    <p style="font-weight: 600; color: #1e3c72;" id="display_traveler_name">-</p>
                </div>
                <div>
                    <p style="color: #7f8c8d; margin-bottom: 5px;">Batch/Package</p>
                    <p style="font-weight: 600; color: #1e3c72;" id="display_batch_name">-</p>
                </div>
                <div>
                    <p style="color: #7f8c8d; margin-bottom: 5px;">Package Price</p>
                    <p style="font-weight: 600; color: #1e3c72;">₹<span id="display_batch_price">0</span></p>
                </div>
                <div>
                    <p style="color: #7f8c8d; margin-bottom: 5px;">Total Paid</p>
                    <p style="font-weight: 600; color: #27ae60;" id="display_total_paid">₹0</p>
                </div>
                <div>
                    <p style="color: #7f8c8d; margin-bottom: 5px;">Balance Due</p>
                    <p style="font-weight: 600; color: #e74c3c;" id="display_balance">₹0</p>
                </div>
            </div>
        </div>

        <div class="form-grid">
            <div class="form-group">
                <label for="installment"><i class="fas fa-tag"></i> Installment Type *</label>
                <select id="installment" required>
                    <option value="">Select Installment</option>
                    <option value="Booking Amount">Booking Amount</option>
                    <option value="1st Installment">1st Installment</option>
                    <option value="2nd Installment">2nd Installment</option>
                    <option value="3rd Installment">3rd Installment</option>
                    <option value="Final Payment">Final Payment</option>
                    <option value="Full Payment">Full Payment</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="amount"><i class="fas fa-rupee-sign"></i> Amount (₹) *</label>
                <input type="number" id="amount" step="1" min="1" placeholder="Enter amount" required>
            </div>
            
            <div class="form-group">
                <label for="payment_date"><i class="fas fa-calendar"></i> Payment Date *</label>
                <input type="date" id="payment_date" required>
            </div>
            
            <div class="form-group">
                <label for="payment_method"><i class="fas fa-credit-card"></i> Payment Method *</label>
                <select id="payment_method" required>
                    <option value="">Select Method</option>
                    <option value="Cash">Cash</option>
                    <option value="Bank Transfer">Bank Transfer</option>
                    <option value="Credit Card">Credit Card</option>
                    <option value="Debit Card">Debit Card</option>
                    <option value="UPI">UPI</option>
                    <option value="Cheque">Cheque</option>
                    <option value="Demand Draft">Demand Draft</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="transaction_id"><i class="fas fa-hashtag"></i> Transaction ID / Reference</label>
                <input type="text" id="transaction_id" placeholder="UPI ID / Cheque No / Reference">
            </div>
            
            <div class="form-group">
                <label for="due_date"><i class="fas fa-clock"></i> Due Date (if applicable)</label>
                <input type="date" id="due_date">
            </div>
            
            <div class="form-group full-width">
                <label for="remarks"><i class="fas fa-comment"></i> Remarks / Notes</label>
                <textarea id="remarks" rows="2" placeholder="Any additional notes..."></textarea>
            </div>
        </div>

        <!-- Payment Summary -->
        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
            <h4 style="color: #1e3c72; margin-bottom: 15px;">Payment Summary</h4>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: center;">
                <div>
                    <p style="color: #7f8c8d; margin-bottom: 5px;">Package Price</p>
                    <p style="font-size: 1.2rem; font-weight: 600; color: #1e3c72;">₹<span id="summary_price">0</span></p>
                </div>
                <div>
                    <p style="color: #7f8c8d; margin-bottom: 5px;">Total Paid</p>
                    <p style="font-size: 1.2rem; font-weight: 600; color: #27ae60;">₹<span id="summary_paid">0</span></p>
                </div>
                <div>
                    <p style="color: #7f8c8d; margin-bottom: 5px;">New Payment</p>
                    <p style="font-size: 1.2rem; font-weight: 600; color: #3498db;">₹<span id="summary_new">0</span></p>
                </div>
                <div>
                    <p style="color: #7f8c8d; margin-bottom: 5px;">Balance After</p>
                    <p style="font-size: 1.2rem; font-weight: 600; color: #e74c3c;" id="summary_balance">₹0</p>
                </div>
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="action-btn btn-warning"><i class="fas fa-save"></i> Record Payment</button>
            <button type="button" class="action-btn btn-secondary" onclick="hideAddPaymentForm()"><i class="fas fa-times"></i> Cancel</button>
        </div>
    </form>
</div>

<!-- Filter Section -->
<div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
    <div style="flex: 1;">
        <input type="text" id="searchPayments" placeholder="Search by traveler name or ID..." style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
    </div>
    <select id="paymentStatusFilter" style="padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; min-width: 150px;">
        <option value="all">All Status</option>
        <option value="Paid">Paid</option>
        <option value="Pending">Pending</option>
        <option value="Overdue">Overdue</option>
        <option value="Reversed">Reversed</option>
    </select>
    <select id="paymentMethodFilter" style="padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; min-width: 150px;">
        <option value="all">All Methods</option>
        <option value="Cash">Cash</option>
        <option value="Bank Transfer">Bank Transfer</option>
        <option value="UPI">UPI</option>
        <option value="Credit Card">Credit Card</option>
        <option value="Cheque">Cheque</option>
    </select>
    <button class="action-btn btn-primary" onclick="filterPayments()">
        <i class="fas fa-filter"></i> Apply Filters
    </button>
    <button class="action-btn btn-secondary" onclick="resetFilters()">
        <i class="fas fa-undo"></i> Reset
    </button>
</div>

<!-- Payments Table -->
<div class="table-container">
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Traveler</th>
                <th>Installment</th>
                <th>Amount</th>
                <th>Due Date</th>
                <th>Payment Date</th>
                <th>Method</th>
                <th>Transaction ID</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="paymentsTable">
            <tr><td colspan="10" class="loading"><i class="fas fa-spinner fa-spin"></i> Loading payments...</td></tr>
        </tbody>
    </table>
</div>

<!-- Payment Details Modal -->
<div id="paymentModal" class="modal modal-large" style="display: none;">
    <div class="modal-header">
        <h3><i class="fas fa-file-invoice"></i> Payment Details</h3>
        <button class="modal-close" onclick="closePaymentModal()">&times;</button>
    </div>
    <div id="paymentDetails" style="margin-bottom: 20px;"></div>
    <div class="modal-footer">
        <button onclick="printPaymentReceipt()" class="action-btn btn-primary"><i class="fas fa-print"></i> Print Receipt</button>
        <button onclick="reversePayment()" class="action-btn btn-danger"><i class="fas fa-undo-alt"></i> Reverse Payment</button>
        <button onclick="closePaymentModal()" class="action-btn btn-secondary"><i class="fas fa-times"></i> Close</button>
    </div>
</div>

<!-- Payment Reversal Modal -->
<div id="reverseModal" class="modal" style="display: none;">
    <div class="modal-header">
        <h3><i class="fas fa-undo-alt"></i> Reverse Payment</h3>
        <button class="modal-close" onclick="closeReverseModal()">&times;</button>
    </div>
    <form id="reverseForm">
        <input type="hidden" id="reverse_payment_id">
        <div class="form-group">
            <label for="reverse_amount">Amount to Reverse</label>
            <input type="number" id="reverse_amount" step="1" min="1" required>
        </div>
        <div class="form-group">
            <label for="reverse_reason">Reason for Reversal *</label>
            <select id="reverse_reason" required>
                <option value="">Select Reason</option>
                <option value="Wrong Amount">Wrong Amount</option>
                <option value="Duplicate Payment">Duplicate Payment</option>
                <option value="Cancelled Booking">Cancelled Booking</option>
                <option value="Refund">Refund</option>
                <option value="Other">Other</option>
            </select>
        </div>
        <div class="form-group">
            <label for="reverse_remarks">Additional Remarks</label>
            <textarea id="reverse_remarks" rows="3" placeholder="Enter any additional details..."></textarea>
        </div>
        <div class="modal-footer">
            <button type="submit" class="action-btn btn-danger"><i class="fas fa-undo-alt"></i> Confirm Reversal</button>
            <button type="button" class="action-btn btn-secondary" onclick="closeReverseModal()">Cancel</button>
        </div>
    </form>
</div>

<!-- Overlay -->
<div id="modalOverlay" class="modal-overlay" onclick="closeAllModals()"></div>

<style>
.modal {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 30px;
    border-radius: 15px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    z-index: 2000;
    max-width: 800px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
}

.modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1999;
}

.verification-panel {
    background: #e8f4f8;
    border-left: 4px solid #3498db;
    padding: 20px;
    margin: 20px 0;
    border-radius: 8px;
}

.payment-paid {
    color: #27ae60;
    font-weight: 600;
}

.payment-pending {
    color: #f39c12;
    font-weight: 600;
}

.payment-overdue {
    color: #e74c3c;
    font-weight: 600;
}
</style>

<script>
    let currentTravelerData = null;
    let currentPaymentId = null;

    // Initialize
    loadPayments();
    loadPaymentStats();

    function showAddPaymentForm() {
        document.getElementById('addPaymentForm').style.display = 'block';
        document.getElementById('paymentVerification').style.display = 'block';
        document.getElementById('paymentForm').style.display = 'none';
        document.getElementById('payment_search').value = '';
        resetPaymentForm();
    }

    function hideAddPaymentForm() {
        document.getElementById('addPaymentForm').style.display = 'none';
        resetPaymentForm();
    }

    function resetPaymentForm() {
        document.getElementById('paymentForm').reset();
        document.getElementById('payment_traveler_id').value = '';
        document.getElementById('payment_traveler_name').value = '';
        document.getElementById('display_traveler_name').textContent = '-';
        document.getElementById('display_batch_name').textContent = '-';
        document.getElementById('display_batch_price').textContent = '0';
        document.getElementById('display_total_paid').textContent = '₹0';
        document.getElementById('display_balance').textContent = '₹0';
        document.getElementById('summary_price').textContent = '0';
        document.getElementById('summary_paid').textContent = '0';
        document.getElementById('summary_new').textContent = '0';
        document.getElementById('summary_balance').textContent = '₹0';
        currentTravelerData = null;
    }

    async function verifyTraveler() {
        const search = document.getElementById('payment_search').value.trim();
        if (!search) {
            showNotification('Please enter Traveler ID or Passport Number', 'error');
            return;
        }
        
        try {
            let response;
            if (!isNaN(search)) {
                response = await fetch(`/api/travelers/${search}`, {
                    credentials: 'include'
                });
            } else {
                response = await fetch(`/api/travelers/passport/${search}`, {
                    credentials: 'include'
                });
            }
            
            if (response.status === 401) {
                showNotification('Session expired. Please login again', 'error');
                setTimeout(() => {
                    window.location.href = '/admin.login.html';
                }, 2000);
                return;
            }
            
            const data = await response.json();
            
            if (data.success) {
                const traveler = data.traveler;
                currentTravelerData = traveler;
                
                // Get batch details
                const batchResponse = await fetch(`/api/batches/${traveler.batch_id}`, {
                    credentials: 'include'
                });
                const batchData = await batchResponse.json();
                const batch = batchData.success ? batchData.batch : null;
                
                // Get payment history
                const paymentsResponse = await fetch(`/api/payments/traveler/${traveler.id}`, {
                    credentials: 'include'
                });
                const paymentsData = await paymentsResponse.json();
                const payments = paymentsData.success ? paymentsData.payments : [];
                
                // Calculate totals
                const totalPaid = payments
                    .filter(p => p.status === 'Paid')
                    .reduce((sum, p) => sum + p.amount, 0);
                
                const packagePrice = batch ? parseFloat(batch.price) : 0;
                const balance = packagePrice - totalPaid;
                
                // Display traveler info
                document.getElementById('payment_traveler_id').value = traveler.id;
                document.getElementById('payment_traveler_name').value = `${traveler.first_name} ${traveler.last_name}`;
                document.getElementById('display_traveler_name').textContent = `${traveler.first_name} ${traveler.last_name}`;
                document.getElementById('display_batch_name').textContent = batch ? batch.batch_name : 'Not Assigned';
                document.getElementById('display_batch_price').textContent = packagePrice.toLocaleString();
                document.getElementById('display_total_paid').innerHTML = `₹${totalPaid.toLocaleString()}`;
                document.getElementById('display_balance').innerHTML = `₹${balance.toLocaleString()}`;
                
                // Update summary
                document.getElementById('summary_price').textContent = packagePrice.toLocaleString();
                document.getElementById('summary_paid').textContent = totalPaid.toLocaleString();
                updateSummary();
                
                document.getElementById('paymentVerification').style.display = 'none';
                document.getElementById('paymentForm').style.display = 'block';
            } else {
                showNotification('Traveler not found', 'error');
            }
        } catch (error) {
            console.error('Error verifying traveler:', error);
            showNotification('Error verifying traveler', 'error');
        }
    }

    document.getElementById('amount').addEventListener('input', updateSummary);
    
    function updateSummary() {
        const amount = parseFloat(document.getElementById('amount').value) || 0;
        const totalPaid = parseFloat(document.getElementById('summary_paid').textContent.replace(/,/g, '')) || 0;
        const packagePrice = parseFloat(document.getElementById('summary_price').textContent.replace(/,/g, '')) || 0;
        
        document.getElementById('summary_new').textContent = amount.toLocaleString();
        
        const newBalance = packagePrice - (totalPaid + amount);
        document.getElementById('summary_balance').innerHTML = `₹${newBalance.toLocaleString()}`;
        document.getElementById('summary_balance').style.color = newBalance < 0 ? '#e74c3c' : (newBalance === 0 ? '#27ae60' : '#f39c12');
    }

    document.getElementById('paymentForm')?.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const amount = parseFloat(document.getElementById('amount').value);
        
        if (amount <= 0) {
            showNotification('Please enter a valid amount greater than 0', 'error');
            return;
        }
        
        if (!currentTravelerData) {
            showNotification('Please verify traveler first', 'error');
            return;
        }
        
        const paymentData = {
            traveler_id: document.getElementById('payment_traveler_id').value,
            installment: document.getElementById('installment').value,
            amount: amount,
            payment_date: document.getElementById('payment_date').value,
            payment_method: document.getElementById('payment_method').value,
            transaction_id: document.getElementById('transaction_id').value || null,
            due_date: document.getElementById('due_date').value || null,
            remarks: document.getElementById('remarks').value || null,
            status: 'Paid'
        };
        
        if (!paymentData.traveler_id || !paymentData.amount || !paymentData.payment_date || !paymentData.payment_method) {
            showNotification('Please fill all required fields', 'error');
            return;
        }
        
        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        submitBtn.disabled = true;
        
        try {
            const response = await fetch('/api/payments/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(paymentData)
            });
            
            if (response.status === 401) {
                showNotification('Session expired. Please login again', 'error');
                setTimeout(() => {
                    window.location.href = '/admin.login.html';
                }, 2000);
                return;
            }
            
            const data = await response.json();
            
            if (data.success) {
                showNotification(`Payment of ₹${amount} recorded successfully!`, 'success');
                hideAddPaymentForm();
                loadPayments();
                loadPaymentStats();
            } else {
                showNotification('Error: ' + (data.error || 'Could not record payment'), 'error');
            }
        } catch (error) {
            console.error('Error recording payment:', error);
            showNotification('Error recording payment', 'error');
        } finally {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    });

    async function loadPayments() {
        try {
            const response = await fetch('/api/payments/', {
                credentials: 'include'
            });
            if (response.ok) {
                const data = await response.json();
                if (data.success && data.payments && data.payments.length > 0) {
                    displayPayments(data.payments);
                } else {
                    document.getElementById('paymentsTable').innerHTML = '<tr><td colspan="10" style="text-align: center;">No payments found</td></tr>';
                }
            } else {
                useDemoPayments();
            }
        } catch (error) {
            console.error('Error loading payments:', error);
            useDemoPayments();
        }
    }

    function displayPayments(payments) {
        let html = '';
        payments.forEach(p => {
            const today = new Date();
            const dueDate = p.due_date ? new Date(p.due_date) : null;
            let statusClass = 'status-active';
            let statusText = p.status;
            
            if (p.status === 'Pending' && dueDate && dueDate < today) {
                statusClass = 'status-inactive';
                statusText = 'Overdue';
            } else if (p.status === 'Pending') {
                statusClass = 'status-pending';
            } else if (p.status === 'Reversed') {
                statusClass = 'status-inactive';
            }
            
            html += `<tr>
                <td>${p.id}</td>
                <td><strong>${p.traveler_name}</strong></td>
                <td>${p.installment || '-'}</td>
                <td>₹${p.amount.toLocaleString()}</td>
                <td>${p.due_date || '-'}</td>
                <td>${p.payment_date || '-'}</td>
                <td>${p.payment_method || '-'}</td>
                <td>${p.transaction_id || '-'}</td>
                <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                <td>
                    <button class="icon-btn" onclick="viewPaymentDetails(${p.id})" title="View"><i class="fas fa-eye"></i></button>
                    ${p.status === 'Paid' ? `<button class="icon-btn" onclick="showReverseModal(${p.id}, ${p.amount})" title="Reverse"><i class="fas fa-undo-alt"></i></button>` : ''}
                </td>
            </tr>`;
        });
        document.getElementById('paymentsTable').innerHTML = html;
    }

    function useDemoPayments() {
        const demoPayments = [
            { id: 1, traveler_name: 'Ahmed Khan', installment: 'Booking Amount', amount: 85000, payment_date: '2026-01-15', payment_method: 'Bank Transfer', status: 'Paid', transaction_id: 'TXN123456' },
            { id: 2, traveler_name: 'Fatima Begum', installment: '1st Installment', amount: 110000, payment_date: '2026-01-20', payment_method: 'UPI', status: 'Paid', transaction_id: 'UPI789012' },
            { id: 3, traveler_name: 'Mohammed Rafi', installment: '2nd Installment', amount: 125000, due_date: '2026-03-15', status: 'Pending' },
            { id: 4, traveler_name: 'Aisha Begum', installment: 'Final Payment', amount: 150000, due_date: '2026-02-01', status: 'Overdue' }
        ];
        displayPayments(demoPayments);
    }

    async function loadPaymentStats() {
        try {
            const response = await fetch('/api/payments/stats', {
                credentials: 'include'
            });
            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    document.getElementById('paymentTotalCollected').innerHTML = `₹${(data.stats.total_collected || 0).toLocaleString()}`;
                    document.getElementById('paymentPendingAmount').innerHTML = `₹${(data.stats.pending_amount || 0).toLocaleString()}`;
                    document.getElementById('paidCount').innerHTML = data.stats.status_counts?.Paid || '0';
                    document.getElementById('pendingCount').innerHTML = data.stats.status_counts?.Pending || '0';
                    return;
                }
            }
            // Demo stats
            document.getElementById('paymentTotalCollected').innerHTML = '₹36,00,000';
            document.getElementById('paymentPendingAmount').innerHTML = '₹9,75,000';
            document.getElementById('paidCount').innerHTML = '22';
            document.getElementById('pendingCount').innerHTML = '9';
        } catch (error) {
            console.error('Error loading stats:', error);
            document.getElementById('paymentTotalCollected').innerHTML = '₹36,00,000';
            document.getElementById('paymentPendingAmount').innerHTML = '₹9,75,000';
            document.getElementById('paidCount').innerHTML = '22';
            document.getElementById('pendingCount').innerHTML = '9';
        }
    }

    async function viewPaymentDetails(id) {
        try {
            const response = await fetch(`/api/payments/${id}`, {
                credentials: 'include'
            });
            const data = await response.json();
            
            if (data.success) {
                const p = data.payment;
                const html = `
                    <div style="padding: 20px;">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px;">
                            <div>
                                <p style="color: #7f8c8d; margin-bottom: 5px;">Payment ID</p>
                                <p style="font-weight: 600;">${p.id}</p>
                            </div>
                            <div>
                                <p style="color: #7f8c8d; margin-bottom: 5px;">Traveler</p>
                                <p style="font-weight: 600;">${p.traveler_name}</p>
                            </div>
                            <div>
                                <p style="color: #7f8c8d; margin-bottom: 5px;">Installment</p>
                                <p style="font-weight: 600;">${p.installment || '-'}</p>
                            </div>
                            <div>
                                <p style="color: #7f8c8d; margin-bottom: 5px;">Amount</p>
                                <p style="font-weight: 600; color: #27ae60;">₹${p.amount.toLocaleString()}</p>
                            </div>
                            <div>
                                <p style="color: #7f8c8d; margin-bottom: 5px;">Payment Date</p>
                                <p style="font-weight: 600;">${p.payment_date || '-'}</p>
                            </div>
                            <div>
                                <p style="color: #7f8c8d; margin-bottom: 5px;">Due Date</p>
                                <p style="font-weight: 600;">${p.due_date || '-'}</p>
                            </div>
                            <div>
                                <p style="color: #7f8c8d; margin-bottom: 5px;">Payment Method</p>
                                <p style="font-weight: 600;">${p.payment_method || '-'}</p>
                            </div>
                            <div>
                                <p style="color: #7f8c8d; margin-bottom: 5px;">Transaction ID</p>
                                <p style="font-weight: 600;">${p.transaction_id || '-'}</p>
                            </div>
                            <div>
                                <p style="color: #7f8c8d; margin-bottom: 5px;">Status</p>
                                <p><span class="status-badge ${p.status === 'Paid' ? 'status-active' : 'status-pending'}">${p.status}</span></p>
                            </div>
                        </div>
                        ${p.remarks ? `
                        <div style="margin-top: 20px;">
                            <p style="color: #7f8c8d; margin-bottom: 5px;">Remarks</p>
                            <p style="background: #f8f9fa; padding: 15px; border-radius: 8px;">${p.remarks}</p>
                        </div>
                        ` : ''}
                    </div>
                `;
                document.getElementById('paymentDetails').innerHTML = html;
                document.getElementById('paymentModal').style.display = 'block';
                document.getElementById('modalOverlay').style.display = 'block';
            }
        } catch (error) {
            console.error('Error loading payment details:', error);
            showNotification('Error loading payment details', 'error');
        }
    }

    function showReverseModal(paymentId, amount) {
        currentPaymentId = paymentId;
        document.getElementById('reverse_payment_id').value = paymentId;
        document.getElementById('reverse_amount').value = amount;
        document.getElementById('reverse_amount').max = amount;
        document.getElementById('reverseModal').style.display = 'block';
        document.getElementById('modalOverlay').style.display = 'block';
    }

    function closeReverseModal() {
        document.getElementById('reverseModal').style.display = 'none';
        document.getElementById('modalOverlay').style.display = 'none';
        document.getElementById('reverseForm').reset();
        currentPaymentId = null;
    }

    document.getElementById('reverseForm')?.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        if (!currentPaymentId) {
            showNotification('No payment selected', 'error');
            return;
        }
        
        const reversalData = {
            payment_id: currentPaymentId,
            amount: parseFloat(document.getElementById('reverse_amount').value),
            reason: document.getElementById('reverse_reason').value,
            remarks: document.getElementById('reverse_remarks').value
        };
        
        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        submitBtn.disabled = true;
        
        try {
            const response = await fetch(`/api/payments/${currentPaymentId}/reverse`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(reversalData)
            });
            
            if (response.status === 401) {
                showNotification('Session expired. Please login again', 'error');
                setTimeout(() => {
                    window.location.href = '/admin.login.html';
                }, 2000);
                return;
            }
            
            const data = await response.json();
            
            if (data.success) {
                showNotification('Payment reversed successfully', 'success');
                closeReverseModal();
                loadPayments();
                loadPaymentStats();
            } else {
                showNotification('Error: ' + (data.error || 'Could not reverse payment'), 'error');
            }
        } catch (error) {
            console.error('Error reversing payment:', error);
            showNotification('Error reversing payment', 'error');
        } finally {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    });

    function filterPayments() {
        const search = document.getElementById('searchPayments').value.toLowerCase();
        const statusFilter = document.getElementById('paymentStatusFilter').value;
        const methodFilter = document.getElementById('paymentMethodFilter').value;
        
        const rows = document.querySelectorAll('#paymentsTable tr');
        rows.forEach(row => {
            if (row.cells.length < 2) return;
            
            const text = row.textContent.toLowerCase();
            const status = row.cells[8]?.textContent || '';
            const method = row.cells[6]?.textContent || '';
            
            let show = text.includes(search);
            if (statusFilter !== 'all') show = show && status.includes(statusFilter);
            if (methodFilter !== 'all') show = show && method.includes(methodFilter);
            
            row.style.display = show ? '' : 'none';
        });
    }

    function resetFilters() {
        document.getElementById('searchPayments').value = '';
        document.getElementById('paymentStatusFilter').value = 'all';
        document.getElementById('paymentMethodFilter').value = 'all';
        filterPayments();
    }

    function printPaymentReceipt() {
        const content = document.getElementById('paymentDetails')?.innerHTML;
        if (!content) return;
        
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <html>
            <head>
                <title>Payment Receipt</title>
                <style>
                    body { font-family: Arial; padding: 30px; }
                    .receipt-header { text-align: center; margin-bottom: 30px; }
                    .receipt-header h1 { color: #1e3c72; }
                    .receipt-header h2 { color: #2a5298; }
                    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                    td { padding: 10px; border: 1px solid #ddd; }
                    .total { font-weight: bold; color: #27ae60; }
                </style>
            </head>
            <body>
                <div class="receipt-header">
                    <h1>Alhudha Haj Travel</h1>
                    <h2>Payment Receipt</h2>
                    <p>Date: ${new Date().toLocaleDateString()}</p>
                </div>
                ${content}
                <p style="text-align: center; margin-top: 40px; color: #7f8c8d;">This is a system generated receipt</p>
            </body>
            </html>
        `);
        printWindow.document.close();
        printWindow.print();
    }

    function closePaymentModal() {
        document.getElementById('paymentModal').style.display = 'none';
        document.getElementById('modalOverlay').style.display = 'none';
    }

    function closeAllModals() {
        document.getElementById('paymentModal').style.display = 'none';
        document.getElementById('reverseModal').style.display = 'none';
        document.getElementById('modalOverlay').style.display = 'none';
    }
</script>
